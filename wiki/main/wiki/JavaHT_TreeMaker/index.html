<!doctype html>
<html class="no-js" lang="en" dir="ltr">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>TreeMaker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Apache NetBeans wiki JavaHT TreeMaker">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans wiki JavaHT TreeMaker">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="../../../../_/css/font-awesome.min.css">
    <link rel="alternate" type="application/atom+xml" title="Apache NetBeans Blog" href="https://netbeans.apache.org/blogs/atom" />
    <link rel="stylesheet" href="../../../../_/css/highlight-11.9.0.default.min.css">
    <link rel="stylesheet" href="../../../../_/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../_/images/fav/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../_/images/fav/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../_/images/fav/favicon-16x16.png">
    <link rel="manifest" href="../../../../_/images/fav/site.webmanifest">
    <link rel="mask-icon" href="../../../../_/images/fav/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="../../../../_/css/font-open-sans.css" rel="stylesheet">
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
  </head>
  <body>
    <div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="../../../../index.html"><img src='../../../../_/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <input id="search-input" type="text" placeholder="Search the docs"> </li>
            <li> <a href="../../../../front/main/community">Community</a> </li>
            <li> <a href="../../../../front/main/participate">Participate</a> </li>
            <li> <a href="../../../../front/main/blogs">Blog</a></li>
            <li> <a href="../../../../front/main/help">Get Help</a> </li>
            <li> <a href="https://plugins.netbeans.apache.org/">Plugins</a> </li>
            <li> <a href="../../../../front/main/download">Download</a> </li>
        </ul>
    </div>
</div>

    <!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Latest release</div>
            <h1>Apache NetBeans 21</h1>
            <p><a class="button success" href="../../../../front/main/download/nb21">Download</a></p>
        </div>
    </div>
</section>
    <div class='grid-container main-content'>
      <article class="doc">
      <h1 style="visibily: hidden">TreeMaker</h1>
      <div class='aside' style='text-align: center; padding: 20px;'>
    <a href="../../../../wiki/main/wiki" title="Apache NetBeans WIKI">Apache NetBeans Wiki Index</a>
    <p><b>Note:</b> These pages are being reviewed.</p>
</div>
      <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_implementing_run_method">Implementing run() method</a></li>
<li><a href="#_adding_method_with_body">Adding method with body</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_implementing_run_method"><a class="anchor" href="#_implementing_run_method"></a>Implementing run() method</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The run() method is place where we you API for modifications. We decided to add java.io.Externalizable interface the class declaration.</p>
</div>
<div class="paragraph">
<p>Original source looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    package org.netbeans.test.codegen;

    public class Tutorial1 {
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the end, we want to see source like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    package org.netbeans.test.codegen;

    import java.io.Externalizable;

    public class Tutorial1 implements Externalizable {
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In short, this can be done with this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {

        workingCopy.toPhase(Phase.RESOLVED); // is it neccessary?

        CompilationUnitTree cut = workingCopy.getCompilationUnit();
        TreeMaker make = workingCopy.getTreeMaker();

        for (Tree typeDecl : cut.getTypeDecls()) {
            if (Tree.Kind.CLASS == typeDecl.getKind()) {
                ClassTree clazz = (ClassTree) typeDecl;
                ExpressionTree implementsClause = make.Identifier("Externalizable");

                implementsClause = make.Identifier("java.io.Externalizable");

                TypeElement element = workingCopy.getElements().getTypeElement("java.io.Externalizable");
                implementsClause = make.QualIdent(element);

                ClassTree modifiedClazz = make.addClassImplementsClause(clazz, implementsClause);
                workingCopy.rewrite(clazz, modifiedClazz);
            } // end if
        } // end for
    } // end run</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is steps description:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>workingCopy.toPhase(Phase.RESOLVED);&#8201;&#8212;&#8201;Resolves symbols for provided java source.</p>
</li>
<li>
<p>CompilationUnitTree cut = workingCopy.getCompilationUnit();&#8201;&#8212;&#8201;Instance represents one java source file, exactly as defined in JLS, ยง7.3 Compilation Units.</p>
</li>
<li>
<p>TreeMaker make = workingCopy.getTreeMaker();&#8201;&#8212;&#8201;Get the tree maker, the core class used for making modifications. It allows to add new members to class, modify statements, etc.</p>
</li>
<li>
<p>for (Tree typeDecl : cut.getTypeDecls()) { &#8230;&#8203; }&#8201;&#8212;&#8201;Go through all top level declarations (JLS ยง7.6).</p>
</li>
<li>
<p>if (Tree.Kind.CLASS == typeDecl.getKind()) { &#8230;&#8203;}&#8201;&#8212;&#8201;Ensure about type - not neccessary here, when we omit that Annotation Type can be also declared here. This is important and you will see it perhaps on other places too&#8201;&#8212;&#8201;always, you have to use Kind for checking instance! instanceof operator shouldn&#8217;t be used for such a test.</p>
</li>
<li>
<p>ClassTree clazz = (ClassTree) typeDecl;</p>
</li>
<li>
<p>Create identifier:</p>
<div class="ulist">
<ul>
<li>
<p>ExpressionTree implementsClause = make.Identifier("Externalizable");&#8201;&#8212;&#8201;Simpliest, but not sufficient solution: Add the plain identifier. It generates source as you can see below, but when import is not available, identifier is not resolved and class will not compile.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public class Tutorial1 implements Externalizable {
    }</code></pre>
</div>
</div>
</li>
<li>
<p>ExpressionTree implementsClause = make.Identifier("java.io.Externalizable");&#8201;&#8212;&#8201;We can solve described problem with specifying fully-qualified name. We can create again identifier tree. (Bear in mind, that you will never get such an identifier - meant dot separated - from the compiler staff. Note: Should we consider it as incorrect usage?) The result will be compilable, see code below. The disadvantage is fully-qualified name in declaration.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public class Tutorial1 implements java.io.Externalizable {
    }</code></pre>
</div>
</div>
</li>
<li>
<p>Last, and perhaps the most often used solution is to add plain identifier to type declaration and correct import statement to compilation unit. It can be done by following statements: TypeElement element = workingCopy.getElements().getTypeElement("java.io.Externalizable");&#8201;&#8212;&#8201;You will get resolved element. You should check, that element is available. Then, make QualIdent tree: implementsClause = make.QualIdent(element);&#8201;&#8212;&#8201;The QualIdent will be recognized during source code modification and engine will decide (in accordance with options), how to correctly generate. When using default settings, import for your class will be added and simple name will be used in implements clause:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    import java.io.Externalizable;

    public class Tutorial1 implements Externalizable {
    }</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>ClassTree modifiedClazz = make.addClassImplementsClause(clazz, implementsClause);&#8201;&#8212;&#8201;Use tree maker method to add the interface identifier to the 'implements' clause. Bear in mind that this operation just put it to the tree, not to the source file. Because nodes in tree are immutable, method returns the same class type as provided in first parameter, in our case ClassTree. In other words, if a method takes ClassTree parameter, it will return another class tree, which contains provided modification.</p>
</li>
<li>
<p>workingCopy.rewrite(clazz, modifiedClazz);&#8201;&#8212;&#8201;Replace the original node with the new one. It adds the change to the list of changes, later used for making source modification.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_method_with_body"><a class="anchor" href="#_adding_method_with_body"></a>Adding method with body</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Next example show more complex task. Adding method to type declaration. The steps described above are the same, we just implement run() method of CancellableTask. Here is the code we want to add to class declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void writeExternal(final ObjectOutput arg0) throws IOException {
        throw new UnsupportedOperationException("Not supported yet.");
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have to prepare all elements belonging to method. First of all, prepare modifiers for the method. We use TreeMaker instance make again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {
        ...
        // create method modifier: public and no annotation
        ModifiersTree methodModifiers = make.Modifiers(
            Collections.&lt;Modifier&gt;singleton(Modifier.PUBLIC),
            Collections.&lt;AnnotationTree&gt;emptyList()
        );
        ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next step is preparing method parameter arg0 of type ObjectOutput and modifier final:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {
        ...
        // create parameter:
        // final ObjectOutput arg0
        VariableTree parameter = make.Variable(
            make.Modifiers(
                Collections.&lt;Modifier&gt;singleton(Modifier.FINAL),
                Collections.&lt;AnnotationTree&gt;emptyList()
            ),
            "arg0", // name
            make.Identifier("Object"), // parameter type
            null // initializer - does not make sense in parameters.
        );
        ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Method throws exception, prepare exception identifier IOException. It is the same when we prepared interface for implements clause.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {
        ...
        // prepare simple name to throws clause:
        // 'throws IOException' and its import will be added (if it is not available yet)
        TypeElement element = workingCopy.getElements().getTypeElement("java.io.IOException");
        ExpressionTree throwsClause = make.QualIdent(element);
        ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have everything, what we need for method creation. Make method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {
        ...
        // create method.
        MethodTree newMethod = make.Method(
            methodModifiers, // public
            "writeExternal", // writeExternal
            make.PrimitiveType(TypeKind.VOID), // return type "void"
            Collections.&lt;TypeParameterTree&gt;emptyList(), // type parameters - none
            Collections.&lt;VariableTree&gt;singletonList(parameter), // final ObjectOutput arg0
            Collections.&lt;ExpressionTree&gt;singletonList(throwsClause), // throws
            "{ throw new UnsupportedOperationException(\"Not supported yet.\") }", // body text
            null // default value - not applicable here, used by annotations
        );
        ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above, we used the most often used factory method for source code method creation. It contains string for its body. You can add it as plain syntax correct text and engine will do imports and formatting stuff for you. There is also second method, which allows to add the body as a block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    public void run(WorkingCopy workingCopy) throws IOException {
        ...
        // create method.
        MethodTree newMethod = make.Method(
            methodModifiers, // public
            "writeExternal", // writeExternal
            make.PrimitiveType(TypeKind.VOID), // return type "void"
            Collections.&lt;TypeParameterTree&gt;emptyList(), // type parameters - none
            Collections.&lt;VariableTree&gt;singletonList(parameter), // final ObjectOutput arg0
            Collections.&lt;ExpressionTree&gt;singletonList(throwsClause), // throws
            make.Block(Collections.&lt;StatementTree&gt;emptyList(), false), // empty statement block
            null // default value - not applicable here, used by annotations
        );
        ...
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example creates method with empty body.</p>
</div>
<div class="paragraph">
<p>At the end, do not forget to add it to type declaration and register change on working copy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        // and in the same way as interface was added to implements clause,
        // add feature to the class as its member:
        ClassTree modifiedClazz = make.addClassMember(clazz, newMethod);
        workingCopy.rewrite(clazz, modifiedClazz);
        ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do you want to see it in a practice? Open the java/source project, go to unit test packages, then org.netbeans.api.java.source.gen package, open file TutorialTest.java and run it in IDE. You can experiment with it little bit.</p>
</div>
</div>
</div>
      <section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Atom Feed" href="https://netbeans.apache.org/blogs/atom"><i class="fa fa-mf fa-rss"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="Issues" href="https://github.com/apache/netbeans/issues"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        <li><a href="https://github.com/apache/netbeans-antora-wiki/edit/main/modules/ROOT/pages/wiki/JavaHT_TreeMaker.adoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>
      </article>
    </div>
        <div class='grid-container incubator-area' style='margin-top: 64px'>
      <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/">
            <img style="width: 320px" title="Apache Software Foundation" src="../../../../_/images/asf_logo_wide.svg" />
          </a>
        </div>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/events/current-event.html">
            <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
          </a>
        </div>
      </div>
    </div>
    <footer>
      <div class="grid-container">
        <div class="grid-x grid-padding-x">
          <div class="large-auto cell">
            <h1><a href="../../../../front/main/about">About</a></h1>
            <ul>
              <li><a href="../../../../front/main/community/who">Who's Who</a></li>
              <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
              <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
              <li><a href="https://www.apache.org/security/">Security</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../front/main/community">Community</a></h1>
            <ul>
              <li><a href="../../../../front/main/community/mailing-lists">Mailing lists</a></li>
              <li><a href="../../../../front/main/community/committer">Becoming a committer</a></li>
              <li><a href="../../../../front/main/community/events">NetBeans Events</a></li>
              <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../front/main/participate">Participate</a></h1>
            <ul>
              <li><a href="../../../../front/main/participate/submit-pr">Submitting Pull Requests</a></li>
              <li><a href="../../../../front/main/participate/report-issue">Reporting Issues</a></li>
              <li><a href="../../../../front/main/participate/#documentation">Improving the documentation</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../front/main/help">Get Help</a></h1>
            <ul>
              <li><a href="../../../../front/main/help/#documentation">Documentation</a></li>
              <li><a href="../../../../wiki/main/wiki">Wiki</a></li>
              <li><a href="../../../../front/main/help/#support">Community Support</a></li>
              <li><a href="../../../../front/main/help/commercial-support">Commercial Support</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../front/main/download">Download</a></h1>
            <ul>
              <li><a href="../../../../front/main/download">Releases</a></li>                    
              <li><a href="https://plugins.netbeans.apache.org/">Plugins</a></li>
              <li><a href="../../../../front/main/download/#_daily_builds_and_building_from_source">Building from source</a></li>
              <li><a href="../../../../front/main/download/#_older_releases">Previous releases</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    <div class='footer-disclaimer'>
      <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2024 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
          <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
          <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
          <p>The Apache NetBeans website conforms to the <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Apache Software Foundation Privacy Policy</a></p>
        </div>
      </div>
    </div>

    
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
    <script src="../../../../_/js/vendor/jquery-3.7.1.min.js"></script>
    <script src="../../../../_/js/vendor/what-input.js"></script>
    <script src="../../../../_/js/vendor/foundation.min.js"></script>
    <script src="../../../../_/js/vendor/jquery.colorbox-min.js"></script>
    <script src="../../../../_/js/netbeans.js"></script>
    <script>
       $(function(){ $(document).foundation(); });
    </script>
    <script src="../../../../_/js/vendor/highlight-11.9.0.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', (event) => {
         document.querySelectorAll('pre code').forEach((el) => {
         hljs.highlightElement(el);
        });
      });
    </script>
  </body>
</html>
