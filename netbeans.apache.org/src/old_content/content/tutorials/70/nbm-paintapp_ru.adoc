// 
//     Licensed to the Apache Software Foundation (ASF) under one
//     or more contributor license agreements.  See the NOTICE file
//     distributed with this work for additional information
//     regarding copyright ownership.  The ASF licenses this file
//     to you under the Apache License, Version 2.0 (the
//     "License"); you may not use this file except in compliance
//     with the License.  You may obtain a copy of the License at
// 
//       http://www.apache.org/licenses/LICENSE-2.0
// 
//     Unless required by applicable law or agreed to in writing,
//     software distributed under the License is distributed on an
//     "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
//     KIND, either express or implied.  See the License for the
//     specific language governing permissions and limitations
//     under the License.
//

= Руководство по разработке приложений для рисования на платформе NetBeans
:jbake-type: platform_tutorial
:jbake-tags: tutorials 
:jbake-status: published
:syntax: true
:source-highlighter: pygments
:toc: left
:toc-title:
:icons: font
:experimental:
:description: Руководство по разработке приложений для рисования на платформе NetBeans - Apache NetBeans
:keywords: Apache NetBeans Platform, Platform Tutorials, Руководство по разработке приложений для рисования на платформе NetBeans

В этом руководстве представлены базовые аспекты разработки функционально насыщенных клиентских приложений на платформе NetBeans. Разработка приложений на платформе NetBeans подразумевает использование при разработке возможностей ядра среды IDE NetBeans. Все модули среды IDE, которые не требуются для разрабатываемого приложения, будут исключены, тогда как необходимые модули будут использованы. Использование уже готовых компонентов ядра среды IDE экономит значительное количество времени и сил.

NOTE:  В этом документе используется среда IDE NetBeans версии 6.5. Если установлена среда IDE NetBeans 6.x, обратитесь к  link:60/nbm-paintapp_ru.html[версии 6.0/6.1 этого документа].








== Введение в разработку приложения для рисования

Целью этого руководства является быстрая подготовка читателя к практической работе. Необходимо будет создать и установить простое приложение на платформе NetBeans. Это приложение позволит пользователю рисовать на экране и сохранять результаты:


image::images/paintapp_result-without-menus-60.png[]

Такая начальная версия далека от полнофункционального приложения для рисования, но, тем не менее, она иллюстрирует самый простой вариант создания приложения на базе платформы NetBeans.

NOTE:  Если необходимо получить дополнительные сведения о модулях NetBeans, а не о функционально насыщенных клиентских приложениях, рекомендуется обратиться к руководству  link:nbm-google_ru.html[Быстрое начало работы с подключаемыми модулями в среде NetBeans ].

В настоящем руководстве создается приложение на основе шаблона, поставляемого со средой IDE. Для просмотра готового приложения или разрешения проблем, возникающих при работе с этим руководством, в окне мастера создания проекта можно открыть шаблон по пути, указанному ниже:


image::images/paintapp_sample-in-new-project-60.png[]


== Создание приложения для рисования

В этом разделе необходимо будет создать структуру будущего приложения. Сначала следует создать скелет приложения, для чего используется соответствующий мастер. Приложение зависит от библиотеки, поэтому также будет создан модуль-обертка вокруг библиотеки, содержащий файл JAR библиотеки. Наконец, будет создан модуль, содержащий код.


=== Создание скелета приложения

Для создания скелета приложения используется шаблон "Приложение на платформе NetBeans". Скелет состоит из набора модулей, которые совместно образуют основу приложения. С помощью диалогового окна "Свойства проекта" назначаются заставка приложения, имя приложения, а также тип и количество модулей NetBeans, которые требуется использовать. Можно также воспользоваться такими возможностями, как создание дистрибутива в формате ZIP и построение приложения на базе Java WebStart (JNLP), являющимися важными средствами распространения приложения среди других пользователей.


[start=1]
1. Выберите в меню "Файл" команду "Новый проект". В разделе "Категории" выберите параметр "Модули NetBeans". В разделе "Проекты" выберите параметр "Приложение на платформе NetBeans".


image::images/paintapp_paintapp-proj-wiz.png[]

Нажмите кнопку "Далее".


[start=2]
1. На панели "Имя и расположение" в поле "Имя проекта" введите  ``PaintApp`` . В поле "Расположение проекта" укажите любой каталог на компьютере. Оставьте флажок "Установить как главный проект" отмеченным. Нажмите кнопку "Готово".

После этого скелет созданного приложения откроется в среде IDE. Он состоит из двух узлов в окне "Проекты". Первый узел ("Модули") предназначен для добавления к приложению модулей и модулей-оберток вокруг библиотек вручную. Кроме того, при использовании мастера создания модулей или мастера создания модулей-оберток вокруг библиотек, создаваемые модули можно автоматически добавлять к приложению.


=== Создание проекта модуля-обертки библиотеки

Модуль-обертка библиотеки – это модуль, файл JAR которого содержит не код, а только указатель на библиотеку. Благодаря этому библиотека становится модулем NetBeans; поэтому к ней применяются все защитные функции системы загрузчика классов NetBeans без изменения первоначального файла JAR. В дальнейшем создаваемое приложение зависит от библиотеки так же, как если бы библиотека была обычным модулем NetBeans. При появлении новых версий библиотеки в дистрибутиве изменяется только единственный файл модуля NetBeans (NBM) для библиотеки оберток.

NOTE:  К преимуществам построения приложений на платформе NetBeans относится интерфейс пользователя на базе стандартного инструментария для разработки интерфейса пользователя для Java – Swing. Так как Swing используется в течение долгого времени, существует множество компонентов, которые можно использовать в создаваемом приложении. В этом руководстве применяется существующий компонент JavaBean для выбора цветов (исходный код приведен в CVS NetBeans, в области  ``contrib/coloreditor`` ). Имя файла JAR –  ``ColorChooser.jar`` . Библиотеку можно загрузить  link:http://web.archive.org/web/20081119053233/http://colorchooser.dev.java.net/[здесь]. Сохраните ее в любом месте файловой системы.

Для создания модуля-обертки библиотеки для файла  ``ColorChooser.jar`` выполните следующие действия:


[start=1]
1. Выберите в меню "Файл" команду "Новый проект". В разделе "Категории" выберите параметр "Модули NetBeans". В области "Проекты" выберите "Модуль-обертка библиотеки" и нажмите кнопку "Далее".

[start=2]
1. На панели "Выбор библиотеки" либо введите в текстовое поле "Библиотека" путь к файлу  ``ColorChooser.jar`` , либо перейдите к его расположению с помощью функции обзора.

[start=3]
1. Оставьте поле "Лицензия" незаполненным. Если предполагается создание дистрибутива готового продукта, необходимо включить лицензионный файл внешней библиотеки. Нажмите кнопку "Далее".

[start=4]
1. На панели "Имя и расположение" заполните имя проекта, укажите расположение проекта и убедитесь в том, что в раскрывающемся списке "Добавить к набору модулей" выбрано значение, соответствующее добавлению модуля к приложению. Нажмите кнопку "Далее".

[start=5]
1. На панели "Базовая настройка модуля" введите уникальную основу кодового имени, укажите отображаемое имя модуля и местоположение локализируемого файла ресурсов для модуля:


image::images/paintapp_lib-wrap-1.png[]

Нажмите кнопку "Готово".

В среде IDE создается модуль, служащий оберткой для выбранной библиотеки  ``colorchooser.jar`` . Структура модуля выводится в окне "Проекты". В узле "Модули" в структуре приложения показано, что модуль является частью приложения.


=== Создание модуля

Теперь необходимо создать модуль для будущего фактического кода.


[start=1]
1. Выберите в меню "Файл" команду "Новый проект". В разделе "Категории" выберите параметр "Модули NetBeans". В области "Проекты" выберите "Модуль" и нажмите кнопку "Далее".

[start=2]
1. На панели "Имя и расположение" в поле "Имя проекта" введите  ``Paint`` . В поле "Расположение проекта" укажите любой каталог на компьютере. Убедитесь, что выбран переключатель "Добавить к набору модулей", а в раскрывающемся списке "Набор модулей" выбрано приложение  ``PaintApp`` . Установите флажок "Установить как главный проект". Нажмите кнопку "Далее".

[start=3]
1. На панели "Основные настройки модуля" введите  ``org.netbeans.paint``  В поле "Отображаемое имя модуля" оставьте имя  ``Paint`` . Не изменяйте местоположение локализируемого файла ресурсов. Установите флажок "Создать слой XML" и оставьте местоположение локализуемого файла ресурсов и слоя XML по умолчанию; при этом они будут храниться в пакете с именем  ``org.netbeans.paint`` .

Эти файлы предназначены для следующего:

* *Локализируемый файл ресурсов.* Указывает строки на конкретном языке в целях интернационализации.
* *Слой XML.* Регистрирует элементы, такие как меню и кнопки панели инструментов, в приложении на платформе NetBeans.

Нажмите кнопку "Готово".

В среде IDE создается проект  ``Paint`` . Проект содержит все исходные файлы и метаданные проекта, например, сценарий сборки проекта Ant. Проект откроется в среде IDE. Логическую структуру проекта можно просмотреть в окне "Проекты" (CTRL+1), а его файловую структуру – в окне "Файлы" (CTRL+2). Например, окно "Проекты" должно выглядеть следующим образом:


image::images/paintapp_paintapp-start-1.png[]

Кроме пакета локализации и файла layer.xml, проект также содержит следующие важные файлы:

* *Манифест модуля.* Объявляет проект модулем. Кроме того, он определяет некоторые характерные для модуля параметры настройки, например, местоположение файла layer.xml, местоположение пакета локализации и версию модуля.
* *Сценарий построения.* Предусматривает пространство для создания собственных параметров Ant и переопределения параметров, указанных в файле  ``nbproject/build-impl.xml`` .
* *Метаданные проекта.* Содержат такую информацию, как тип проекта, содержимое, платформа, путь к классам, зависимости и связи между командами проекта и параметрами в сценариях Ant.

В этом руководстве изменять эти файлы не придется.


=== Определение зависимостей модуля

Необходимо будет создать подклассы для нескольких классов, принадлежащих  link:http://bits.netbeans.org/dev/javadoc/index.html[интерфейсам API NetBeans]. Кроме того, проект должен зависеть от файла  ``ColorChooser.jar`` . Все интерфейсы API NetBeans реализованы модулями, поэтому выполнение обеих задач подразумевает лишь добавление в список модулей некоторых необходимых для выполнения модулей.


[start=1]
1. В окне "Проекты" щелкните правой кнопкой мыши узел проекта  ``Paint``  и выберите "Свойства". Откроется диалоговое окно "Свойства проекта". В области "Категории" выберите "Библиотеки"

[start=2]
1. Для каждого указанного в приведенной ниже таблице интерфейса API выберите "Добавить зависимость...", а затем в текстовом поле "Фильтр" начинайте вводить имя класса, для которого требуется подкласс.
|===

|*Класс* |*Интерфейc API* |*Назначение* 

| ``ColorChooser``  | ``ColorChooser``  |Модуль-обертка библиотеки для созданного компонента выбора цветов. 

| ``DataObject``  | ``Интерфейс API для систем данных``  |Модуль NetBeans, содержащий класс DataObject 

| ``DialogDisplayer``  | ``Интерфейс API для диалоговых окон``  |Позволяет создавать уведомления пользователя, описания диалогового окна и разрешает выводить их на экран. 

| ``AbstractFile``  | ``API файловой системы``  |Позволяет общему интерфейсу API обращаться к файлам единообразным способом. 

| ``AbstractNode``  | ``Интерфейс API для узлов``  |Основное средство визуализации объектов в NetBeans. 

| ``StatusDisplayer``  | ``API утилит интерфейса``  |Класс "StatusDisplayer" используется для создания строки состояния в главном окне. 

| ``WeakListeners``  | ``Интерфейс API для средств``  |Этот класс содержит класс "WeakListeners". 

| ``TopComponent``  | ``Системный интерфейс API для окон``  |Этот класс содержит класс "TopComponent JPanel". 
|===

В вышеприведенной таблице в первом столбце перечислены все классы, которым в этом руководстве потребуются подклассы. В каждом из этих случаев начинайте вводить имя класса в поле "Фильтр" и просматривайте сужающийся список в поле "Модуль". Второй столбец таблицы следует использовать для выбора подходящего интерфейса API (или, в случае  ``ColorChooser`` , библиотеки) из сокращенного списка "Модуль"; для подтверждения выбора нажмите кнопку "ОК":


image::images/paintapp_libfilter-60.png[]


[start=3]
1. Нажмите кнопку "ОК" для выхода из диалогового окна "Свойства проекта".

[start=4]
1. Если в окне "Проекты" не развернут узел проекта модуля "Paint", разверните его. Затем разверните узел "Важные файлы" и дважды щелкните узел "Метаданные проекта". Обратите внимание, что выбранные интерфейсы API были объявлены как зависимости модулей.


== Создание и внедрение элемента холста для рисования


=== Создание холста

Следующим действием будет создание фактического компонента, на котором пользователь сможет рисовать. В данном случае используется чистый компонент Swing, поэтому подробности его реализации можно пропустить и работать с окончательной версией. Для этой панели в исходном коде используется элемент выбора цветов, для которого был создан модуль-обертка библиотеки. При запуске готового приложения он отобразится на панели инструментов редактирования изображений.


[start=1]
1. В окне "Проекты" разверните узел  ``Paint`` , затем узел "Папки с исходными файлами", после этого щелкните правой кнопкой мыши узел  ``org.netbeans.paint`` . Выберите в меню "Создать" команду "Класс Java".

[start=2]
1. Введите  ``PaintCanvas``  в поле имени класса. Убедитесь, что в качестве пакета определен файл  ``org.netbeans.paint`` . Нажмите кнопку "Готово". Файл  ``PaintCanvas.java``  открывается в редакторе исходного кода.

[start=3]
1. Замените стандартное содержимое файла содержимым, которое можно найти  link:https://netbeans.apache.org/platform/guide/tutorials/paintTutorial/PaintCanvas.java[здесь]. Если пакет имеет имя, отличное от  ``org.netbeans.paint`` , исправьте имя пакета в редакторе исходного кода.


=== Подготовка класса TopComponent

Теперь необходимо будет написать первый класс для  link:http://bits.netbeans.org/dev/javadoc/index.html[интерфейсов API среды NetBeans]. Это класс  `` link:http://bits.netbeans.org/dev/javadoc/org-openide-windows/org/openide/windows/TopComponent.html[TopComponent]`` . Класс  ``TopComponent``  – это класс  ``JPanel`` , для которого у системы управления окнами NetBeans имеются методы взаимодействия, поэтому его можно будет разместить внутри контейнера с вкладками в главном окне.


[start=1]
1. В окне "Проекты" разверните узел  ``Paint`` , затем узел "Папки с исходными файлами", после этого щелкните правой кнопкой мыши узел  ``org.netbeans.paint`` . Выберите в меню "Создать" команду "Класс Java". Введите  ``PaintTopComponent``  в поле имени класса. Убедитесь, что в качестве пакета определен файл  ``org.netbeans.paint`` . Нажмите кнопку "Готово". Файл  ``PaintTopComponent.java``  открывается в редакторе исходного кода.

[start=2]
1. В верхней части файла измените объявление класса на следующее:

[source,java]
----

public class PaintTopComponent extends TopComponent implements ActionListener, ChangeListener {
----


[start=3]
1. Нажмите CTRL+SHIFT+I для исправления операторов импорта и нажмите в диалоговом окне кнопку "ОК". Среда IDE произведет необходимые объявления пакета импорта в верхней части файла.

Обратите внимание на красную линию под введенным объявлением класса. Установите курсор в строке и обратите внимание на лампочку, появившуюся в левом поле. Щелкните изображение лампочки (или нажмите ALT+ВВОД), как показано ниже:


image::images/paintapp_lightbulb-60.png[]

Выберите "Реализовать все абстрактные методы" Среда IDE создаст два скелетных метода:  ``actionPerformed()``  и  ``stateChanged()`` . Немного позднее их необходимо будет заполнить кодом.

[start=4]
1. Над классом  ``PaintTopComponent``  добавьте следующие три объявления переменных, а затем исправьте операторы импорта (CTRL+SHIFT+I).

[source,java]
----

    private PaintCanvas canvas = new PaintCanvas(); //Компонент для рисования
    private JComponent preview; //Компонент на панели инструментов, обозначающий размер кисти
    private static int ct = 0; //Счетчик, который дает имена новым изображениям
----


[start=5]
1. Теперь необходимо реализовать два шаблонных метода. Первый сообщает системе управления окнами о необходимости игнорирования открытых окон, если приложение закрыто; второй предоставляет основную строку для уникального идентификатора строки создаваемого элемента. Каждый элемент  ``TopComponent``  имеет уникальный идентификатор строки, который используется при сохранении  ``TopComponent`` . Вставьте два следующих метода в класс  ``PaintTopComponent`` :

[source,java]
----

    @Override
    public int getPersistenceType() {
        return PERSISTENCE_NEVER;
    }

    @Override
    public String preferredID() {
        return "Image";
    }
----

Класс должен выглядеть следующим образом:


[source,java]
----

public class PaintTopComponent extends TopComponent implements ActionListener, ChangeListener {
    
    private PaintCanvas canvas = new PaintCanvas(); //Компонент для рисования
    private JComponent preview; //Компонент на панели инструментов, обозначающий размер кисти
    private static int ct = 0; //Счетчик, который дает имена новым изображениям
    
    public PaintTopComponent() {
    }
    
    @Override
    public void actionPerformed(ActionEvent arg0) {
        throw new UnsupportedOperationException("Пока не поддерживается.");
    }
    
    @Override
    public void stateChanged(ChangeEvent arg0) {
        throw new UnsupportedOperationException("Пока не поддерживается.");
    }
    
    @Override
    public int getPersistenceType() {
        return PERSISTENCE_NEVER;
    }
    
    @Override
    public String preferredID() {
        return "Image";
    }
    
}
----


=== Инициализация класса TopComponent

В этом разделе будет добавлен код, инициализирующий интерфейс пользователя.


[start=1]
1. Определите конструктор и исправьте выражения импорта (CTRL+SHIFT+I):

[source,java]
----

    public PaintTopComponent() {

        initComponents();

        String displayName = NbBundle.getMessage(
                PaintTopComponent.class,
                "UnsavedImageNameFormat",
                new Object[] { new Integer(ct++) }
        );

        setDisplayName(displayName);

    }
----

Код в этом случае довольно прост. Первым вызывается еще не написанный метод  ``initComponents()`` , который добавит панель инструментов и элемент "PaintCanvas" к элементу  ``TopComponent`` . Так как этот метод еще не написан, он подчеркивается красной линией. Как и в предыдущем случае, щелкните изображение лампочки (или нажмите ALT+ВВОД) и примите предложение:


image::images/paintapp_lightbulb-initcomponents-60.png[]

Будет создан скелетный код метода  ``initComponents()`` .


[start=2]
1. Разверните пакет  ``org.netbeans.paint``  в окне "Проекты". Дважды щелкните файл  ``Bundle.properties`` , чтобы открыть его в редакторе исходного кода. В конец добавьте следующую строку:

[source,java]
----

    UnsavedImageNameFormat=Image {0}
----

Она отвечает за текст, который будет использоваться для идентификации нового файла изображения перед его сохранением пользователем. Например, когда пользователь в первый раз выбирает "Новый холст" в готовом приложении, над редактором исходного кода появится вкладка с текстом "Image 0". Перед продолжением не забудьте сохранить файл.


=== Заполнение кодом скелетных методов

В этом разделе будет написан код интерфейса пользователя для создаваемого приложения. Для визуальной разработки формата можно также использовать Конструктор GUI среды IDE.


[start=1]
1. Метод  ``initComponents()``  устанавливает в панели элементы, благодаря которым пользователь получает возможность взаимодействия с приложением. Его скелетный метод был создан в предыдущем разделе в классе  ``PaintTopComponent.java`` . Заполните его следующим образом:

[source,java]
----

    private void initComponents() {

        setLayout(new BorderLayout());
        JToolBar bar = new JToolBar();

        ColorChooser fg = new ColorChooser();
        preview = canvas.createBrushSizeView();

        //Формирование панели инструментов

        //Обеспечьте правильное размещение элементов:
        Dimension min = new Dimension(32, 32);
        preview.setMaximumSize(min);
        fg.setPreferredSize(new Dimension(16, 16));
        fg.setMinimumSize(min);
        fg.setMaximumSize(min);

        JButton clear = new JButton(
          	    NbBundle.getMessage(PaintTopComponent.class, "LBL_Clear"));

        JLabel fore = new JLabel(
         	    NbBundle.getMessage(PaintTopComponent.class, "LBL_Foreground"));

        fg.addActionListener(this);
        clear.addActionListener(this);

        JSlider js = new JSlider();
        js.setMinimum(1);
        js.setMaximum(24);
        js.setValue(canvas.getDiam());
        js.addChangeListener(this);

        fg.setColor(canvas.getColor());

        bar.add(clear);
        bar.add(fore);
        bar.add(fg);
        JLabel bsize = new JLabel(
     	    NbBundle.getMessage(PaintTopComponent.class, "LBL_BrushSize"));

        bar.add(bsize);
        bar.add(js);
        bar.add(preview);

        JLabel spacer = new JLabel("   "); //Выровняйте разделитель так, чтобы кисть в предварительном просмотре не была растянута до конца панели инструментов:
        spacer.setPreferredSize(new Dimension(400, 24));
        bar.add(spacer);

        //Установите панель инструментов и элемент для рисования:
        add(bar, BorderLayout.NORTH);
        add(canvas, BorderLayout.CENTER);
        
    }
----

Нажмите CTRL+SHIFT+I для добавления отсутствующих операторов импорта.


[start=2]
1. Заполните два других созданных метода. Они используются для прослушивания класса  ``PaintTopComponent`` :

[source,java]
----

    public void actionPerformed(ActionEvent e) {

        if (e.getSource() instanceof JButton) {
           canvas.clear();
        } else if (e.getSource() instanceof ColorChooser) {
           ColorChooser cc = (ColorChooser) e.getSource();
           canvas.setPaint (cc.getColor());
        }
        
        preview.paintImmediately(0, 0, preview.getWidth(), preview.getHeight());
        
    }
----


[source,java]
----

    public void stateChanged(ChangeEvent e) {

        JSlider js = (JSlider) e.getSource();
        canvas.setDiam (js.getValue());
        preview.paintImmediately(0, 0, preview.getWidth(), preview.getHeight());
        
    }
----


[start=3]
1. В конец файла  ``Bundle.properties``  добавьте следующие пары "ключ-значение":

[source,java]
----

    LBL_Clear = Очистить
    LBL_Foreground = Цвет 
    LBL_BrushSize = Размер кисти

----

Перед продолжением не забудьте сохранить файл.


=== Функция сохранения изображения на диске

В новом приложении необходимо реализовать возможность сохранения созданных изображений пользователем. Эта функциональная возможность активируется включением следующего кода в класс  ``PaintTopComponent`` .


[start=1]
1. Вставьте следующий код в класс  ``PaintTopComponent`` :

[source,java]
----

    public void save() throws IOException {

        if (getDisplayName().endsWith(".png")) {
	    doSave(new File(getDisplayName()));
        } else {
	    saveAs();
        }
        
    }

    public void saveAs() throws IOException {

        JFileChooser ch = new JFileChooser();
        if (ch.showSaveDialog(this) == JFileChooser.APPROVE_OPTION &amp;&amp; ch.getSelectedFile() != null) {

	    File f = ch.getSelectedFile();
            
	    if (!f.getPath().endsWith(".png")) {
	        f = new File(f.getPath() + ".png");
	    }
            
	    if (!f.exists()) {
            
	        if (!f.createNewFile()) {
		    String failMsg = NbBundle.getMessage(
		             PaintTopComponent.class,
			    "MSG_SaveFailed", new Object[] { f.getPath() }
	            );
		    JOptionPane.showMessageDialog(this, failMsg);
		    return;
	        }
                
	    } else {
	        String overwriteMsg = NbBundle.getMessage(
		    PaintTopComponent.class,
                    "MSG_Overwrite", new Object[] { f.getPath() }
	        );
                
	        if (JOptionPane.showConfirmDialog(this, overwriteMsg)
	        != JOptionPane.OK_OPTION) {
		    return;
	        }
                
	    }
            
	    doSave(f);
            
        }
        
    }

    private void doSave(File f) throws IOException {

        BufferedImage img = canvas.getImage();
        ImageIO.write(img, "png", f);
        String statusMsg = NbBundle.getMessage(PaintTopComponent.class,
            "MSG_Saved", new Object[] { f.getPath() });
        StatusDisplayer.getDefault().setStatusText(statusMsg);
        setDisplayName(f.getName());
        
    }
----


[start=2]
1. Добавьте в файл  ``Bundle.properties``  следующие строки:

[source,java]
----

    MSG_SaveFailed = Запись в файл невозможна {0}
    MSG_Overwrite = {0} существует.  Перезаписать?
    MSG_Saved = Изображение сохранено в {0}
----

Перед продолжением не забудьте сохранить файл.


[start=3]
1. Нажмите CTRL+SHIFT+I для исправления операторов импорта. Для класса  ``File``  будут отображены два полностью определенных имени. Выберите вариант  ``java.io.File`` .


== Создание пункта меню для создания нового холста

Для создания основных функциональных возможностей модуля используются шаблоны файлов разработки модуля. При использовании шаблона файла среда IDE регистрирует созданный элемент в файле  ``layer.xml`` . После выполнения мастера для создания шаблона файла для дальнейшей разработки модуля используются  link:https://bits.netbeans.org/dev/javadoc/[интерфейсы API NetBeans].


[start=1]
1. В окне "Проекты" щелкните правой кнопкой мыши узел проекта "Paint" и выберите в меню "Создать" команду "Прочее". В мастере создания файлов выберите "Разработка модулей" в области "Категории" и "Действие" в области "Типы файлов". Нажмите кнопку "Далее".

[start=2]
1. На панели "Тип действия" примите параметры по умолчанию. Нажмите кнопку "Далее".

[start=3]
1. На панели "Регистрация в интерфейсе" выберите "Глобальный пункт меню" и "Глобальная кнопка панели инструментов". Установите следующие значения:
* *Категория:* Правка
* *Меню:* Файл
* *Позиция:* Без ограничений!
* *Панель инструментов:* Файл
* *Позиция:* Без ограничений!

NOTE:  Местоположение действия не имеет значения, однако оно должно находиться в меню "Файл" и на панели инструментов "Файл".

На экране должны быть представлены следующие параметры:


image::images/paintapp_newcanvasaction-60.png[]

Нажмите кнопку "Далее".


[start=4]
1. На панели "Имя, значок и расположение" введите  ``NewCanvasAction``  в качестве имени класса и  ``New Canvas``  в поле "Отображаемое имя".

В области "Значок" перейдите к этому значку с помощью функции обзора (щелкните его правой кнопкой мыши на этой странице и сохраните в папку  ``org.netbeans.paint`` ): 
image::images/paintapp_new_icon.png[]


[start=5]
1. Нажмите кнопку "Готово".

В результате создается файл  ``NewCanvasAction.java``  в  ``org.netbeans.paint`` , который открывается в редакторе исходного кода. На экране должно отобразиться следующее:


[source,java]
----

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package org.netbeans.paint;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

public final class NewCanvasAction implements ActionListener {

    public void actionPerformed(ActionEvent e) {
        // TODO реализация тела действия
    }
    
}
----

Как указано на панели "Регистрация в интерфейсе", среда IDE регистрирует класс действия как пункт меню и как кнопку на панели инструментов в файле  ``layer.xml`` .


[start=6]
1. В редакторе исходного кода откройте  ``NewCanvasAction.java``  и заполните метод  ``actionPerformed()``  следующим кодом:

[source,java]
----

    public void actionPerformed(ActionEvent e) {
        PaintTopComponent tc = new PaintTopComponent();
        tc.open();
        tc.requestActive();       
    }
----

Этот код создает новый экземпляр элемента редактирования изображения; откройте его, в результате чего он появится в главном окне, а затем активируйте его путем установки курсора и выбора связанной с ним вкладки.


== Создание пункта меню для сохранения холста

Как и в предыдущем разделе, для создания элемента меню используется мастер создания действий, с помощью которого далее будет создана функция сохранения изображений.


[start=1]
1. В окне "Проекты" щелкните правой кнопкой мыши узел проекта "Paint" и выберите в меню "Создать" команду "Прочее". В мастере создания файлов выберите "Разработка модулей" в области "Категории" и "Действие" в области "Типы файлов". Нажмите кнопку "Далее".

[start=2]
1. На панели "Тип действия" примите параметры по умолчанию. Нажмите кнопку "Далее".

[start=3]
1. На панели "Регистрация в интерфейсе" выберите "Глобальный пункт меню" и "Глобальная кнопка панели инструментов". Установите следующие значения:
* *Категория:* Правка
* *Меню:* Файл
* *Позиция:* Без ограничений!
* *Панель инструментов:* Файл
* *Позиция:* Без ограничений!

NOTE:  Местоположение действия не имеет значения, однако оно должно находиться в меню "Файл" и на панели инструментов "Файл".

Нажмите кнопку "Далее".

[start=4]
1. На панели "Имя, значок и расположение" введите  ``SaveCanvasAction``  в качестве имени класса и  ``Save Canvas``  в поле "Отображаемое имя".

В области "Значок" вставьте этот значок (щелкните его правой кнопкой мыши на этой странице и сохраните в папку  ``org.netbeans.paint`` ):


image::images/paintapp_save_icon.png[]

[start=5]
1. Нажмите кнопку "Готово".

В результате создается файл  ``SaveCanvasAction.java``  в  ``org.netbeans.paint`` , который открывается в редакторе исходного кода.


[start=6]
1. Измените сигнатуру класса:  ``CallableSystemAction``  должен быть расширен, а  ``PropertyChangeListener``  – реализован:

[source,java]
----

public final class SaveCanvasAction extends CallableSystemAction implements PropertyChangeListener
----


[start=7]
1. В редакторе исходного кода убедитесь в том, что файл  ``SaveCanvasAction.java``  открыт, и заполните метод  ``actionPerformed()``  следующим кодом:

[source,java]
----

    @Override
    public void actionPerformed(ActionEvent e) {
        TopComponent tc = TopComponent.getRegistry().getActivated();

        if (tc instanceof PaintTopComponent) {

            try {
                ((PaintTopComponent) tc).saveAs();
            } catch (IOException ioe) {
                ErrorManager.getDefault().notify(ioe);
            }

        } else {

            //Теоретически за промежуток времени между нажатием 
            //кнопки в меню или в панели инструментов и вызовом действия 
            //активный элемент мог измениться.  Это маловероятно,
            //но теоретически возможно
            Toolkit.getDefaultToolkit().beep();

        }
    }
----

Нажмите CTRL+SHIFT+I для добавления отсутствующих операторов импорта.


image::images/paintapp_fiximports-60.png[]

[start=8]
1. Заполните методы класса  ``CallableSystemAction``  следующим образом:

[source,java]
----

    @Override
    public String getName() {
        return "Save Canvas";
    }

    @Override
    public HelpCtx getHelpCtx() {
        return null;
    }

----


[start=9]
1. Заполните метод  ``propertyChange()``  класса  ``PropertyChangeListener``  следующим образом:

[source,java]
----

    @Override    
    public void propertyChange(PropertyChangeEvent evt) {

        if (TopComponent.Registry.PROP_ACTIVATED.equals(evt.getPropertyName())){
	    updateEnablement();
        }
        
    }
----

При появлении красной линии нажмите ALT+ВВОД, и среда IDE создаст метод  ``updateEnablement()``  в классе  ``SaveCanvasAction`` .


[start=10]
1. Затем определите метод  ``updateEnablement()`` :

[source,java]
----

    private void updateEnablement() {

        setEnabled(TopComponent.getRegistry().getActivated()
        instanceof PaintTopComponent);

    }
----


[start=11]
1. После этого определите конструктор:

[source,java]
----

    public SaveCanvasAction() {  

        TopComponent.getRegistry().addPropertyChangeListener (
	    WeakListeners.propertyChange(this,
	    TopComponent.getRegistry()));
       
        updateEnablement();
        
    }
----

При появлении красной линии нажмите ALT+ВВОД для импорта средой IDE  ``org.openide.util.WeakListeners`` .

Важной частью кода является добавление прослушивающего процесса изменения свойств.  ``TopComponent.Registry``  – это реестр всех открытых экземпляров  ``TopComponent``  в системе, т.е. всех открытых вкладок. Он должен прослушиваться на наличие изменений и предусматривать разрешение или запрет выполнения действия в зависимости от текущего фокуса.

*Примечание.* Вместо непосредственного добавления прослушивающего процесса изменения свойств можно вызвать  ``WeakListeners.propertyChange()`` . В результате будет создан прослушивающий процесс изменения свойств, слабо связанный с рассматриваемым действием. Несмотря на то, что действие активно только при открытом приложении, если код ни при каких условиях не открепляет прослушивающий процесс, рекомендуется предусмотреть слабосвязанный прослушивающий процесс. В противном случае возможна потенциальная утечка памяти – действие никогда не сможет быть обработано сборщиком мусора, так как реестр будет ссылаться на него в своем списке прослушивающих процессов.

В окне "Проекты" должно отображаться следующее:


image::images/paintapp_final-paint-module.png[]


== Заключительная подготовка

Разумеется, всегда желательно создавать тщательно настроенное приложение, поэтому приведем ряд завершающих действий. Сначала создадим для приложения экран заставки, а затем сформируем дистрибутив в виде архива ZIP и приложение JNLP.


[start=1]
1. Запустите проект  ``PaintApp`` . После запуска приложения установите небольшой размер основного экрана и нарисуйте экран-заставку. Для сохранения экрана используйте кнопку "Сохранить".

[start=2]
1. Щелкните правой кнопкой мыши узел исходного проекта  ``PaintApp`` , выберите "Свойства" и щелкните "Построить" в диалоговом окне "Свойства проекта".

[start=3]
1. Выберите параметр "Создать отдельное приложение". Теперь можно ввести название приложения (имя в средстве запуска, создаваемом средой IDE) и текст заголовка (который будет выводиться в строке заголовка). По умолчанию должно отображаться следующее:


image::images/paintapp_splashscreen1-60.png[]


[start=4]
1. Выберите "Заставка". Найдите собственный экран-заставку с помощью функции обзора. При отсутствии собственной заставки используйте  link:https://netbeans.apache.org/platform/images/tutorials/paintapp/splash.gif[эту]. Нажмите кнопку "ОК" для прикрепления заставки к приложению:


image::images/paintapp_splashscreen-60.png[]


[start=5]
1. Затем в файле  ``layer.xml``  модуля Paint добавьте следующие теги в папку "Menu". Эти теги удаляют меню "Переход" и "Просмотр", которые не должны быть представлены в приложении для рисования.

[source,java]
----

<file name="GoTo_hidden"/>
<file name="View_hidden"/>
----

В качестве альтернативы, вместо добавления вышеуказанных тегов вручную можно удалить папки в узле  ``<этот слой в контексте>``   ``layer.xml`` . Для этого разверните узел  ``<этот слой в контексте>`` , а затем разверните узел "Строка меню". Щелчком правой кнопки мыши вызовите меню для узлов "Переход" и "Просмотр" и выберите "Удалить".


[start=6]
1. После этого снова запустите приложение и проверьте появившийся экран-заставку. Обратите внимание, что в запущенном приложении в строке заголовка выводится указанный текст. Кроме того, сократилось количество пунктов меню, кнопок на панели инструментов и других элементов: 
image::images/paintapp_result-without-menus-60.png[]


== Создание дистрибутива

Теперь необходимо выбрать тип дистрибутива. Щелкните правой кнопкой мыши узел  ``PaintApp``  и для сборки готового приложения со всеми необходимыми модулями и файлами в один файл ZIP выберите "Создать дистрибутив ZIP". Также можно выбрать "Построить приложение JNLP" для создания версии JavaWebStart приложения, которое можно разместить на веб-сервере и перейти к нему по ссылке непосредственно с веб-страницы (потребуется указать точный URL-адрес: созданный дескриптор будет использовать протокол "file:", поэтому можно будет тестировать созданный веб-дистрибутив на локальном компьютере).

Поздравляем! Сборка приложения для рисования на базе платформы NetBeans завершена. Следующая тема:  link:https://netbeans.apache.org/tutorials/nbm-feedreader.html[Руководство по созданию приложения для чтения каналов на платформе NetBeans].

link:http://netbeans.apache.org/community/mailing-lists.html[Мы ждем ваших отзывов]
