
<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
    
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Урок 4: Оптимизация кода путем добавления классов и объектов</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Урок 4: Оптимизация кода путем добавления классов и объектов - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, Урок 4: Оптимизация кода путем добавления классов и объектов">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
     <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css"> 
    <link rel="stylesheet" href="/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"> 
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
</head>


    <body>
        

<div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="/"><img src='/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <a href="/community/index.html">Community</a> </li>
            <li> <a href="/participate/index.html">Participate</a> </li>
            <li> <a href="https://blogs.apache.org/netbeans/">Blog</a></li>
            <li> <a href="/help/index.html">Get Help</a> </li>
            <li> <a href="https://plugins.netbeans.apache.org/">Plugins</a> </li>
            <li> <a href="/download/index.html">Download</a> </li>
        </ul>
    </div>
</div>


        
<!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Latest release</div>
            <h1>Apache NetBeans 12.2</h1>
            <p><a class="button success" href="/download/nb122/index.html">Find out more</a></p>
        </div>
    </div>
</section>

        <div class='grid-container main-content tutorial'>
            <h1 class="sect0">Урок 4: Оптимизация кода путем добавления классов и объектов</h1>
            
            <div class="sectionbody">
              <div class="admonitionblock note">
                <table>
                  <tbody><tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">This tutorial needs a review. 
                     You can <a href="https://issues.apache.org/jira/projects/NETBEANS/issues">open a JIRA issue</a>, 
                     or <a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/php/wish-list-lesson4_ru.asciidoc" title="Edit this tutorial in github">edit it in GitHub </a>
                     following these <a href="/kb/docs/contributing.html">contribution guidelines.</a></td>
                  </tr></tbody>
                </table>
              </div>
            </div>
            
            <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#previousLessonSourceCode">Исходный код приложения из предыдущего урока</a></li>
<li><a href="#createDbPhpFile">Создание файла db.php</a></li>
<li><a href="#wishDBClass">Создание класса WishDB</a></li>
<li><a href="#instantiate-wishdb">Создание экземпляров класса WishDB</a></li>
<li><a href="#wishdb-constructor">Добавление конструктора к классу WishDB</a></li>
<li><a href="#includedFunctions">Функции класса WishDB</a>
<ul class="sectlevel2">
<li><a href="#_Функция_get_wisher_id_by_name">Функция get_wisher_id_by_name</a></li>
<li><a href="#getWishesByID">Функция get_wishes_by_wisher_id</a></li>
<li><a href="#createWisher">Функция create_wisher</a></li>
</ul>
</li>
<li><a href="#refactoring">Реорганизация кода приложения</a>
<ul class="sectlevel2">
<li><a href="#refactoringWishlistFile">Реорганизация файла wishlist.php</a></li>
<li><a href="#refactoringCreateNewWisher">Реорганизация файла createNewWisher.php</a></li>
</ul>
</li>
<li><a href="#lessonResultSourceCode">Исходный код приложения на момент завершения текущего урока</a></li>
<li><a href="#_Что_дальше">Что дальше?</a></li>
<li><a href="#_Полезные_ссылки">Полезные ссылки</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>В этом уроке рассматриваются способы оптимизации кода, позволяющие упростить поддержку этого кода в дальнейшем. Данная процедура затрагивает файлы  <code>createNewWisher.php</code>  и  <code>wishlist.php</code> . Кроме того, создается новый файл под названием  <code>db.php</code> .</p>
</div>
<div class="paragraph">
<p>Код приложения содержит несколько похожих блоков с запросами к базе данных. Для упрощения чтения и поддержки кода в будущем можно извлечь эти блоки, реализовать их в качестве функций отдельного класса  <code>WishDB</code>  и поместить текст  <code>WishDB</code>  в файл  <code>db.php</code> . Впоследствии можно включить файл  <code>db.php</code>  в любой файл PHP и использовать любую <a href="#includedFunctions">функцию класса WishDB</a> без дублирования кода. Такой подход гарантирует, что любые изменения в запросах или функциях будут выполнены в одном местоположении, и анализировать весь код приложения не потребуется.</p>
</div>
<div class="paragraph">
<p>При использовании функции класса WishDB не следует изменять значения каких-либо переменных в классе WishDB. Вместо этого необходимо использовать класс в качестве концептуального проекта для создания объекта WishDB и изменять значения переменных в этом объекте. Объект уничтожается при завершении работы. Поскольку значения непосредственно класса WishDB никогда не изменяются, данный класс можно использовать повторно неограниченное число раз. В некоторых случаях может потребоваться одновременно несколько экземпляров класса, а в других случаях будет предпочтителен "одноэкземплярный" класс, имеющий только один экземпляр в любой момент времени. WishDB в данном руководстве представлен как одноэкземплярный класс.</p>
</div>
<div class="paragraph">
<p>Следует отметить, что создание объекта класса обозначается термином "создание экземпляра" этого класса и что объект в данном случае называется "экземпляром" класса. Общий термин, обозначающий программирование с использованием классов и объектов, – "объектно-ориентированное программирование" (ООП). В PHP 5 используется сложная модель ООП. См. <a href="http://us3.php.net/zend-engine-2.php">php.net</a> для получения дополнительной информации.</p>
</div>
<div class="paragraph">
<p>В данном руководстве вы перемещаете функциональность вызова базы данных из отдельных файлов РНР в класс WishDB. Пользователи MySQL также заменяют процедурные вызовы  <code>mysqli</code>  объектно-ориентированными. Это соответствует новой объектно-ориентированной структуре приложения.</p>
</div>
<div class="paragraph">
<p>Текущий документ является частью краткого учебного курса "Создание приложения CRUD в IDE NetBeans для PHP".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="previousLessonSourceCode">Исходный код приложения из предыдущего урока</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Для пользователей MySQL: перейдите по <a href="https://netbeans.org/files/documents/4/1929/lesson3.zip">этой ссылке</a> для загрузки исходного кода, описывающего состояние проекта на момент завершения предыдущего урока.</p>
</div>
<div class="paragraph">
<p>Для пользователей Oracle Database: щелкните <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson3.zip">здесь</a> для загрузки исходного кода, отражающего состояние проекта по завершении предыдущего урока.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="createDbPhpFile">Создание файла db.php</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Создайте новую подпапку в папке "Исходные файлы". Дайте папке имя Includes. Создайте новый файл под именем db.php и поместите его в папку Includes. Позже вы сможете добавлять в эту папку файлы, которые будут включаться в другие РНР-файлы.</p>
</div>
<div class="paragraph">
<p><strong>Чтобы создать файл db.php в новой папке, сделайте следующее:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните правой кнопкой мыши узел "Source Files" и выберите "New &gt; Folder" в контекстном меню. Откроется диалоговое окно "Новая папка"</p>
</li>
<li>
<p>В поле "Имя папки" введите Includes. Затем нажмите кнопку "Готово".</p>
</li>
<li>
<p>Щелкните правой кнопкой мыши узел "Includes" и выберите "New &gt; PHP File" в контекстном меню. Откроется диалоговое окно "Новый файл РНР".</p>
</li>
<li>
<p>В поле "Имя файла" введите db. Затем нажмите кнопку "Готово".</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wishDBClass">Создание класса WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Для создания класса WishDB необходимо инициализировать переменные класса и реализовать конструктор класса. Пользователи MySQL, обратите внимание, что класс WishDB <em>расширяет</em>  <code>mysqli</code> . Это означает, что WishDB <em>наследует</em> функции и другие характеристики класса PHP mysqli. Вы убедитесь в важности этого при добавлении функций  <code>mysqli </code>  к классу.</p>
</div>
<div class="paragraph">
<p>Откройте файл db.php и создайте класс WishDB. В данном классе объявите переменные настройки базы данных для хранения имени и пароля собственника базы данных (пользователя), имени и машины размещения базы данных. Все объявления переменных являются закрытыми: это означает, что начальные значения в этих объявлениях недоступны вне класса WishDB (см. <a href="http://us3.php.net/manual/en/language.oop5.visibility.php">php.net</a>). Вы также объявляете закрытую _ статическую переменную_  <code>$instance</code> , которая хранит экземпляр WishDB. Ключевое слово "статический" означает, что функции в классе имеют доступ к переменной даже при отсутствии экземпляра класса.</p>
</div>
<div class="paragraph">
<p><strong>Для базы данных MySQL:</strong></p>
</div>
<div class="paragraph">
<p>[[source,php]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>class WishDB extends mysqli {

    // single instance of self shared among all instances
    private static $instance = null;

    // db connection config vars
    private $user = "phpuser";
    private $pass = "phpuserpw";
    private $dbName = "wishlist";
    private $dbHost = "localhost";

}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Для базы данных Oracle:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">class WishDB {

    // single instance of self shared among all instances
    private static $instance = null;

    // db connection config vars
    private $user = "phpuser";
    private $pass = "phpuserpw";
    private $dbName = "wishlist";
    private $dbHost = "localhost/XE";
    private $con = null;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instantiate-wishdb">Создание экземпляров класса WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>При использовании функций класса WishDB в других файлах PHP должна быть вызвана функция, позволяющая создать объект ("создать экземпляр") класса WishDB. WishDB разработан в качестве <a href="http://www.phpclasses.org/browse/package/1151.html">одноэкземплярного класса</a>; это означает, что в любой определенный момент времени может существовать только один экземпляр класса. Поэтому рекомендуется предотвращать создание экземпляра WishDB, которое осуществляется извне и способствует появлению дублирующихся экземпляров.</p>
</div>
<div class="paragraph">
<p>Внутри класса WishDB введите или вставьте следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// This method must be static, and must return an instance of the object if the object
// does not already exist.

public static function getInstance() {

  if (!self::$instance instanceof self) {
    self::$instance = new self;
  }

  return self::$instance;
}

// The clone and wakeup methods prevents external instantiation of copies of the Singleton class,
// thus eliminating the possibility of duplicate objects.

public function __clone() {
  trigger_error('Clone is not allowed.', E_USER_ERROR);
}

public function __wakeup() {
  trigger_error('Deserializing is not allowed.', E_USER_ERROR);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Функция  <code>getInstance</code>  является общедоступной и статической. Общедоступность означает возможность свободного доступа извне класса. Статическая функция доступна даже в том случае, если для класса не было создано экземпляров. Поскольку функция  <code>getInstance</code>  вызывается для создания экземпляров класса, она является статической. Обратите внимание, что эта функция имеет доступ к статической переменной <code>$instance</code>  и устанавливает ее значение как экземпляр класса.</p>
</div>
<div class="paragraph">
<p>Двойное двоеточие (::), или "оператор разрешения диапазона" (Scope Resolution Operator), и ключевое слово  <code>self</code>  используются для получения доступа к статическим функциям.  <code>Self</code>  в рамках определения класса используется в качестве ссылки на данный класс. Если двойное двоеточие находится вне определения класса, вместо  <code>self</code>  используется имя класса. См. ресурс <a href="http://us3.php.net/manual/en/language.oop5.paamayim-nekudotayim.php">php.net для получения информации об операции разрешения диапазона</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wishdb-constructor">Добавление конструктора к классу WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Класс может содержать в себе специальный метод, известный как "конструктор", который выполняется автоматически каждый раз при создании экземпляра этого класса. В данном руководстве рассматривается добавление к классу WishDB конструктора, который подключается к базе данных каждый раз при создании экземпляра WishDB.</p>
</div>
<div class="paragraph">
<p>Добавьте к WishDB следующий код:</p>
</div>
<div class="paragraph">
<p><strong>Для базы данных MySQL</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// private constructor
private function __construct() {

  parent::__construct($this-&gt;dbHost, $this-&gt;user, $this-&gt;pass, $this-&gt;dbName);

  if (mysqli_connect_error()) {
    exit('Connect Error (' . mysqli_connect_errno() . ') '. mysqli_connect_error());
  }

  parent::set_charset('utf-8');
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Для базы данных Oracle</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// private constructor
private function __construct() {

    $this-&gt;con = oci_connect($this-&gt;user, $this-&gt;pass, $this-&gt;dbHost);

    if (!$this-&gt;con) {
        $m = oci_error();
        echo $m['message'], "\n";
        exit;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Следует учитывать, что вместо переменных  <code>$con</code> ,  <code>$dbHost</code> ,  <code>$user</code>  или  <code>$pass</code>  используется псевдопеременная  <code>$this</code> . Псевдопеременная  <code>$this</code>  используется при вызове метода внутри контекста объекта. Она ссылается на значение переменной внутри этого объекта.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="includedFunctions">Функции класса WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>В этом уроке рассматривается реализация следующих функций класса WishDB:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#getIDByName">get_wisher_id_by_name</a> для извлечения идентификатора пользователя на основе имени</p>
</li>
<li>
<p><a href="#getWishesByID">get_wishes_by_wisher_id</a> для извлечения списка пожеланий "Wish list", принадлежащего определенному пользователю с соответствующим идентификатором</p>
</li>
<li>
<p><a href="#createWisher">create_wisher</a> для добавления нового пользователя в таблицу "Wishers".</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_Функция_get_wisher_id_by_name">Функция get_wisher_id_by_name</h3>
<div class="paragraph">
<p>Эта функция возвращает идентификатор пользователя, а в качестве входного параметра для ее выполнения требуется имя пользователя.</p>
</div>
<div class="paragraph">
<p>После функции WishDB введите или вставьте следующую функцию в класс WishDB:</p>
</div>
<div class="paragraph">
<p><strong>Для базы данных MySQL</strong></p>
</div>
<div class="paragraph">
<p>[[source,php]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public function get_wisher_id_by_name($name) {

  $name = $this-&gt;real_escape_string($name);
  $wisher = $this-&gt;query("SELECT id FROM wishers WHERE name = '" . $name . "'");

  if ($wisher-&gt;num_rows &gt; 0){
    $row = $wisher-&gt;fetch_row();
    return $row[0];
  } else {
    return null;
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Для базы данных Oracle</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">public function get_wisher_id_by_name($name) {

    $query = "SELECT id FROM wishers WHERE name = :user_bv";
    $stid = oci_parse($this-&gt;con, $query);

    oci_bind_by_name($stid, ':user_bv', $name);
    oci_execute($stid);

    //Because user is a unique value I only expect one row
    $row = oci_fetch_array($stid, OCI_ASSOC);

    if ($row) {
      return $row["ID"];
    } else {
      return null;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Блок кода выполняет запрос  <code>SELECT ID FROM wishers WHERE name = [переменная для имени пожелания]</code> . Результат запроса - массив идентификаторов из записей, соответствующих запросу. Если массив не пустой, это по умолчанию означает, что он содержит один элемент, поскольку при создании таблицы имя поля было определено как UNIQUE. В этом случае функция возвращает первый элемент массива  <code>$result</code>  (элемент под номером ноль). Если массив пуст, функция возвращает значение "null".</p>
</div>
<div class="paragraph">
<p><strong>Примечание к безопасности.</strong> Для базы данных MySQL строка  <code>$name </code>  используется с с escape-символом для предотвращения атак SQL-инъекций. См. <a href="http://en.wikipedia.org/wiki/SQL_injection">статью энциклопедии Wikipedia о введении SQL +] и link:http://us3.php.net/mysql_real_escape_string[+документацию mysql_real_escape_string</a>. Несмотря на то, что в контексте этого руководства риск возникновения опасных атак внедрения SQL маловероятен, рекомендуется исключить из участия в запросах MySQL такие строки, которые могли бы быть подвержены подобной атаке. База данных Oracle избегает данной проблемы, используя связанные переменные.</p>
</div>
</div>
<div class="sect2">
<h3 id="getWishesByID">Функция get_wishes_by_wisher_id</h3>
<div class="paragraph">
<p>Эта функция возвращает зарегистрированные пожелания пользователя, и для ее выполнения в качестве входного параметра требуется идентификатор пользователя.</p>
</div>
<div class="paragraph">
<p>Введите следующий блок кода:</p>
</div>
<div class="paragraph">
<p><strong>Для базы данных MySQL</strong></p>
</div>
<div class="paragraph">
<p>[[source,php]</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public function get_wishes_by_wisher_id($wisherID) {
  return $this-&gt;query("SELECT id, description, due_date FROM wishes WHERE wisher_id=" . $wisherID);
}</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Для базы данных Oracle</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">public function get_wishes_by_wisher_id($wisherID) {

  $query = "SELECT id, description, due_date FROM wishes WHERE wisher_id = :id_bv";
  $stid = oci_parse($this-&gt;con, $query);

  oci_bind_by_name($stid, ":id_bv", $wisherID);
  oci_execute($stid);

  return $stid;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Блок кода выполняет запрос  <code>"SELECT id, description, due_date FROM wishes WHERE wisherID=" . $wisherID</code>  и возвращает набор результатов, который является массивом записей, соответствующих запросу. (База данных Oracle использует связанную переменную для повышения производительности базы данных и уровня безопасности). Выделение выполняется с помощью wisherID, который является внешним ключом для таблицы  <code>wishes</code> .</p>
</div>
<div class="paragraph">
<p><strong>Примечание.</strong> Значение  <code>идентификатора</code>  не требуется до занятия 7.</p>
</div>
</div>
<div class="sect2">
<h3 id="createWisher">Функция create_wisher</h3>
<div class="paragraph">
<p>Функция создает новую запись в таблице "Wishers". Эта функция не возвращает каких-либо данных, и в качестве входных параметров для ее выполнения требуется имя и пароль нового пользователя.</p>
</div>
<div class="paragraph">
<p>Введите следующий блок кода:</p>
</div>
<div class="paragraph">
<p><strong>Для базы данных MySQL</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">public function create_wisher ($name, $password) {

  $name = $this-&gt;real_escape_string($name);
  $password = $this-&gt;real_escape_string($password);

  return $this-&gt;query("INSERT INTO wishers (name, password) VALUES ('" . $name . "', '" . $password . "')");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Для базы данных Oracle</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">public function create_wisher($name, $password) {

  $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
  $stid = oci_parse($this-&gt;con, $query);

  oci_bind_by_name($stid, ':user_bv', $name);
  oci_bind_by_name($stid, ':pwd_bv', $password);
  oci_execute($stid);

  return $stid;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Блок кода выполняет запрос  <code>"INSERT wishers (Name, Password) VALUES ([переменные представляющие имя и пароль нового пожелания])</code> . При выполнении запроса добавляется новая запись в таблицу "Wishers" с полями "name" и "password", заполненными значениями  <code>$name</code>  и  <code>$password</code>  соответственно.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="refactoring">Реорганизация кода приложения</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Теперь при наличии отдельного класса для работы с базой данных дублированные блоки можно заменить вызовами соответствующих функций из этого класса. Это помогает в дальнейшем избежать ошибок и противоречий в написании кода. Усовершенствование кода, не оказывающее влияния на функциональные возможности, называется "реорганизацией".</p>
</div>
<div class="sect2">
<h3 id="refactoringWishlistFile">Реорганизация файла wishlist.php</h3>
<div class="paragraph">
<p>Начнем с файла wishlist.php, поскольку он небольшой и дает возможность представить оптимизацию более иллюстративно.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>В верхней части блока &lt;? php? &gt; введите следующую строку, делающую возможным использование файла  <code>db.php</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Замените код, который подключается к базе данных и получает идентификатор пожелания, вызовом функции  <code>get_wisher_id_by_name</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Для <strong>базы данных MySQL</strong> вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

 $con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
  exit('Connect Error (' . mysqli_connect_errno() . ') '
          . mysqli_connect_error());
}
//set the default client character set
mysqli_set_charset($con, 'utf-8');

mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_GET['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='" . $user . "'");
if (mysqli_num_rows($wisher) &lt; 1) {
  exit("The person " . $_GET['user'] . " is not found. Please check the spelling and try again");
}
$row = mysqli_fetch_row($wisher);
$wisherID = $row[0];
mysqli_free_result($wisher);

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_GET["user"]);

if (!$wisherID) {
  exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для *базы данных Oracle * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

$con = oci_connect("phpuser", "phpuserpw", "localhost/XE");
if (!$con) {
  $m = oci_error();
  echo $m['message'], "\n";
  exit;
}
$query = "SELECT ID FROM wishers WHERE name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_GET['user'];

oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);

//Because user is a unique value I only expect one row
$row = oci_fetch_array($stid, OCI_ASSOC);
if (!$row) {
  echo("The person " . $user . " is not found. Please check the spelling and try again" );
  exit;
}
$wisherID = $row['ID'];

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_GET["user"]);

if (!$wisherID) {
  exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Новый код сначала вызывает функцию  <code>getInstance</code>  в WishDB. Функция  <code>getInstance</code>  возвращает экземпляр WishDB, а код вызывает функцию  <code>get_wisher_id_by_name</code>  в пределах данного экземпляра. Если требуемое пожелание в базе данных не найдено, код завершает процесс и отображает сообщение об ошибке.</p>
</div>
<div class="paragraph">
<p>Для открытия подключения к базе данных наличие кода не является необходимым. Открытие подключения выполняется конструктором класса WishDB. Если имя и/или пароль изменяются, необходимо обновить только соответствующие переменные класса WishDB.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Замените код, который получает пожелания для автора пожеланий, идентифицированного с помощью кода, кодом, который вызывает функцию  <code>get_wishes_by_wisher_id</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Для *базы данных MySQL * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

$result = mysqli_query($con, "SELECT description, due_date FROM wishes WHERE wisher_id=" . $wisherID);

// to replace

$result = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для *базы данных Oracle * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

$query = "SELECT description, due_date FROM wishes WHERE wisher_id = :id_bv";
$stid = oci_parse($con, $query);
oci_bind_by_name($stid, ":id_bv", $wisherID);
oci_execute($stid);

// to replace

$stid = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Удалите строку, которая закрывает подключение к базе данных.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// For MYSQL database
mysqli_close($con);

// For Oracle database
oci_close($con);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Код не нужен, потому что подключение к базе данных автоматически закрывается при уничтожении объекта WishDB. Однако рекомендуем сохранять код, освобождающий ресурс. Вам необходимо освободить все ресурсы, которые используют подключение, чтобы убедиться в том, что оно закрыто, даже при вызове функции  <code>close</code>  или уничтожении экземпляра с подключением к базе данных.</p>
</div>
</div>
<div class="sect2">
<h3 id="refactoringCreateNewWisher">Реорганизация файла createNewWisher.php</h3>
<div class="paragraph">
<p>Реорганизация не оказывает воздействия на форму ввода HTML или код для вывода на экран соответствующих сообщений об ошибках.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>В верхней части блока &lt;? php? &gt; введите следующий код, делающий возможным использование файла  <code>db.php</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Удалите подтверждения подключения к базе данных ( <code>$dbHost</code>  и пр.). Теперь они находятся в <code>db.php</code> .</p>
</li>
<li>
<p>Замените код, который подключается к базе данных и получает идентификатор пожелания, вызовом функции  <code>get_wisher_id_by_name</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Для *базы данных MySQL * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

$con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
  exit('Connect Error (' . mysqli_connect_errno() . ') '
          . mysqli_connect_error());
}
//set the default client character set
mysqli_set_charset($con, 'utf-8');

/** Check whether a user whose name matches the "user" field already exists */
mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_POST['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='".$user."'");
$wisherIDnum=mysqli_num_rows($wisher);
if ($wisherIDnum) {
  $userNameIsUnique = false;
}

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);

if ($wisherID) {
  $userNameIsUnique = false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для *базы данных Oracle * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

$con = oci_connect("phpuser", "phpuserpw", "localhost/XE", "AL32UTF8");
if (!$con) {
  $m = oci_error();
  exit('Connect Error ' . $m['message']);
}
$query = "SELECT id FROM wishers WHERE name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_POST['user'];

oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);

//Each user name should be unique. Check if the submitted user already exists.
$row = oci_fetch_array($stid, OCI_ASSOC);
if ($row) {
  $userNameIsUnique = false;
}

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);
if ($wisherID) {
  $userNameIsUnique = false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Объект  <code>WishDB</code>  существует до тех пор, пока обрабатывается текущая страница. Если обработка завершена или прервана, этот объект уничтожается. Код для открытия подключения к базе данных не является необходимым, поскольку подключение выполняется посредством функции WishDB. Код для закрытия подключения также не является необходимым, поскольку подключение будет закрыто сразу же после уничтожения объекта  <code>WishDB</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Замените код, который вставляет новых авторов пожеланий в базу данных, кодом, который вызывает функцию  <code>create_wisher</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Для *базы данных MySQL * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {
  $password = mysqli_real_escape_string($con, $_POST['password']);
  mysqli_select_db($con, "wishlist");
  mysqli_query($con, "INSERT wishers (name, password) VALUES ('" . $user . "', '" . $password . "')");
  mysqli_free_result($wisher);
  mysqli_close($con);
  header('Location: editWishList.php');
  exit;
}

// to replace

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);

  header('Location: editWishList.php' );
  exit;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для *базы данных Oracle * вы заменяете следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-php" data-lang="php">// to remove

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
  $stid = oci_parse($con, $query);
  $pwd = $_POST['password'];
  oci_bind_by_name($stid, ':user_bv', $user);
  oci_bind_by_name($stid, ':pwd_bv', $pwd);
  oci_execute($stid);
  oci_free_statement($stid);
  oci_close($con);
  header('Location: editWishList.php');
  exit;
}

// to replace

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);

  header('Location: editWishList.php' );
  exit;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lessonResultSourceCode">Исходный код приложения на момент завершения текущего урока</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Для пользователей MySQL: щелкните <a href="https://netbeans.org/projects/www/downloads/download/php%252Flesson4.zip">сюда</a> для загрузки исходного кода, отражающего состояние проекта по завершении данного урока.</p>
</div>
<div class="paragraph">
<p>Для пользователей Oracle Database: щелкните <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson4.zip">здесь</a> для загрузки исходного кода, отражающего состояние проекта по завершении данного урока.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Что_дальше">Что дальше?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="wish-list-lesson3.html">&lt;&lt;Предыдущий урок</a></p>
</div>
<div class="paragraph">
<p><a href="wish-list-lesson5.html">Следующий урок &gt;&gt;</a></p>
</div>
<div class="paragraph">
<p><a href="wish-list-tutorial-main-page.html">Назад на главную страницу руководства</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Полезные_ссылки">Полезные ссылки</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Дополнительная информация об использовании классов в PHP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://us3.php.net/manual/en/language.oop5.php">Классы и объекты</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Дополнительная информация о реорганизации кода PHP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.slideshare.net/spriebsch/seven-steps-to-better-php-code-presentation/">Семь действий по усовершенствованию кода PHP</a></p>
</li>
<li>
<p><a href="http://www.dokeos.com/wiki/index.php/Refactoring">Реорганизация PHP</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="/about/contact_form.html?to=3&amp;subject=Feedback:%20PHP%20Wish%20List%20CRUD%204:%20Optimizing%20Code">Отправить отзыв по этому учебному курсу</a></p>
</div>
<div class="paragraph">
<p>Для отправки комментариев и предложений, получения поддержки и новостей о последних разработках, связанных с PHP IDE NetBeans <a href="../../../community/lists/top.html">присоединяйтесь к списку рассылки users@php.netbeans.org</a>.</p>
</div>
<div class="paragraph">
<p><a href="../../trails/php.html">Возврат к учебной карте PHP</a></p>
</div>
</div>
</div>
            
<section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="JIRA" href="https://issues.apache.org/jira/projects/NETBEANS/summary"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        
        <li><a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/php/wish-list-lesson4_ru.asciidoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>

        </div>
        

<div class='grid-container incubator-area' style='margin-top: 64px'>
    <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/">
                <img style="width: 320px" title="Apache Software Foundation" src="/images/asf_logo_wide.svg" />
            </a>
        </div>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/events/current-event.html">
               <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
            </a>
        </div>
    </div>
</div>
<footer>
    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-auto cell">
                
                <h1><a href="/about/index.html">About</a></h1>
                <ul>
                    <li><a href="https://netbeans.apache.org/community/who.html">Who's Who</a></li>
                    <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                    <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                    <li><a href="https://www.apache.org/security/">Security</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/community/index.html">Community</a></h1>
                <ul>
                    <li><a href="/community/mailing-lists.html">Mailing lists</a></li>
                    <li><a href="/community/committer.html">Becoming a committer</a></li>
                    <li><a href="/community/events.html">NetBeans Events</a></li>
                    <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/participate/index.html">Participate</a></h1>
                <ul>
                    <li><a href="/participate/submit-pr.html">Submitting Pull Requests</a></li>
                    <li><a href="/participate/report-issue.html">Reporting Issues</a></li>
                    <li><a href="/participate/index.html#documentation">Improving the documentation</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/help/index.html">Get Help</a></h1>
                <ul>
                    <li><a href="/help/index.html#documentation">Documentation</a></li>
                    <li><a href="/wiki/index.asciidoc">Wiki</a></li>
                    <li><a href="/help/index.html#support">Community Support</a></li>
                    <li><a href="/help/commercial-support.html">Commercial Support</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/download/nb110/nb110.html">Download</a></h1>
                <ul>
                    <li><a href="/download/index.html">Releases</a></li>                    
                    <li><a href="/plugins/index.html">Plugins</a></li>
                    <li><a href="/download/index.html#source">Building from source</a></li>
                    <li><a href="/download/index.html#previous">Previous releases</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>
<div class='footer-disclaimer'>
    <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2020 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
            <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
            <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
        </div>
        
    </div>
</div>



        <script src="/js/vendor/jquery-3.2.1.min.js"></script>
        <script src="/js/vendor/what-input.js"></script>
        <script src="/js/vendor/jquery.colorbox-min.js"></script>
        <script src="/js/vendor/foundation.min.js"></script>
        <script src="/js/netbeans.js"></script>
        <script>
            
            $(function(){ $(document).foundation(); });
        </script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        <script>
         $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); }); 
        </script>
        
    </body>
</html>
