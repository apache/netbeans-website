
<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
    
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Criando uma Aplicação Orientada pelo Banco de Dados com o PHP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Criando uma Aplicação Orientada pelo Banco de Dados com o PHP - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, Criando uma Aplicação Orientada pelo Banco de Dados com o PHP">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
     <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css"> 
    <link rel="stylesheet" href="/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet"> 
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
</head>


    <body>
        

<div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="/"><img src='/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans (incubating)</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <a href="/community/index.html">Community</a> </li>
            <li> <a href="/participate/index.html">Participate</a> </li>
            <li> <a href="https://blogs.apache.org/netbeans/">Blog</a></li>
            <li> <a href="/help/index.html">Get Help</a> </li>
            <li> <a href="/plugins/index.html">Plugins</a> </li>
            <li> <a href="/download/nb100/nb100.html">Download</a> </li>
        </ul>
    </div>
</div>


        
<!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Just released!</div>
            <h1 syle='font-size: 2rem'>Apache NetBeans 10.0</h1>
            <p><a class="button success" href="/download/nb100/nb100.html">Read more</a></p>
        </div>
    </div>
</section>

        <div class='grid-container main-content tutorial'>
            <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel0">
<li><a href="#_lição_4_otimizando_o_código_com_classes_e_objetos">Lição 4: Otimizando o Código com Classes e Objetos</a>
<ul class="sectlevel1">
<li><a href="#_código_fonte_da_aplicação_da_lição_anterior">Código-fonte da Aplicação da Lição Anterior</a></li>
<li><a href="#_criando_o_arquivo_db_php">Criando o Arquivo db.php</a></li>
<li><a href="#_criando_a_classe_wishdb">Criando a Classe WishDB</a></li>
<li><a href="#instantiate-wishdb">Instanciando a classe WishDB</a></li>
<li><a href="#wishdb-constructor">Adicionando um Construtor à Classe WishDB</a></li>
<li><a href="#_funções_da_classe_wishdb">Funções da Classe WishDB</a>
<ul class="sectlevel2">
<li><a href="#_função_get_wisher_id_by_name">Função get_wisher_id_by_name</a></li>
<li><a href="#_função_get_wishes_by_wisher_id">Função get_wishes_by_wisher_id</a></li>
<li><a href="#_função_create_wisher">Função create_wisher</a></li>
</ul>
</li>
<li><a href="#_refatorando_o_código_da_sua_aplicação">Refatorando o Código da Sua Aplicação</a>
<ul class="sectlevel2">
<li><a href="#_refatorando_o_arquivo_wishlist_php">Refatorando o Arquivo wishlist.php</a></li>
<li><a href="#"> </a></li>
<li><a href="#_refatorando_o_arquivo_createnewwisher_php">Refatorando o Arquivo createNewWisher.php</a></li>
</ul>
</li>
<li><a href="#_o_código_fonte_da_aplicação_após_a_lição_atual_está_concluído">O código-fonte da Aplicação após a Lição Atual está Concluído</a></li>
<li><a href="#_próximas_etapas">Próximas Etapas</a></li>
<li><a href="#_links_Úteis">Links Úteis</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="_lição_4_otimizando_o_código_com_classes_e_objetos" class="sect0">Lição 4: Otimizando o Código com Classes e Objetos</h1>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="wish-list-tutorial-main-page.html">Criando uma Aplicação Orientada pelo Banco de Dados com o PHP - Página Principal</a>
2.
Criando o Banco de Dados</p>
</li>
<li>
<p><a href="wish-list-lesson1.html">Criando um Banco de Dados MySQL</a></p>
</li>
<li>
<p><a href="wish-list-oracle-lesson1.html">Criando Tabelas do Banco de Dados Oracle</a></p>
</li>
<li>
<p><a href="wish-list-lesson2.html">Projetando a Aplicação. Lendo o Banco de Dados</a></p>
</li>
<li>
<p><a href="wish-list-lesson3.html">Criando um Novo Usuário da Aplicação</a>
5.
<strong>&#8658; Otimizando o Código</strong></p>
</li>
<li>
<p><a href="wish-list-lesson5.html">Adicionando Segurança. Implementando o Log-in de Usuário da Aplicação</a></p>
</li>
<li>
<p><a href="wish-list-lesson6.html">Adicionando um Novo Desejo ao Banco de Dados</a></p>
</li>
<li>
<p><a href="wish-list-lesson7.html">Atualizando e Deletando Entradas no Banco de Dados</a></p>
</li>
<li>
<p><a href="wish-list-lesson8.html">Melhorando a Aparência da Aplicação Usando a Tecnologia CSS</a></p>
</li>
<li>
<p><a href="wish-list-lesson9.html">Implantando a Aplicação em um Servidor Web Remoto</a></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/netbeans-stamp-80-74-73.png" alt="netbeans stamp 80 74 73">
</div>
<div class="title">Figure 1. O conteúdo desta página se aplica ao NetBeans IDE 7.2, 7.3, 7.4 e 8.0</div>
</div>
<div class="paragraph">
<p>Nesta lição, você otimizará o código para facilitar sua manutenção no futuro. Isso afeta os arquivos  <code>createNewWisher.php</code>  e  <code>wishlist.php</code> . Além disso, um novo arquivo chamado  <code>db.php</code>  é criado.</p>
</div>
<div class="paragraph">
<p>O código do sua aplicação contém vários blocos de código semelhantes com consultas ao banco de dados. Para facilitar a leitura e a manutenção do código no futuro, você pode extrair esses blocos, implementá-los como funções de uma classe separada chamada  <code>WishDB</code>  e colocar  <code>WishDB</code>  em  <code>db.php</code> . Depois disso, você pode incluir o arquivo  <code>db.php</code>  em qualquer arquivo PHP e usar qualquer <a href="#includedFunctions">função de WishDB</a> sem duplicação de código. Essa abordagem garante que quaisquer alterações em consultas ou funções serão feitas em um único local e você não terá de fazer parsing do código inteiro da aplicação.</p>
</div>
<div class="paragraph">
<p>Ao usar uma função de WishDB, você não altera o valor de quaisquer variáveis de WishDB. Em vez disso, use a classe WishDB como um plano gráfico para criar um objeto de WishDB, e altere os valores das variáveis nesse objeto. Quando você finaliza o trabalho com esse objeto, ele é destruído. Como os valores da classe WishDB nunca são alterados, você pode reutilizar a classe por um número ilimitado de vezes. Em alguns casos, talvez você queira ter várias instâncias de uma classe ao mesmo tempo, e em outros casos, talvez você prefira uma classe "única", onde você possui apenas uma instância de cada vez. O WishDB neste tutorial é uma classe única.</p>
</div>
<div class="paragraph">
<p>Observe que o termo para criar um objeto de uma classe é "instanciar" essa classe, e que outra palavra para um objeto é uma "instância" de uma classe. O termo geral para programar com classes e objetos é "programação orientada por objeto" ou OOP. O PHP 5 usa um modelo OOP sofisticado. Consulte <a href="http://us3.php.net/zend-engine-2.php">php.net</a> para obter mais informações.</p>
</div>
<div class="paragraph">
<p>Neste tutorial, a funcionalidade de chamada do banco de dados é movida de arquivos PHP individuais para classes WishDB. Usuários do MySQL também podem substituir a chamada  <code>mysqli</code>  de estilo de procedimento por chamadas orientadas por objetos. Isso é para manter com o novo projeto orientado por objetos da aplicação</p>
</div>
<div class="paragraph">
<p>O documento atual é uma parte do tutorial Criando uma Aplicação CRUD no NetBeans IDE para PHP.</p>
</div>
<div class="sect1">
<h2 id="_código_fonte_da_aplicação_da_lição_anterior">Código-fonte da Aplicação da Lição Anterior</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Usuários MySQL: clique <a href="https://netbeans.org/files/documents/4/1929/lesson3.zip">aqui</a> para fazer o download do código-fonte que reflete o estado do projeto depois que a lição anterior estiver concluída.</p>
</div>
<div class="paragraph">
<p>Usuários do Banco de Dados Oracle: clique <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson3.zip">aqui</a> para fazer o download do código-fonte que reflete o estado do projeto depois que a lição anterior estiver concluída.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_criando_o_arquivo_db_php">Criando o Arquivo db.php</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Crie uma nova subpasta na pasta Códigos-fonte. Nomeie a pasta Inclusão. Crie uma nova pasta nomeada db.php e coloque em Inclusão. Depois disso, é possível adicionar mais arquivos para essa pasta que será incluída em outros arquivos PHP.</p>
</div>
<div class="paragraph">
<p><strong>Para criar o db.php em uma nova pasta:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Clique com o botão direito do mouse no nó Código-fonte e selecione Novo &gt; Pasta no menu de contexto. A caixa de diálogo Nova Pasta é aberta.</p>
</li>
<li>
<p>No campo Nome da Pasta, digite Inclusão. Em seguida, clique em Finalizar.</p>
</li>
<li>
<p>Clique com o botão direito do mouse no nó Inclusão e selecione Novo &gt; Arquivo PHP no menu de contexto. A caixa de diálogo Novo Arquivo PHP é aberta.</p>
</li>
<li>
<p>No campo Nome do Arquivo, digite db. Em seguida, clique em Finalizar.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_criando_a_classe_wishdb">Criando a Classe WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para criar a classe WishDB, você precisa inicializar as variáveis da classe e implementar um construtor da classe. Usuários MySQL, observem a classe WishDB <em>extends</em>  <code>mysqli</code> . Isso significa que o WishDB <em>herda</em> a função e outras características da classe mysqli PHP. A importância disso é mostrada ao adicionar as funções  <code>mysqli</code>  à classe.</p>
</div>
<div class="paragraph">
<p>Abra o arquivo db.php e crie a classe WishDB. Na classe, declare variáveis de configuração de banco de dados para armazenar o nome e a senha do proprietário do banco de dados (usuário), o nome e o host do banco de dados. Todas essas declarações de variável são "privadas", o que significa que os valores iniciais nas declarações não podem ser acessados de fora da classe WishDB (Consulte <a href="http://us3.php.net/manual/en/language.oop5.visibility.php">php.net</a>). Declare também a variável _ static_  <code>$instance</code>  privada, que armazena a instância do WishDB. A palavra-chave “estática” significa que a função na classe pode acessar a variável mesmo quando não há instância da classe.</p>
</div>
<div class="paragraph">
<p><strong>Para o Banco de Dados MySQL:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class WishDB extends mysqli {


    // single instance of self shared among all instances
    private static $instance = null;


    // db connection config vars
    private $user = "phpuser";
    private $pass = "phpuserpw";
    private $dbName = "wishlist";
    private $dbHost = "localhost";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>*Para o Banco de Dados Oracle: *</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class WishDB {// single instance of self shared among all instances
private static $instance = null;// db connection config vars
private $user = "phpuser";
private $pass = "phpuserpw";
private $dbName = "wishlist";
private $dbHost = "localhost/XE";
private $con = null;}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instantiate-wishdb">Instanciando a classe WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para outros arquivos PHP usarem funções na classe WishDB, esses arquivos PHP precisam chamar uma função que crie um objeto ("instantiates") da classe WishDB. WishDB é designado como uma <a href="http://www.phpclasses.org/browse/package/1151.html">classe única</a>, o que significa que somente uma instância da classe existe de cada vez. Portanto, é útil evitar qualquer instanciação externa de WishDB, o que poderia criar instâncias duplas.</p>
</div>
<div class="paragraph">
<p>Dentro da classe WishDB, digite ou cole o seguinte código:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java"> //This method must be static, and must return an instance of the object if the object
 //does not already exist.
 public static function getInstance() {
   if (!self::$instance instanceof self) {
     self::$instance = new self;
   }
   return self::$instance;
 }

 // The clone and wakeup methods prevents external instantiation of copies of the Singleton class,
 // thus eliminating the possibility of duplicate objects.
 public function __clone() {
   trigger_error('Clone is not allowed.', E_USER_ERROR);
 }
 public function __wakeup() {
   trigger_error('Deserializing is not allowed.', E_USER_ERROR);
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A função  <code>getInstance</code>  é "pública" e "estática." "Pública" significa que ela pode ser acessada publicamente de fora da classe. "Estática" significa que a função está disponível mesmo quando a classe não tiver sido instanciada. Como a função  <code>getInstance</code>  é chamada para instanciar a classe, ela deve ser estática. Observe que essa função acessa a variável <code>$instance</code>  estática e ajusta os valores como a instância da classe.</p>
</div>
<div class="paragraph">
<p>Os dois-pontos duplos (::), chamados de Operador de Resolução de Escopo, e a palavra-chave  <code>self</code>  são usados para acessar funções estáticas.  <code>Self</code>  é usado na definição da classe para se referir à classe em si. Quando os dois-pontos duplos forem usados fora da definição da classe, o nome da classe será usado em vez de  <code>self</code> . Consulte <a href="http://us3.php.net/manual/en/language.oop5.paamayim-nekudotayim.php">php.net no Operador de Resolução de Escopo</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wishdb-constructor">Adicionando um Construtor à Classe WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Uma classe pode conter um método especial conhecido como 'construtor', que é processado automaticamente sempre que uma instância dessa classe é criada. Neste tutorial, você adiciona um construtor ao WishDB que se conecta ao banco de dados sempre que WishDB é instanciado.</p>
</div>
<div class="paragraph">
<p>Adicione o código seguinte ao WishDB:</p>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados MySQL:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// private constructorprivate function __construct() {parent::__construct($this-&gt;dbHost, $this-&gt;user, $this-&gt;pass, $this-&gt;dbName);if (mysqli_connect_error()) {exit('Connect Error (' . mysqli_connect_errno() . ') '. mysqli_connect_error());}parent::set_charset('utf-8');}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados Oracle:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">// private constructor
private function __construct() {
    $this-&gt;con = oci_connect($this-&gt;user, $this-&gt;pass, $this-&gt;dbHost);
    if (!$this-&gt;con) {
        $m = oci_error();
        echo $m['message'], "\n";
        exit;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe o uso da pseudovariável  <code>$this</code>  em vez das variáveis  <code>$con</code> ,  <code>$dbHost</code> ,  <code>$user</code>  ou  <code>$pass</code> . A pseudovariável  <code>$this</code>  é usada quando um método é chamado de dentro do contexto de um objeto. Ela se refere ao valor de uma variável nesse objeto.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_funções_da_classe_wishdb">Funções da Classe WishDB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nesta lição, você implementará as seguintes funções da classe WishDB:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#getIDByName">get_wisher_id_by_name</a> para recuperar o id de um wisher com base em seu nome</p>
</li>
<li>
<p><a href="#getWishesByID">get_wishes_by_wisher_id</a> para recuperar uma lista de desejos do wisher com um id específico</p>
</li>
<li>
<p><a href="#createWisher">create_wisher</a> para adicionar um novo registro de wisher aos wishers da tabela</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_função_get_wisher_id_by_name">Função get_wisher_id_by_name</h3>
<div class="paragraph">
<p>A função requer o nome de um wisher como parâmetro de entrada e retorna o wisher id.</p>
</div>
<div class="paragraph">
<p>Digite ou cole a seguinte função na classe WishDB, depois da função WishDB:</p>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados MySQL:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function get_wisher_id_by_name($name) {$name = $this-&gt;real_escape_string($name);$wisher = $this-&gt;query("SELECT id FROM wishers WHERE name = '". $name . "'");
    if ($wisher-&gt;num_rows &gt; 0){$row = $wisher-&gt;fetch_row();return $row[0];} elsereturn null;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados Oracle:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function get_wisher_id_by_name($name) {
    $query = "SELECT id FROM wishers WHERE name = :user_bv";
    $stid = oci_parse($this-&gt;con, $query);
    oci_bind_by_name($stid, ':user_bv', $name);
    oci_execute($stid);
//Because user is a unique value I only expect one row
    $row = oci_fetch_array($stid, OCI_ASSOC);if ($row) return $row["ID"];elsereturn null;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>O bloco de código executa a consulta  <code>SELECT ID FROM wishers WHERE name = [variável para o nome do wisher]</code> . O resultado da consulta é um array de IDs dos registros que satisfazem a consulta. Se o array não estiver vazio, isso significa automaticamente que ele contém um elemento, porque o nome do campo é especificado como UNIQUE durante a criação da tabela. Nesse caso, a função retorna o primeiro elemento do array  <code>$result</code>  (o elemento com zero). Se o array estiver vazio, a função retornará nula.</p>
</div>
<div class="paragraph">
<p><strong>Observação sobre Segurança:</strong> Para o banco de dados MySQL, a string  <code>$name</code>  tem escape para evitar os ataques de injeção SQL. Consulte <a href="http://en.wikipedia.org/wiki/SQL_injection">Wikipedia sobre injeções SQL</a> e a documentação mysql_real_escape_string. Embora no contexto deste tutorial você não esteja correndo o risco de injeções SQL prejudiciais, recomendamos escapar as strings nas consultas MySQL que estariam correndo risco de tal ataque. O banco de dados Oracle evita esse problema usando variáveis de ligação.</p>
</div>
</div>
<div class="sect2">
<h3 id="_função_get_wishes_by_wisher_id">Função get_wishes_by_wisher_id</h3>
<div class="paragraph">
<p>A função exige o id de um wisher como o parâmetro de entrada e retorna os desejos registrados para o wisher.</p>
</div>
<div class="paragraph">
<p>Indique o seguinte bloco de código:</p>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados MySQL:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function get_wishes_by_wisher_id($wisherID) {return $this-&gt;query("SELECT id, description, due_date FROM wishes WHERE wisher_id=" . $wisherID);}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados Oracle:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function get_wishes_by_wisher_id($wisherID) {
    $query = "SELECT id, description, due_date FROM wishes WHERE wisher_id = :id_bv";
    $stid = oci_parse($this-&gt;con, $query);
    oci_bind_by_name($stid, ":id_bv", $wisherID);
    oci_execute($stid);
    return $stid;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>O bloco de código executa a consulta  <code>"SELECT id, description, due_date FROM wishes WHERE wisherID=" . $wisherID</code>  e retorna um conjunto de resultados que é um array de registros que atende à consulta. (O banco de dados Oracle usa variáveis de ligação para o desempenho do banco de dados e motivos de segurança). A seleção é realizada pelo wisherID, que é a chave estrangeira dos  <code>desejos</code>  da tabela.</p>
</div>
<div class="paragraph">
<p><strong>Observação:</strong> o valor <code>id</code>  não é necessário até a Lição 7.</p>
</div>
</div>
<div class="sect2">
<h3 id="_função_create_wisher">Função create_wisher</h3>
<div class="paragraph">
<p>A função cria um novo registro na tabela de wishers. A função requer o nome e a senha de um novo wisher como os parâmetros de entrada e não retorna dados.</p>
</div>
<div class="paragraph">
<p>Indique o seguinte bloco de código:</p>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados MySQL:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function create_wisher ($name, $password){
    $name = $this-&gt;real_escape_string($name);$password = $this-&gt;real_escape_string($password);$this-&gt;query("INSERT INTO wishers (name, password) VALUES ('" . $name . "', '" . $password . "')");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Para o banco de dados Oracle:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public function create_wisher($name, $password) {
    $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
    $stid = oci_parse($this-&gt;con, $query);
    oci_bind_by_name($stid, ':user_bv', $name);
    oci_bind_by_name($stid, ':pwd_bv', $password);
    oci_execute($stid);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>O bloco de código executa a consulta  <code>"INSERT wishers (Name, Password) VALUES ([variáveis representando o nome e a senha do novo wisher]).</code>  A consulta adiciona um novo registro à tabela "wishers" com os campos "nome" e "senha" preenchidos com os valores de  <code>$name</code>  e  <code>$password</code>  respectivamente.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refatorando_o_código_da_sua_aplicação">Refatorando o Código da Sua Aplicação</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Agora que tem uma classe separada para trabalhar com o banco de dados, você pode substituir blocos duplicados por chamadas para as funções relevantes desta classe. Isso ajudará a evitar erros ortográficos e inconsistência no futuro. A otimização de código que não afeta a funcionalidade é chamada de refatoração.</p>
</div>
<div class="sect2">
<h3 id="_refatorando_o_arquivo_wishlist_php">Refatorando o Arquivo wishlist.php</h3>
<div class="paragraph">
<p>Comece com o arquivo wishlist.php porque ele é pequeno e as melhorias serão mais ilustrativas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na parte superior do bloco &lt;?php ?&gt; , insira a linha seguinte para permitir o uso do arquivo  <code>db.php</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Substitua o código que estabelece conexão com o banco de dados e que obtém o wisher ID por uma chamada para a função  <code>get_wisher_id_by_name</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados MySQL</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#$con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
    exit('Connect Error (' . mysqli_connect_errno() . ') '
            . mysqli_connect_error());
}
mysqli_set_charset($con, 'utf-8');</p>
</div>
<div class="paragraph">
<p>mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_GET['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='" . $user . "'");
if (mysqli_num_rows($wisher) &lt; 1) {
    exit("The person " . $_GET['user'] . " is not found. Please check the spelling and try again");
}
$row = mysqli_fetch_row($wisher);$wisherID = $row[0];
mysqli_free_result($wisher);#</p>
</div>
<div class="paragraph">
<p><strong>$wisherID = WishDB::getInstance()&#8594;get_wisher_id_by_name($_GET["user"]);
if (!$wisherID) {
    exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}</strong></p>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados Oracle</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#$con = oci_connect("phpuser", "phpuserpw", "localhost/XE", "AL32UTF8");
if (!$con) {
   $m = oci_error();
   echo $m['message'], "\n";
   exit;
}
$query = "SELECT id FROM wishers WHERE name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_GET["user"];</p>
</div>
<div class="paragraph">
<p>oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);</p>
</div>
<div class="paragraph">
<p>if (!$row) {
    echo("The person " . $user . " is not found. Please check the spelling and try again" );exit;}
$wisherID = $row["ID"]; #</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_GET["user"]);
if (!$wisherID) {
    exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}*</code></pre>
</div>
</div>
<div class="paragraph">
<p>O novo código chama primeiro a função  <code>getInstance</code>  no WishDB. O  <code>getInstance</code>  retorna uma instância de WishDB, e o código chama a função  <code>get_wisher_id_by_name</code>  dentro dessa instância. Se a lista de desejos solicitada não for encontrada no banco de dados, o código terminará o processo, e exibirá uma mensagem de erro.</p>
</div>
<div class="paragraph">
<p>Nenhum código é necessário para abrir uma conexão ao banco de dados. A conexão é aberta pelo construtor da classe WishDB. Se o nome e/ou a senha for alterado, você precisará atualizar somente as variáveis relevantes da classe WishDB.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Substitua o código que recebe desejos de um wisher identificado pelo ID com um código que chama a função  <code>get_wishes_by_wisher_id</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados MySQL</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p><span class="line-through">$result = mysqli_query($con, "SELECT description, due_date FROM wishes WHERE wisher_id=". $wisherID);</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*$result = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados Oracle</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p><span class="line-through">$query = "select * from wishes where wisher_id = :id_bv";$stid = oci_parse($con, $query);oci_bind_by_name($stid, ":id_bv", $wisherID);oci_execute($stid);</span></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*$stid = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);*</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remova a linha que fecha a conexão do banco de dados.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java"> [.line-through]#mysqli_close($con);#
                    or
 [.line-through]#oci_close($con);#</code></pre>
</div>
</div>
<div class="paragraph">
<p>O código não é necessário porque a conexão ao banco de dados é automaticamente fechada quando o objeto WishDB é destruído. No entanto, mantenha o código que libera o recurso. É necessário liberar todos os recursos que usam uma conexão para garantir que a conexão seja fechada corretamente, mesmo quando a função  <code>close</code>  é chamada ou se a instância for destruída com a conexão do banco de dados.</p>
</div>
</div>
<div class="sect2">
<h3 id=""> </h3>

</div>
<div class="sect2">
<h3 id="_refatorando_o_arquivo_createnewwisher_php">Refatorando o Arquivo createNewWisher.php</h3>
<div class="paragraph">
<p>A refatoração não afetará o form de entrada HTML ou o código para exibir as mensagens de erro relacionadas.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Na parte superior do bloco &lt;?php ?&gt;, insira o código seguinte para permitir o uso do arquivo  <code>db.php</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete a credencial da conexão do banco de dados ( <code>$dbHost,</code>  etc). Esses estão agora em  <code>db.php.</code> .</p>
</li>
<li>
<p>Substitua o código que estabelece conexão com o banco de dados e que obtém o wisher ID por uma chamada para a função  <code>get_wisher_id_by_name</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados MySQL</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#
$con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
    exit('Connect Error (' . mysqli_connect_errno() . ') '
            . mysqli_connect_error());
}
mysqli_set_charset($con, 'utf-8');</p>
</div>
<div class="paragraph">
<p>/** Check whether a user whose name matches the "user" field already exists */
mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_POST['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='".$user."'");
$wisherIDnum=mysqli_num_rows($wisher);
if ($wisherIDnum) {
   $userNameIsUnique = false;
}#</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);
if ($wisherID) {
$userNameIsUnique = false;
}*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados Oracle</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#
$con = oci_connect("phpuser", "phpuserpw", "localhost");
if (!$con) {
    $m = oci_error();
    echo $m['message'], "\n";
    exit;
}
$query = "select ID from wishers where name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_POST['user'];
$wisherID = null;
oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);</p>
</div>
<div class="paragraph">
<p>$row = oci_fetch_array($stid, OCI_ASSOC);if ($row) {$wisherID = $row["ID"]; }if ($wisherID != null) {$userNameIsUnique = false;}#</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);
if ($wisherID) {
$userNameIsUnique = false;
}*</code></pre>
</div>
</div>
<div class="paragraph">
<p>O objeto  <code>WishDB</code>  existe enquanto a página atual estiver sendo processada. Ele é destruído depois que o processamento é concluído ou interrompido. O código para abrir uma conexão ao banco de dados não é necessário porque isso é feito pela função WishDB. O código para fechar a conexão não é necessário porque a conexão é fechada assim que o objeto  <code>WishDB</code>  é destruído.
4. Substitua o código que insere novos desejos no banco de dados pelo código que chama a função  <code>create_wisher</code> .</p>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados MySQL</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {
    $password = mysqli_real_escape_string($con, $_POST["password"]);mysqli_select_db($con, "wishlist");mysqli_query($con, "INSERT wishers (name, password) VALUES ('" . $user . "', '" . $password . "')");mysqli_free_result($wisher);mysqli_close($con);header('Location: editWishList.php');exit;}
                    #</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">                *if (!$userIsEmpty &amp;amp;&amp;amp; $userNameIsUnique &amp;amp;&amp;amp; !$passwordIsEmpty &amp;amp;&amp;amp; !$password2IsEmpty &amp;amp;&amp;amp; $passwordIsValid) {
WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);
header('Location: editWishList.php' );
exit;
}*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para o <strong>banco de dados Oracle</strong>, o código a ser substituído é:</p>
</div>
<div class="paragraph">
<p>[.line-through]#
if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {
    $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
    $stid = oci_parse($con, $query);
    $pwd = $_POST['password'];
    oci_bind_by_name($stid, ':user_bv', $user);
    oci_bind_by_name($stid, ':pwd_bv', $pwd);
    oci_execute($stid);
    oci_close($con);
    header('Location: editWishList.php');
    exit;
}#</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">*if (!$userIsEmpty &amp;amp;&amp;amp; $userNameIsUnique &amp;amp;&amp;amp; !$passwordIsEmpty &amp;amp;&amp;amp; !$password2IsEmpty &amp;amp;&amp;amp; $passwordIsValid) {
WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);
header('Location: editWishList.php' );
exit;
}*</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_o_código_fonte_da_aplicação_após_a_lição_atual_está_concluído">O código-fonte da Aplicação após a Lição Atual está Concluído</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Usuários do MySQL: clique <a href="https://netbeans.org/projects/www/downloads/download/php%252Flesson4.zip">aqui</a> para fazer o download do código-fonte que reflete o estado do projeto depois que a lição estiver concluída.</p>
</div>
<div class="paragraph">
<p>Usuários do banco de dados Oracle: clique <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson4.zip">aqui</a> para fazer o download do código-fonte que reflete o estado do projeto depois que a lição for concluída.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_próximas_etapas">Próximas Etapas</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="wish-list-lesson3.html">&lt;&lt; Lição anterior</a></p>
</div>
<div class="paragraph">
<p><a href="wish-list-lesson5.html">Próxima lição &gt;&gt;</a></p>
</div>
<div class="paragraph">
<p><a href="wish-list-tutorial-main-page.html">Voltar à página principal do Tutorial</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_links_Úteis">Links Úteis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Saiba mais sobre o uso de classes em PHP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://us3.php.net/manual/en/language.oop5.php">Classes e Objetos</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Saiba mais sobre a refatoração de código PHP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.slideshare.net/spriebsch/seven-steps-to-better-php-code-presentation/">Sete Etapas Para Melhorar o Código PHP</a></p>
</li>
<li>
<p><a href="http://www.dokeos.com/wiki/index.php/Refactoring">Refatoração do PHP</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="/about/contact_form.html?to=3&amp;subject=Feedback:%20PHP%20Wish%20List%20CRUD%204:%20Optimizing%20Code">Enviar Feedback neste Tutorial</a></p>
</div>
<div class="paragraph">
<p>Para enviar comentários e sugestões, obter suporte e manter-se informado sobre os desenvolvimentos mais recentes das funcionalidades de desenvolvimento PHP do NetBeans IDE, <a href="../../../community/lists/top.html">junte-se à lista de correspondência users@php.netbeans.org</a>.</p>
</div>
<div class="paragraph">
<p><a href="../../trails/php.html">Voltar à Trilha de Aprendizado PHP</a></p>
</div>
</div>
</div>
            
<section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/incubator-netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="JIRA" href="https://issues.apache.org/jira/projects/NETBEANS/summary"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        
        <li><a href="https://github.com/apache/incubator-netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/php/wish-list-lesson4_pt_BR.asciidoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>

        </div>
        

<div class='grid-container incubator-area' style='margin-top: 64px'>
    <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/">
                <img style="width: 320px" title="Apache Software Foundation" src="/images/asf_logo_wide.svg" />
            </a>
        </div>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/events/current-event.html">
               <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
            </a>
        </div>
    </div>
</div>
<footer>
    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-auto cell">
                
                <h1>About</h1>
                <ul>
                    <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                    <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                    <li><a href="https://www.apache.org/security/">Security</a></li>
                    <li><a href="https://incubator.apache.org/projects/netbeans.html">Incubation Status</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/community/index.html">Community</a></h1>
                <ul>
                    <li><a href="/community/mailing-lists.html">Mailing lists</a></li>
                    <li><a href="/community/committer.html">Becoming a committer</a></li>
                    <li><a href="/community/events.html">NetBeans Events</a></li>
                    <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
                    <li><a href="/community/who.html">Who is who</a></li>
                    <li><a href="/community/nekobean.html">NekoBean</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/participate/index.html">Participate</a></h1>
                <ul>
                    <li><a href="/participate/submit-pr.html">Submitting Pull Requests</a></li>
                    <li><a href="/participate/report-issue.html">Reporting Issues</a></li>
                    <li><a href="/participate/netcat.html">NetCAT - Community Acceptance Testing</a></li>
                    <li><a href="/participate/index.html#documentation">Improving the documentation</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/help/index.html">Get Help</a></h1>
                <ul>
                    <li><a href="/help/index.html#documentation">Documentation</a></li>
                    <li><a href="/help/getting-started.html">Platform videos</a></li>
                    <li><a href="/wiki/index.asciidoc">Wiki</a></li>
                    <li><a href="/help/index.html#support">Community Support</a></li>
                    <li><a href="/help/commercial-support.html">Commercial Support</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/download/nb100/nb100.html">Download</a></h1>
                <ul>
                    <li><a href="/download/index.html#releases">Releases</a></li>
                    <ul>
                        <li><a href="/download/nb100/nb100.html">Apache NetBeans 10.0</a></li>
                        <li><a href="/download/nb90/nb90.html">Apache NetBeans 9.0</a></li>
                    </ul>
                    <li><a href="/plugins/index.html">Plugins</a></li>
                    <li><a href="/download/index.html#source">Building from source</a></li>
                    <li><a href="/download/index.html#previous">Previous releases</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>
<div class='footer-disclaimer'>
    <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2019 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <p><a href="https://incubator.apache.org/" alt="Apache Incubator"><img src='/images/incubator_feather_egg_logo_bw_crop.png' title='Apache Incubator'></img></a></p>
        <div style='max-width: 40em; margin: 0 auto'>
            <p>Apache NetBeans is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
            <p>Apache Incubator, Apache, Apache NetBeans, NetBeans, the Apache feather logo, the Apache NetBeans logo, and the Apache Incubator project logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
            <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
        </div>
        
    </div>
</div>



        <script src="/js/vendor/jquery-3.2.1.min.js"></script>
        <script src="/js/vendor/what-input.js"></script>
        <script src="/js/vendor/jquery.colorbox-min.js"></script>
        <script src="/js/vendor/foundation.min.js"></script>
        <script src="/js/netbeans.js"></script>
        <script>
            
            $(function(){ $(document).foundation(); });
        </script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        <script>
         $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); }); 
        </script>
        
    </body>
</html>
