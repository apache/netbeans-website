
<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>WebアプリケーションでのWebSocket APIの使用</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WebアプリケーションでのWebSocket APIの使用 - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, WebアプリケーションでのWebSocket APIの使用">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css"> 
    <link rel="stylesheet" href="/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="/css/font-open-sans.css" rel="stylesheet">
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
  </head>
  <body>
    

<div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="/"><img src='/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <a href="/community/index.html">Community</a> </li>
            <li> <a href="/participate/index.html">Participate</a> </li>
            <li> <a href="/blogs/index.html">Blog</a></li>
            <li> <a href="/help/index.html">Get Help</a> </li>
            <li> <a href="https://plugins.netbeans.apache.org/">Plugins</a> </li>
            <li> <a href="/download/index.html">Download</a> </li>
        </ul>
    </div>
</div>


    
<!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Latest release</div>
            <h1>Apache NetBeans 18</h1>
            <p><a class="button success" href="/download/nb18/">Download</a></p>
        </div>
    </div>
</section>

    <div class='grid-container main-content tutorial'>
      <h1 class="sect0">WebアプリケーションでのWebSocket APIの使用</h1>
            
            <div class="sectionbody">
              <div class="admonitionblock note">
                <table>
                  <tbody><tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">This tutorial needs a review. 
                     You can <a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/maven-websocketapi_ja.adoc" title="Edit this tutorial in github">edit it in GitHub </a>
                     following these <a href="/kb/docs/contributing.html">contribution guidelines.</a></td>
                  </tr></tbody>
                </table>
              </div>
            </div>
            
      <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_webアプリケーションプロジェクトの作成">Webアプリケーション・プロジェクトの作成</a></li>
<li><a href="#_websocketエンドポイントの作成">WebSocketエンドポイントの作成</a>
<ul class="sectlevel2">
<li><a href="#_エンドポイントの作成">エンドポイントの作成</a></li>
<li><a href="#_websocketセッションの開始">WebSocketセッションの開始</a></li>
<li><a href="#_エンドポイントのテスト">エンドポイントのテスト</a></li>
</ul>
</li>
<li><a href="#_ホワイトボードの作成">ホワイトボードの作成</a>
<ul class="sectlevel2">
<li><a href="#_webページへのキャンバスの追加">Webページへのキャンバスの追加</a></li>
<li><a href="#_pojoの作成">POJOの作成</a></li>
<li><a href="#_座標クラスの作成">座標クラスの作成</a></li>
<li><a href="#_json文字列の生成">JSON文字列の生成</a></li>
<li><a href="#_エンコーダおよびデコーダインタフェースの実装">エンコーダおよびデコーダ・インタフェースの実装</a></li>
<li><a href="#_アプリケーションの実行">アプリケーションの実行</a></li>
</ul>
</li>
<li><a href="#_エンドポイントへのバイナリデータの送信">エンドポイントへのバイナリ・データの送信</a></li>
<li><a href="#_関連項目">関連項目</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>このチュートリアルでは、1つのサーバー・アプリケーションに接続されているクライアント・ブラウザの間のコラボレーションを可能にする単純なWebアプリケーションを作成する方法を示します。ユーザーがクライアント・ブラウザでキャンバスにグラフィック要素を描画すると、接続されているすべてのクライアントのキャンバスにその要素が表示されます。使用方法ブラウザがWebページをロードすると、クライアント側のスクリプトはWebSocketハンドシェイク・リクエストをアプリケーション・サーバーに送信します。アプリケーションは、セッションで接続されているクライアントからJSONおよびバイナリ・メッセージを受け付けて、接続されているすべてのクライアントにメッセージをブロードキャストできます。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでは、ブラウザ・クライアントとアプリケーション・サーバーとの間の双方向の通信を可能にするJava API for WebSocket (<a href="http://www.jcp.org/en/jsr/detail?id=356">JSR 356</a>)を使用してWebアプリケーションを作成します。Java API for WebSocketでは、WebSocket Javaコンポーネントの作成、WebSocketイベントの開始とインターセプト、WebSocketのテキストおよびバイナリのメッセージの作成と消費のサポートが提供されます。チュートリアルでは、Java API for JSON Processing (<a href="http://jcp.org/en/jsr/detail?id=353">JSR 353</a>)を使用してJSONを生成および消費する方法も示します。Java API for WebSocketおよびJava API for JSON ProcessingはJava EE 7プラットフォーム(<a href="http://jcp.org/en/jsr/detail?id=342">JSR 342</a>)の一部です。</p>
</div>
<div class="paragraph">
<p>アプリケーションには、WebSocketエンドポイント、デコーダおよびエンコーダのインタフェース、Webページ、およびページのロード時またはWebページのフォームからの起動時にクライアント・ブラウザで実行されるJavaScriptファイルが含まれます。Java EE 7テクノロジのリファレンス実装であるGlassFish Server Open Source Edition 4にアプリケーションをデプロイします。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
このチュートリアルは、<a href="http://blog.arungupta.me/">Arun Gupta氏のブログ</a>で見ることができるブログ投稿<a href="https://blogs.oracle.com/arungupta/entry/collaborative_whiteboard_using_websocket_in">+ Collaborative Whiteboard using WebSocket in GlassFish 4 - Text/JSON and Binary/ArrayBuffer Data Transfer (TOTD #189)+</a>およびその他のブログ・エントリに基づいています。このブログにアクセスして、WebSocket APIやGlassFish 4の使用に関するその他の多くの有用なエントリをぜひ参照してください。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="maven-websocketapi-screencast.html">「WebアプリケーションでのWebSocket APIの使用のビデオ」</a>も参照できます。</p>
</div>
<div class="paragraph">
<p><strong>チュートリアルの課題</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Exercise_1">Webアプリケーション・プロジェクトの作成</a></p>
</li>
<li>
<p><a href="#createendpoint">WebSocketエンドポイントの作成</a></p>
</li>
<li>
<p><a href="#createendpoint1">エンドポイントの作成</a></p>
</li>
<li>
<p><a href="#createendpoint2">WebSocketセッションの開始</a></p>
</li>
<li>
<p><a href="#createendpoint3">エンドポイントのテスト</a></p>
</li>
<li>
<p><a href="#createwhiteboard">ホワイトボードの作成</a></p>
</li>
<li>
<p><a href="#createwhiteboard1">キャンバスの追加</a></p>
</li>
<li>
<p><a href="#createwhiteboard2">POJOの作成</a></p>
</li>
<li>
<p><a href="#createwhiteboard3">座標クラスの作成</a></p>
</li>
<li>
<p><a href="#createwhiteboard6">JSON文字列の生成</a></p>
</li>
<li>
<p><a href="#createwhiteboard4">エンコーダおよびデコーダ・インタフェースの実装</a></p>
</li>
<li>
<p><a href="#createwhiteboard5">アプリケーションの実行</a></p>
</li>
<li>
<p><a href="#sendbinary">エンドポイントへのバイナリ・データの送信</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>このチュートリアルに従うには、次のソフトウェアとリソースが必要です。</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ソフトウェアまたはリソース</th>
<th class="tableblock halign-left valign-top">必須バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://netbeans.org/downloads/index.html">NetBeans IDE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7.3.1、7.4、8.0、Java EEバージョン</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java Development Kit (JDK)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バージョン7または8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://glassfish.java.net/">GlassFish Server Open Source Edition</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
GlassFish 4は、NetBeans IDEのJava EEダウンロード・バンドルにバンドルされています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>前提条件</strong></p>
</div>
<div class="paragraph">
<p>このドキュメントは、次のテクノロジについて基本的な知識またはプログラミング経験を持つ読者を想定して書かれています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Javaプログラミング</p>
</li>
<li>
<p>JavaScript/HTMLプログラミング</p>
</li>
<li>
<p>NetBeans IDE</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このチュートリアルを開始する前に、必要に応じて次のドキュメントをお読みください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://wiki.netbeans.org/MavenBestPractices">NetBeans IDEでのApache Mavenのベスト・プラクティス</a></p>
</li>
<li>
<p><a href="http://books.sonatype.com/mvnref-book/reference/introduction.html">Chapter 1. Introducing Apache Maven</a> (<a href="http://books.sonatype.com/mvnref-book/reference/index.html">+Maven: The Complete Reference +</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://netbeans.org/projects/samples/downloads/download/Samples/JavaEE/WhiteboardApp.zip">終了したプロジェクトのZIPアーカイブ</a>はダウンロードできます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_webアプリケーションプロジェクトの作成">Webアプリケーション・プロジェクトの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この課題の目標は、IDEで新規プロジェクト・ウィザードを使用してWebアプリケーション・プロジェクトを作成することです。プロジェクトを作成する際、Java EEバージョンとして「Java EE 7」を、アプリケーション・サーバーとしてGlassFish 4を選択します。GlassFish 4はJava EE 7プラットフォームのリファレンス実装です。このチュートリアルでアプリケーションを作成するには、IDEに登録されたJava EE 7をサポートするアプリケーション・サーバーが必要です。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>メイン・メニューから「ファイル」&gt;「新規プロジェクト」(Windowsの場合は[Ctrl]-[Shift]-[N]、Macの場合は[⌘]-[Shift]-[N])を選択します。</p>
</li>
<li>
<p>「Maven」カテゴリから「Webアプリケーション」を選択します。「次」をクリックします。</p>
</li>
<li>
<p>「プロジェクト名」に*「WhiteboardApp」*と入力し、プロジェクトの場所を設定します。</p>
</li>
<li>
<p>「グループID」に*「org.sample」*と入力します。「次」をクリックします。</p>
</li>
<li>
<p>「サーバー」に*「GlassFish Server 4.0」*を選択します。</p>
</li>
<li>
<p>「Java EEバージョン」を*「Java EE 7 Web」*に設定します。「終了」をクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-newproject.png" alt="websocket newproject">
</div>
<div class="title">Figure 1. 新規プロジェクト・ウィザードの「サーバー」および「Java EEバージョン」</div>
</div>
<div class="paragraph">
<p>「終了」をクリックすると、IDEがプロジェクトを作成し、そのプロジェクトが「プロジェクト」ウィンドウで開きます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_websocketエンドポイントの作成">WebSocketエンドポイントの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この項では、WebSocketエンドポイント・クラスおよびJavaScriptファイルを作成します。WebSocketエンドポイント・クラスには、セッションのオープン時に実行される基本的なメソッドを含めます。次に、ページのロード時にサーバーとのハンドシェイクを開始するJavaScriptファイルを作成します。次に、接続が正常であることをテストするアプリケーションを実行します。</p>
</div>
<div class="paragraph">
<p>WebSocket APIおよび注釈の使用の詳細は、<a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/package-summary.html">+ javax.websocket+</a>パッケージのサマリーを参照してください。</p>
</div>
<div class="sect2">
<h3 id="_エンドポイントの作成">エンドポイントの作成</h3>
<div class="paragraph">
<p>この課題では、IDEのウィザードを利用してWebSocketエンドポイント・クラスを作成します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>「プロジェクト」ウィンドウで「ソース・パッケージ」ノードを右クリックし、「新規」&gt;「その他」を選択します。</p>
</li>
<li>
<p>「Web」カテゴリで「WebSocketエンドポイント」を選択します。「次」をクリックします。</p>
</li>
<li>
<p>「クラス名」に*「MyWhiteboard」*と入力します。</p>
</li>
<li>
<p>「パッケージ」ドロップダウン・リストで「 <code>org.sample.whiteboardapp</code> 」を選択します。</p>
</li>
<li>
<p>「WebSocket URI」に*「/whiteboardendpoint」*と入力します。「終了」をクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-newendpoint.png" alt="websocket newendpoint">
</div>
<div class="title">Figure 2. 新規ファイル・ウィザードのWebSocketエンドポイント</div>
</div>
<div class="paragraph">
<p>「終了」をクリックすると、IDEによってWebSocketエンドポイント・クラスが生成され、ソース・エディタでファイルが開きます。エディタで、IDEによってWebSocket APIの一部である注釈が生成されたことを確認できます。クラスには、クラスがエンドポイントであることを識別する <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/server/ServerEndpoint.html">+@ServerEndpoint+</a></code> という注釈が付けられ、注釈のパラメータとしてWebSocket URIが指定されています。IDEによって <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnMessage.html">+@OnMessage+</a></code> という注釈が付けられたデフォルトの <code>onMessage</code> メソッドも生成されました。 <code>@OnMessage</code> という注釈が付けられたメソッドは、クライアントがWebSocketメッセージを受信するたびに起動されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ServerEndpoint("/whiteboardendpoint")
public class MyWhiteboard {

    @OnMessage
    public String onMessage(String message) {
        return null;
    }

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次のフィールド(*太字*部分)をクラスに追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ServerEndpoint("/whiteboardendpoint")
public class MyWhiteboard {
    *private static Set&lt;Session&gt; peers = Collections.synchronizedSet(new HashSet&lt;Session&gt;());*

    @OnMessage
    public String onMessage(String message) {
        return null;
    }
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の <code>onOpen</code> および <code>onClose</code> メソッドを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    @OnOpen
    public void onOpen (Session peer) {
        peers.add(peer);
    }

    @OnClose
    public void onClose (Session peer) {
        peers.remove(peer);
    }</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>``onOpen`` および ``onClose`` メソッドには、 ``link:https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnOpen.html[+@OnOpen+]`` および ``link:https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnClose.html[+@OnClose+]`` のWebSocket API注釈が付けられています。 ``@OnOpen`` という注釈が付けられたメソッドは、Webソケット・セッションが開かれたときにコールされます。この例では、注釈の付いた ``onOpen`` メソッドでブラウザ・クライアントを現在のセッションのピアのグループに追加し、 ``onClose`` メソッドでブラウザをグループから削除します。</pre>
</div>
</div>
<div class="paragraph">
<p>メソッドの生成には、ソース・エディタのヒントとコード補完を使用すると便利です。クラスの宣言の横の左マージンのヒント・グリフをクリックし(または、カーソルをクラスの宣言内に置いて[Alt]-[Enter])、ポップアップ・メニューでメソッドを選択します。コード補完をメソッドのコーディングに使用すると便利です。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-endpoint-hint.png" alt="websocket endpoint hint">
</div>
<div class="title">Figure 3. ソース・エディタのコード・ヒント</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタで右クリックし、「インポートを修正」を選択します([Alt]-[Shift]-[I]、Macの場合は[⌘]-[Shift]-[I])。変更を保存します。</p>
<div class="literalblock">
<div class="content">
<pre>``javax.websocket`` のクラスのインポート文がファイルに追加されます。</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>これでエンドポイントが作成されました。次にWebSocketセッションを開始するためのJavaScriptファイルを作成する必要があります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_websocketセッションの開始">WebSocketセッションの開始</h3>
<div class="paragraph">
<p>この課題では、WebSocketセッションを開始するJavaScriptファイルを作成します。ブラウザ・クライアントは、サーバーとのHTTPハンドシェイクを使用し、TCPを介してセッションに参加します。JavaScriptファイルで、エンドポイントの <code>wsURI</code> の名前を指定し、WebSocketを宣言します。 <code>wsURI</code>  URIスキームはWebSocketプロトコルの一部で、アプリケーションのエンドポイントのパスを指定します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>「プロジェクト」ウィンドウでプロジェクト・ノードを右クリックし、「新規」&gt;「その他」を選択します。</p>
</li>
<li>
<p>新規ファイル・ウィザードの「Web」カテゴリで「JavaScriptファイル」を選択します。「次」をクリックします。</p>
</li>
<li>
<p>「JavaScriptファイル名」に*「websocket」*と入力します。「終了」をクリックします。</p>
</li>
<li>
<p>次のコードをJavaScriptファイルに追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">var wsUri = "ws://" + document.location.host + document.location.pathname + "whiteboardendpoint";
var websocket = new WebSocket(wsUri);

websocket.onerror = function(evt) { onError(evt) };

function onError(evt) {
    writeToScreen('&lt;span style="color: red;"&gt;ERROR:&lt;/span&gt; ' + evt.data);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>このスクリプトは、ブラウザによって <code>websocket.js</code> がロードされる際、サーバーとセッション・ハンドシェイクを開始します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>index.html</code> を開き、ページのロードの終了時に <code>websocket.js</code> をロードする次のコード(*太字*部分)をファイルの最後に追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;body&gt;
    *&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;*
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、WebSocketエンドポイントが機能していること、セッションが開始されたこと、およびクライアントがセッションに追加されたことをテストできます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_エンドポイントのテスト">エンドポイントのテスト</h3>
<div class="paragraph">
<p>この課題では、ブラウザがエンドポイントに接続されたら、ブラウザ・ウィンドウに <code>wsURI</code> を出力するよう、簡単なメソッドをいくつかJavaScriptに追加します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の <code>&lt;div&gt;</code> タグ(*太字*部分)を <code>index.html</code> に追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

*&lt;div id="output"&gt;&lt;/div&gt;*
&lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の宣言とメソッドを <code>websocket.js</code> に追加します。変更を保存します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">// For testing purposes
var output = document.getElementById("output");
websocket.onopen = function(evt) { onOpen(evt) };

function writeToScreen(message) {
    output.innerHTML += message + "&lt;br&gt;";
}

function onOpen() {
    writeToScreen("Connected to " + wsUri);
}
// End test functions</code></pre>
</div>
</div>
<div class="paragraph">
<p>ページがロードされると、JavaScript関数は、ブラウザがエンドポイントに接続されていることを示すメッセージを出力します。エンドポイントが正しく実行されていることを確認したら、関数を削除できます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>「プロジェクト」ウィンドウでプロジェクトを右クリックし、「実行」を選択します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>アプリケーションを実行すると、IDEでGlassFishサーバーが起動され、アプリケーションがビルドおよびデプロイされます。ブラウザでindexページが開かれ、ブラウザ・ウィンドウに次のメッセージが表示されます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-browser1.png" alt="websocket browser1">
</div>
<div class="title">Figure 4. ブラウザ・ウィンドウ内のエンドポイントへの接続メッセージ</div>
</div>
<div class="paragraph">
<p>ブラウザ・ウィンドウに、メッセージが受け付けられたエンドポイント( <code><a href="http://localhost:8080/WhiteboardApp/whiteboardendpoint" class="bare">http://localhost:8080/WhiteboardApp/whiteboardendpoint</a></code> )が表示されます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ホワイトボードの作成">ホワイトボードの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この項では、JSONテキスト・メッセージを送受信するクラスおよびJavaScriptファイルを作成します。コンテンツ、およびペイントブラシの形状と色を指定するラジオ・ボタンを含むHTML <code>&lt;form&gt;</code> を描画および表示するための<a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html">HTML5 Canvas</a>要素も追加します。</p>
</div>
<div class="sect2">
<h3 id="_webページへのキャンバスの追加">Webページへのキャンバスの追加</h3>
<div class="paragraph">
<p>この課題では、 <code>canvas</code> 要素および <code>form</code> 要素をデフォルトのindexページに追加します。フォームのチェックボックスによって、キャンバスのペイントブラシのプロパティが決まります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ソース・エディタで <code>index.html</code> を開きます。</p>
</li>
<li>
<p>エンドポイントのテスト用に追加した <code>&lt;div&gt;</code> タグを削除し、開始のbodyタグの後に次の <code>&lt;table&gt;</code> および <code>&lt;form&gt;</code> 要素(*太字*部分)を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

    *&lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;form name="inputForm"&gt;


                &lt;/form&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;*
    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;
    &lt;/body&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>canvas要素用に次のコード(*太字*部分)を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">        &lt;table&gt;
            &lt;tr&gt;
                &lt;td&gt;
                    *&lt;canvas id="myCanvas" width="150" height="150" style="border:1px solid #000000;"&gt;&lt;/canvas&gt;*
                &lt;/td&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の <code>&lt;table&gt;</code> を追加して、色と形状を選択するラジオ・ボタンを追加します。変更を保存します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">        &lt;table&gt;
            &lt;tr&gt;
                &lt;td&gt;
                    &lt;canvas id="myCanvas" width="150" height="150" style="border:1px solid #000000;"&gt;&lt;/canvas&gt;
                &lt;/td&gt;
                &lt;td&gt;
                    &lt;form name="inputForm"&gt;
                        *&lt;table&gt;

                            &lt;tr&gt;
                                &lt;th&gt;Color&lt;/th&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#FF0000" checked="true"&gt;Red&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#0000FF"&gt;Blue&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#FF9900"&gt;Orange&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#33CC33"&gt;Green&lt;/td&gt;
                            &lt;/tr&gt;

                            &lt;tr&gt;
                                &lt;th&gt;Shape&lt;/th&gt;
                                &lt;td&gt;&lt;input type="radio" name="shape" value="square" checked="true"&gt;Square&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="shape" value="circle"&gt;Circle&lt;/td&gt;
                                &lt;td&gt; &lt;/td&gt;
                                &lt;td&gt; &lt;/td&gt;
                            &lt;/tr&gt;

                        &lt;/table&gt;*
                    &lt;/form&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>キャンバス上に描画された図形の形状、色、および座標は、JSONの構造の文字列に変換され、WebSocketエンドポイントにメッセージとして送信されます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_pojoの作成">POJOの作成</h3>
<div class="paragraph">
<p>この課題では、単純なPOJOを作成します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>プロジェクト・ノードを右クリックし、「新規」&gt;「Javaクラス」を選択します。</p>
</li>
<li>
<p>「クラス名」に*「Figure」*と入力し、「パッケージ」ドロップダウン・リストで「 <code>org.sample.whiteboardapp</code> 」を選択します。「終了」をクリックします。</p>
</li>
<li>
<p>ソース・エディタで、次のコード(*太字*部分)を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class Figure {
    *private JsonObject json;*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>コードを追加すると、 <code>javax.json.JsonObject</code> のインポート文を追加するよう求められます。求められない場合は、[Alt]-[Enter]を押します。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>``javax.json.JsonObject`` の詳細は、Java EE 7仕様の一部であるJava API for JSON Processing (link:http://jcp.org/en/jsr/detail?id=353[+JSR 353+])を参照してください。</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>json</code> の取得および設定メソッドを作成します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>「コードを挿入」ポップアップ・メニュー(Windowsの場合は[Alt]-[Insert]、Macの場合は[Ctrl]-[I])で取得および設定メソッドを選択すると、「取得メソッドおよび設定メソッドの生成」ダイアログ・ボックスが開きます。または、メイン・メニューから「ソース」&gt;「コードを挿入」を選択します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-generategetter.png" alt="websocket generategetter">
</div>
<div class="title">Figure 5. 「取得メソッドおよび設定メソッドの生成」ダイアログ・ボックス</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>json</code> のコンストラクタを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    public Figure(JsonObject json) {
        this.json = json;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>「コードを挿入」ポップアップ・メニュー([Ctrl]-[I])で「コンストラクタ」を選択します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-generateconstructor.png" alt="websocket generateconstructor">
</div>
<div class="title">Figure 6. 「コンストラクタの生成」ポップアップ・メニュー</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の <code>toString</code> メソッドを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    @Override
    public String toString() {
        StringWriter writer = new StringWriter();
        Json.createWriter(writer).write(json);
        return writer.toString();
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタで右クリックし、「インポートを修正」を選択します([Alt]-[Shift]-[I]、Macの場合は[⌘]-[Shift]-[I])。変更を保存します。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_座標クラスの作成">座標クラスの作成</h3>
<div class="paragraph">
<p>ここで、キャンバスに描画される図形の座標のクラスを作成します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>プロジェクト・ノードを右クリックし、「新規」&gt;「Javaクラス」を選択します。</p>
</li>
<li>
<p>新規Javaクラス・ウィザードで「クラス名」に*「Coordinates」*と入力し、「パッケージ」ドロップダウン・リストで「 <code>org.sample.whiteboardapp</code> 」を選択します。「終了」をクリックします。</p>
</li>
<li>
<p>ソース・エディタで、次のコードを追加します。変更を保存します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    private float x;
    private float y;

    public Coordinates() {
    }

    public Coordinates(float x, float y) {
        this.x = x;
        this.y = y;
    }

    public float getX() {
        return x;
    }

    public void setX(float x) {
        this.x = x;
    }

    public float getY() {
        return y;
    }

    public void setY(float y) {
        this.y = y;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>クラスには <code>x</code> と <code>y</code> 座標のフィールドおよび取得と設定のメソッドのみが含まれます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_json文字列の生成">JSON文字列の生成</h3>
<div class="paragraph">
<p>この課題では、 <code>canvas</code> 要素に描画される図形の詳細を、websocketエンドポイントに送信されるJSON構造にするJavaScriptファイルを作成します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>プロジェクト・ノードを右クリックし、「新規」&gt;「JavaScriptファイル」を選択して新規JavaScriptファイル・ウィザードを開きます。</p>
</li>
<li>
<p>「ファイル名」に*「whiteboard」*と入力します。「終了」をクリックします。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>「終了」をクリックすると、IDEで空のJavaScriptファイルが作成され、エディタでこのファイルが開きます。「プロジェクト」ウィンドウの「Webページ」ノードの下に新規ファイルが表示されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>キャンバスを初期化し、イベント・リスナーを追加する次のコードを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">var canvas = document.getElementById("myCanvas");
var context = canvas.getContext("2d");
canvas.addEventListener("click", defineImage, false);</code></pre>
</div>
</div>
<div class="paragraph">
<p>ユーザーが <code>canvas</code> 要素内をクリックすると、 <code>defineImage</code> メソッドが起動されることがわかります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の <code>getCurrentPos</code> 、 <code>defineImage</code> および <code>drawImageText</code> メソッドを追加して、JSON構造を作成し、エンドポイントに送信します( <code>sendText(json)</code> )。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">function getCurrentPos(evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}

function defineImage(evt) {
    var currentPos = getCurrentPos(evt);

    for (i = 0; i &lt; document.inputForm.color.length; i++) {
        if (document.inputForm.color[i].checked) {
            var color = document.inputForm.color[i];
            break;
        }
    }

    for (i = 0; i &lt; document.inputForm.shape.length; i++) {
        if (document.inputForm.shape[i].checked) {
            var shape = document.inputForm.shape[i];
            break;
        }
    }

    var json = JSON.stringify({
        "shape": shape.value,
        "color": color.value,
        "coords": {
            "x": currentPos.x,
            "y": currentPos.y
        }
    });
    drawImageText(json);
        sendText(json);
}

function drawImageText(image) {
    console.log("drawImageText");
    var json = JSON.parse(image);
    context.fillStyle = json.color;
    switch (json.shape) {
    case "circle":
        context.beginPath();
        context.arc(json.coords.x, json.coords.y, 5, 0, 2 * Math.PI, false);
        context.fill();
        break;
    case "square":
    default:
        context.fillRect(json.coords.x, json.coords.y, 10, 10);
        break;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>送信されるJSONの構造は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">{
 "shape": "square",
 "color": "#FF0000",
 "coords": {
 "x": 31.59999942779541,
 "y": 49.91999053955078
 }
}</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>``websocket.send()`` を使用してJSON文字列を送信する ``sendText(json)`` メソッドを追加する必要があります。</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタで <code>websocket.js</code> を開き、JSONをエンドポイントに送信するためのメソッドおよびエンドポイントからメッセージを受信したらイメージを描画するためのメソッドを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">websocket.onmessage = function(evt) { onMessage(evt) };

function sendText(json) {
    console.log("sending text: " + json);
    websocket.send(json);
}

function onMessage(evt) {
    console.log("received: " + evt.data);
    drawImageText(evt.data);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
エンドポイントのテスト用に <code>websocket.js</code> に追加したコードは削除できます。
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>whiteboard.js</code> をロードする次の行(*太字*部分)を <code>index.html</code> の最後に追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">        &lt;/table&gt;
    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;
    *&lt;script type="text/javascript" src="whiteboard.js"&gt;&lt;/script&gt;*
&lt;body&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_エンコーダおよびデコーダインタフェースの実装">エンコーダおよびデコーダ・インタフェースの実装</h3>
<div class="paragraph">
<p>この課題では、デコーダおよびエンコーダ・インタフェースを実装するクラスを作成し、Webソケット・メッセージ(JSON)をPOJOクラス <code>Figure</code> にデコードし、エンドポイントに送信するために <code>Figure</code> をJSON文字列としてエンコードします。</p>
</div>
<div class="paragraph">
<p>詳細は、技術記事<a href="http://www.oracle.com/technetwork/articles/java/jsr356-1937161.html">JSR 356、Java API for WebSocket</a>のメッセージ・タイプおよびエンコーダ、デコーダに関する項を参照してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>プロジェクト・ノードを右クリックし、「新規」&gt;「Javaクラス」を選択します。</p>
</li>
<li>
<p>「クラス名」に*「FigureEncoder」*と入力し、「パッケージ」ドロップダウン・リストで「 <code>org.sample.whiteboardapp</code> 」を選択します。「終了」をクリックします。</p>
</li>
<li>
<p>ソース・エディタで次のコード(*太字*部分)を追加し、WebSocket Encoderインタフェースを実装します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class FigureEncoder *implements Encoder.Text&lt;Figure&gt;* {

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>javax.websocket.Encoder</code> のインポート文を追加し、抽象メソッドを実装します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>クラスの宣言にカーソルを置き、[Alt]-[Enter]を押して、ポップアップ・メニューから*「すべての抽象メソッドを実装」*を選択します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>次の変更(*太字*部分)を加えて、生成された抽象メソッドを変更します。変更を保存します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    @Override
    public String encode(Figure *figure*) throws EncodeException {
        *return figure.getJson().toString();*
    }

    @Override
    public void init(EndpointConfig ec) {
        *System.out.println("init");*
    }

    @Override
    public void destroy() {
        *System.out.println("destroy");*
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>プロジェクト・ノードを右クリックし、「新規」&gt;「Javaクラス」を選択します。</p>
</li>
<li>
<p>「クラス名」に*「FigureDecoder」*と入力し、「パッケージ」ドロップダウン・リストで「 <code>org.sample.whiteboardapp</code> 」を選択します。「終了」をクリックします。</p>
</li>
<li>
<p>ソース・エディタで、次のコード(*太字*部分)を追加し、WebSocket Decoderインタフェースを実装します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">public class FigureDecoder *implements Decoder.Text&lt;Figure&gt;* {

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>javax.websocket.Decoder</code> のインポート文を追加し、抽象メソッドを実装します。</p>
</li>
<li>
<p>生成された抽象メソッドに次の変更(*太字*部分)を加えます。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    @Override
    public Figure decode(String *string*) throws DecodeException {
        *JsonObject jsonObject = Json.createReader(new StringReader(string)).readObject();
        return  new Figure(jsonObject);*
    }

    @Override
    public boolean willDecode(String *string*) {
        *try {
            Json.createReader(new StringReader(string)).readObject();
            return true;
        } catch (JsonException ex) {
            ex.printStackTrace();
            return false;
        }*

    }

    @Override
    public void init(EndpointConfig ec) {
        *System.out.println("init");*
    }

    @Override
    public void destroy() {
        *System.out.println("destroy");*
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>インポートを修正して変更内容を保存します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>次に、 <code>MyWhiteboard.java</code> を変更して、エンコーダとデコーダを指定する必要があります。</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの実行">アプリケーションの実行</h3>
<div class="paragraph">
<p>これでアプリケーションを実行する準備がほぼ整いました。この課題では、WebSocketエンドポイント・クラスを変更してJSON文字列のエンコーダとデコーダを指定し、メッセージを受信したら、接続されているクライアントにJSON文字列を送信するメソッドを追加します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタで <code>MyWhiteboard.java</code> を開きます。</p>
</li>
<li>
<p><code>@ServerEndpoint</code> 注釈を変更し、エンドポイントのエンコーダとデコーダを指定します。エンドポイントの名前のパラメータ <code>value</code> を明示的に指定する必要があります。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@ServerEndpoint(*value=*"/whiteboardendpoint"*, encoders = {FigureEncoder.class}, decoders = {FigureDecoder.class}*)</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>デフォルトで生成された <code>onMessage</code> メソッドを削除します。</p>
</li>
<li>
<p>次の <code>broadcastFigure</code> メソッドを追加し、メソッドに <code>@OnMessage</code> の注釈を付けます。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">    @OnMessage
    public void broadcastFigure(Figure figure, Session session) throws IOException, EncodeException {
        System.out.println("broadcastFigure: " + figure);
        for (Session peer : peers) {
            if (!peer.equals(session)) {
                peer.getBasicRemote().sendObject(figure);
            }
        }
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタで右クリックし、「インポートを修正」を選択します([Alt]-[Shift]-[I]、Macの場合は[⌘]-[Shift]-[I])。変更を保存します。</p>
</li>
<li>
<p>「プロジェクト」ウィンドウでプロジェクトを右クリックし、「実行」を選択します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>「実行」をクリックすると、IDEはブラウザ・ウィンドウで<a href="http://localhost:8080/WhiteboardApp/">http://localhost:8080/WhiteboardApp/</a>を開きます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
以前のアプリケーションをアプリケーション・サーバーからアンデプロイするか、ブラウザでページを強制的に再ロードする必要がある場合があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ブラウザ・メッセージを確認すると、キャンバスをクリックするたびに、文字列がJSONを介してエンドポイントに送信されていることがわかります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-onebrowser.png" alt="websocket onebrowser">
</div>
<div class="title">Figure 7. ブラウザ内の図形を含むキャンバスおよびWebコンソールに表示されたJSON</div>
</div>
<div class="paragraph">
<p>別のブラウザで <code><a href="http://localhost:8080/WhiteboardApp/" class="bare">http://localhost:8080/WhiteboardApp/</a></code> を開くと、一方のブラウザのキャンバス内をクリックするたびに新しい円や正方形が他方のブラウザのキャンバスに複製されることがわかります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-twobrowsers.png" alt="websocket twobrowsers">
</div>
<div class="title">Figure 8. エンドポイントを介してJSONを送信する2つのブラウザ</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_エンドポイントへのバイナリデータの送信">エンドポイントへのバイナリ・データの送信</h2>
<div class="sectionbody">
<div class="paragraph">
<p>これで、アプリケーションで文字列を処理し、JSONを介してエンドポイントに送信できます。文字列は、接続されているクライアントに送信されます。この項では、バイナリ・データを送受信するようJavaScriptファイルを変更します。</p>
</div>
<div class="paragraph">
<p>バイナリ・データをエンドポイントに送信するために、WebSocketの <code>binaryType</code> プロパティを <code>arraybuffer</code> に設定する必要があります。これによって、WebSocketを使用したバイナリ転送は <code>ArrayBuffer</code> を介して行われることが保証されます。バイナリ・データ変換は、 <code>whiteboard.js</code> の <code>defineImageBinary</code> メソッドによって行われます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>websocket.js</code> を開き、WebSocketの <code>binaryType</code> プロパティを <code>arraybuffer</code> に設定する次のコードを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">websocket.binaryType = "arraybuffer";</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>バイナリ・データをエンドポイントに送信する次のメソッドを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">function sendBinary(bytes) {
    console.log("sending binary: " + Object.prototype.toString.call(bytes));
    websocket.send(bytes);
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>onMessage</code> メソッドを変更し、受信メッセージのデータ型に応じてキャンバスを更新するメソッドを選択する次のコード(*太字*部分)を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">function onMessage(evt) {
    console.log("received: " + evt.data);
    *if (typeof evt.data == "string") {*
        drawImageText(evt.data);
    *} else {
        drawImageBinary(evt.data);
    }*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>バイナリ・データのメッセージを受信すると、 <code>drawImageBinary</code> メソッドが起動されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>whiteboard.js</code> を開いて、次のメソッドを追加します。受信バイナリ・データの解析後、 <code>drawImageBinary</code> メソッドを起動してキャンバスを更新します。 <code>defineImageBinary</code> メソッドを使用して、バイナリ・データとしてキャンバスのスナップショットを準備します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">function drawImageBinary(blob) {
    var bytes = new Uint8Array(blob);
//    console.log('drawImageBinary (bytes.length): ' + bytes.length);

    var imageData = context.createImageData(canvas.width, canvas.height);

    for (var i=8; i&lt;imageData.data.length; i++) {
        imageData.data[i] = bytes[i];
    }
    context.putImageData(imageData, 0, 0);

    var img = document.createElement('img');
    img.height = canvas.height;
    img.width = canvas.width;
    img.src = canvas.toDataURL();
}

function defineImageBinary() {
    var image = context.getImageData(0, 0, canvas.width, canvas.height);
    var buffer = new ArrayBuffer(image.data.length);
    var bytes = new Uint8Array(buffer);
    for (var i=0; i&lt;bytes.length; i++) {
        bytes[i] = image.data[i];
    }
    sendBinary(buffer);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>バイナリ・データを <code>ArrayBuffer</code> 型として生成し、エンドポイントに送信する場合に <code>defineImageBinary</code> を起動する方法を追加する必要があります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>index.html</code> を開き、 <code>&lt;table&gt;</code> 要素を変更して、フォームの表に次の行を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;tr&gt;
    &lt;th&gt; &lt;/th&gt;
    &lt;td&gt;&lt;input type="submit" value="Send Snapshot" onclick="defineImageBinary(); return false;"&gt;&lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>新しい行には、接続されているピアにキャンバスのバイナリ・スナップショットを送信する「Send Snapshot」ボタンが含まれます。ボタンがクリックされると、 <code>whiteboard.js</code> の <code>defineImageBinary</code> メソッドが起動されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>MyWhiteboard.java</code> を開き、エンドポイントがバイナリ・データのメッセージを受信すると、ピアにバイナリ・データを送信する次のメソッドを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@OnMessage
public void broadcastSnapshot(ByteBuffer data, Session session) throws IOException {
    System.out.println("broadcastBinary: " + data);
    for (Session peer : peers) {
        if (!peer.equals(session)) {
            peer.getBasicRemote().sendBinary(data);
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>java.nio.ByteBuffer</code> のインポート文を追加する必要があります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>アプリケーションを変更して、ユーザーがエンドポイントへのデータの送信を停止できるようにできます。デフォルトでは、すべてのピアはページを開くとすぐに接続され、データはブラウザからすべての接続されているピアに送信されます。オプションが選択されていない場合にデータがエンドポイントに送信されないよう単純な条件文を追加できます。これは、受信するデータに影響しません。データは引き続き、エンドポイントから受信されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>whiteboard.js</code> の <code>defineImage</code> メソッドを変更し、次のコード(*太字*部分)を追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="javascript">        drawImageText(json);
*    if (document.getElementById("instant").checked) {*
        sendText(json);
*    }*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>id  <code>checked</code> の要素をチェックする条件コード</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>index.html</code> を開き、 <code>&lt;table&gt;</code> 要素を変更してフォームにチェックボックスを追加します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;tr&gt;
    &lt;th&gt; &lt;/th&gt;
    &lt;td&gt;&lt;input type="submit" value="Send Snapshot" onclick="defineImageBinary(); return false;"&gt;&lt;/td&gt;
    &lt;td&gt;*&lt;input type="checkbox" id="instant" value="Online" checked="true"&gt;Online*&lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>「Online」チェックボックスが選択解除されている場合、データは送信されませんが、クライアントは引き続きエンドポイントからデータを受信します。</p>
</div>
<div class="paragraph">
<p>「Send Snapshot」ボタンおよび「Online」チェックボックスを追加してアプリケーションを再度実行すると、indexページに新しい要素が表示されます。別のブラウザを開いて「Online」ボタンを選択解除すると、キャンバス内をクリックしたときにJSONメッセージが送信されないことがわかります。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-onebrowser-binary.png" alt="websocket onebrowser binary">
</div>
<div class="title">Figure 9. バイナリ・データが送信されたというメッセージを表示するブラウザ内のWebコンソール</div>
</div>
<div class="paragraph">
<p>「Send Snapshot」をクリックすると、バイナリ・データがエンドポイントに送信され、接続されているクライアントにブロードキャストされます。</p>
</div>
<div class="paragraph">
<p><a href="/about/contact_form.html?to=3&amp;subject=Feedback:%20Using%20the%20WebSocket%20API%20in%20a%20Web%20Application">このチュートリアルに関するご意見をお寄せください</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_関連項目">関連項目</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NetBeans IDEを使用したJava EEアプリケーションの開発方法の詳細は、次のリソースを参照してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>デモ: <a href="maven-websocketapi-screencast.html">WebアプリケーションでのWebSocket APIの使用</a></p>
</li>
<li>
<p><a href="javaee-intro.html">Java EEテクノロジ入門</a></p>
</li>
<li>
<p><a href="javaee-gettingstarted.html">Java EEアプリケーションの開始</a></p>
</li>
<li>
<p><a href="../../trails/java-ee.html">Java EEおよびJava Webの学習</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Java EEの使用に関する詳細は、<a href="http://download.oracle.com/javaee/6/tutorial/doc/">Java EEチュートリアル</a>を参照してください。</p>
</div>
<div class="paragraph">
<p><a href="../../../community/lists/top.html">nbj2eeメーリング・リストに登録する</a>ことによって、NetBeans IDE Java EE開発機能に関するご意見やご提案を送信したり、サポートを受けたり、最新の開発情報を入手したりできます。</p>
</div>
</div>
</div>
      
<section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="Issues" href="https://github.com/apache/netbeans/issues"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        
        <li><a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/maven-websocketapi_ja.adoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>

    </div>
    

    <div class='grid-container incubator-area' style='margin-top: 64px'>
      <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/">
            <img style="width: 320px" title="Apache Software Foundation" src="/images/asf_logo_wide.svg" />
          </a>
        </div>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/events/current-event.html">
            <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
          </a>
        </div>
      </div>
    </div>
    <footer>
      <div class="grid-container">
        <div class="grid-x grid-padding-x">
          <div class="large-auto cell">
                    
            <h1><a href="/about/index.html">About</a></h1>
            <ul>
              <li><a href="https://netbeans.apache.org/community/who.html">Who's Who</a></li>
              <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
              <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
              <li><a href="https://www.apache.org/security/">Security</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/community/index.html">Community</a></h1>
            <ul>
              <li><a href="/community/mailing-lists.html">Mailing lists</a></li>
              <li><a href="/community/committer.html">Becoming a committer</a></li>
              <li><a href="/community/events.html">NetBeans Events</a></li>
              <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/participate/index.html">Participate</a></h1>
            <ul>
              <li><a href="/participate/submit-pr.html">Submitting Pull Requests</a></li>
              <li><a href="/participate/report-issue.html">Reporting Issues</a></li>
              <li><a href="/participate/index.html#documentation">Improving the documentation</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/help/index.html">Get Help</a></h1>
            <ul>
              <li><a href="/help/index.html#documentation">Documentation</a></li>
              <li><a href="/wiki/index.html">Wiki</a></li>
              <li><a href="/help/index.html#support">Community Support</a></li>
              <li><a href="/help/commercial-support.html">Commercial Support</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/download/index.html">Download</a></h1>
            <ul>
              <li><a href="/download/index.html">Releases</a></li>                    
              <li><a href="https://plugins.netbeans.apache.org/">Plugins</a></li>
              <li><a href="/download/index.html#source">Building from source</a></li>
              <li><a href="/download/index.html#previous">Previous releases</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    <div class='footer-disclaimer'>
      <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2023 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
          <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
          <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
          <p>The Apache NetBeans website conforms to the <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Apache Software Foundation Privacy Policy</a></p>
        </div>
            
      </div>
    </div>


    

    <script src="/js/vendor/jquery-3.2.1.min.js"></script>
    <script src="/js/vendor/what-input.js"></script>
    <script src="/js/vendor/foundation.min.js"></script>
    <script src="/js/vendor/jquery.colorbox-min.js"></script>
    <script src="/js/netbeans.js"></script>
    <script>

       $(function(){ $(document).foundation(); });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
    <script>
       $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); }); 
    </script>

  </body>
</html>
