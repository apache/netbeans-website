
<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
    
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Использование WebSocket API в веб-приложении</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Использование WebSocket API в веб-приложении - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, Использование WebSocket API в веб-приложении">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
     <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css"> 
    <link rel="stylesheet" href="/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet"> 
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
</head>


    <body>
        

<div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="/"><img src='/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <a href="/community/index.html">Community</a> </li>
            <li> <a href="/participate/index.html">Participate</a> </li>
            <li> <a href="https://blogs.apache.org/netbeans/">Blog</a></li>
            <li> <a href="/help/index.html">Get Help</a> </li>
            <li> <a href="/plugins/index.html">Plugins</a> </li>
            <li> <a href="/download/index.html">Download</a> </li>
        </ul>
    </div>
</div>


        
<!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Just released!</div>
            <h1 syle='font-size: 2rem'>Apache NetBeans 11.3</h1>
            <p><a class="button success" href="/download/nb113/index.html">Find out more</a></p>
        </div>
    </div>
</section>

        <div class='grid-container main-content tutorial'>
            <h1 class="sect0">Использование WebSocket API в веб-приложении</h1>
            
            <div class="sectionbody">
              <div class="admonitionblock note">
                <table>
                  <tbody><tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">This tutorial needs a review. 
                     You can <a href="https://issues.apache.org/jira/projects/NETBEANS/issues">open a JIRA issue</a>, 
                     or <a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/maven-websocketapi_ru.asciidoc" title="Edit this tutorial in github">edit it in GitHub </a>
                     following these <a href="/kb/docs/contributing.html">contribution guidelines.</a></td>
                  </tr></tbody>
                </table>
              </div>
            </div>
            
            <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_Создание_проекта_веб_приложения">Создание проекта веб-приложения</a></li>
<li><a href="#_Создание_терминала_websocket">Создание терминала WebSocket</a>
<ul class="sectlevel2">
<li><a href="#_Создание_терминала">Создание терминала</a></li>
<li><a href="#_Инициализация_сеанса_websocket">Инициализация сеанса WebSocket</a></li>
<li><a href="#_Тестирование_терминала">Тестирование терминала</a></li>
</ul>
</li>
<li><a href="#_Создание_интерактивной_доски">Создание интерактивной доски</a>
<ul class="sectlevel2">
<li><a href="#_Добавление_полотна_на_веб_страницу">Добавление полотна на веб-страницу</a></li>
<li><a href="#_Создание_pojo">Создание POJO</a></li>
<li><a href="#_Создание_класса_координат">Создание класса координат</a></li>
<li><a href="#_Создание_строки_json">Создание строки JSON</a></li>
<li><a href="#_Реализация_интерфейсов_кодера_и_декодера">Реализация интерфейсов кодера и декодера</a></li>
<li><a href="#_Запуск_приложения">Запуск приложения</a></li>
</ul>
</li>
<li><a href="#_Отправка_двоичных_данных_на_терминал">Отправка двоичных данных на терминал</a></li>
<li><a href="#_См_также">См. также</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>В этом учебном курсе приведен пример создания простого веб-приложения, обеспечивающего взаимодействие браузерных клиентов, подключенных к одному серверному приложению. Когда пользователь рисует графический элемент на полотне в браузере клиента, этот элемент появляется на полотне всех подключенных клиентов. Как это работает? Когда браузер загружает веб-страницу, сценарий на стороне клиента отправляет запрос квитирования WebSocket на сервер приложений. Приложение может принимать двоичные сообщения и сообщения JSON от клиентов, подключенных к сеансу, и транслировать эти сообщения на все подключенные клиенты.</p>
</div>
<div class="paragraph">
<p>Из этого учебного курса вы узнаете о том, как создать веб-приложение, использующее интерфейс Java API for WebSocket (<a href="http://www.jcp.org/en/jsr/detail?id=356">JSR 356</a>) для двустороннего обмена данными между браузерными клиентами и сервером приложений. Интерфейс Java API for WebSocket обеспечивает возможность создания компонентов Java WebSocket, инициализации и перехвата событий WebSocket, а также создания и использования текстовых и двоичных сообщений WebSocket. В этом учебном курсе также приведен пример использования интерфейса Java API for JSON Processing (<a href="http://jcp.org/en/jsr/detail?id=353">JSR 353</a>) для создания и использования компонентов JSON. Интерфейсы Java API for WebSocket и Java API for JSON Processing являются компонентами платформы Java EE 7 (<a href="http://jcp.org/en/jsr/detail?id=342">JSR 342</a>).</p>
</div>
<div class="paragraph">
<p>Приложение содержит интерфейсы WebSocket для терминала, декодера и кодера, веб-страницу и ряд файлов JavaScript, запускаемых в браузере клиента при загрузке страницы или вызываемых формой на веб-странице. Развертывание приложения осуществляется на экземпляре GlassFish Server Open Source Edition 4, эталонной версии реализации технологии Java EE 7.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Этот курс основывается на статье блога <a href="https://blogs.oracle.com/arungupta/entry/collaborative_whiteboard_using_websocket_in">+ Collaborative Whiteboard using WebSocket in GlassFish 4 - Text/JSON and Binary/ArrayBuffer Data Transfer (TOTD #189) ] и других статьях блога link:http://blog.arungupta.me/[+Arun Gupta</a>. Рекомендуем посетить этот блог и ознакомиться с другими интересными статьями о работе с WebSocket API и GlassFish 4.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Также рекомендуем посмотреть видеоролик <a href="maven-websocketapi-screencast.html">Использование WebSocket API в веб-приложении</a>.</p>
</div>
<div class="paragraph">
<p><strong>Упражнения по темам руководства</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#Exercise_1">Создание проекта веб-приложения</a></p>
</li>
<li>
<p><a href="#createendpoint">Создание терминала WebSocket</a></p>
</li>
<li>
<p><a href="#createendpoint1">Создание терминала</a></p>
</li>
<li>
<p><a href="#createendpoint2">Инициализация сеанса WebSocket</a></p>
</li>
<li>
<p><a href="#createendpoint3">Тестирование терминала</a></p>
</li>
<li>
<p><a href="#createwhiteboard">Создание интерактивной доски</a></p>
</li>
<li>
<p><a href="#createwhiteboard1">Добавление полотна</a></p>
</li>
<li>
<p><a href="#createwhiteboard2">Создание POJO</a></p>
</li>
<li>
<p><a href="#createwhiteboard3">Создание класса координат</a></p>
</li>
<li>
<p><a href="#createwhiteboard6">Генерация строки JSON</a></p>
</li>
<li>
<p><a href="#createwhiteboard4">Реализация интерфейсов кодера и декодера</a></p>
</li>
<li>
<p><a href="#createwhiteboard5">Запуск приложения</a></p>
</li>
<li>
<p><a href="#sendbinary">Отправка двоичных данных на терминал</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Для работы с этим учебным курсом требуется следующее программное обеспечение и ресурсы.</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Программное обеспечение или ресурс</th>
<th class="tableblock halign-left valign-top">Требуемая версия</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://netbeans.org/downloads/index.html">IDE NetBeans</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Версия Java EE 7.3.1, 7.4, 8.0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Комплект для разработчика на языке Java (JDK)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">версия 7 или 8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://glassfish.java.net/">GlassFish Server Open Source Edition 3.1.2.2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
GlassFish 4 входит в состав загружаемого комплекта Java EE для NetBeans IDE.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Предпосылки</strong></p>
</div>
<div class="paragraph">
<p>Предполагается, что читатель обладает базовыми знаниями по следующим технологиям или опытом программирования с их использованием:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Программирование на Java</p>
</li>
<li>
<p>Программирование на JavaScript/HTML</p>
</li>
<li>
<p>IDE NetBeans</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Перед изучением этого учебного курса можно ознакомиться со следующей документацией:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://wiki.netbeans.org/MavenBestPractices">Испытанные приемы для Apache Maven в IDE NetBeans</a></p>
</li>
<li>
<p><a href="http://books.sonatype.com/mvnref-book/reference/introduction.html">Глава 1. Введение в Apache Maven</a> (из книги <a href="http://books.sonatype.com/mvnref-book/reference/index.html">+Maven: The Complete Reference +</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Можно загрузить <a href="https://netbeans.org/projects/samples/downloads/download/Samples/JavaEE/WhiteboardApp.zip">готовый проект в виде архива ZIP</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Создание_проекта_веб_приложения">Создание проекта веб-приложения</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Цель этого упражнения - создать проект веб-приложения с помощью мастера создания проектов в IDE. При создании проекта в качестве версии Java EE необходимо указать Java EE 7, а в качестве сервера приложений - GlassFish 4. GlassFish 4 является эталонной реализацией платформы Java EE 7. Для создания приложения по инструкциям, приведенным в этом учебном курсе, вам потребуется сервер приложений с поддержкой Java EE 7, зарегистрированный в IDE.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Выберите Файл &gt; Создать проект в главном меню (в Windows можно использовать сочетание клавиш Ctrl-Shift-N; в Mac - сочетание клавиш ⌘-Shift-N).</p>
</li>
<li>
<p>Выберите в категории Maven пункт "Веб-приложение". Нажмите 'Далее'.</p>
</li>
<li>
<p>В поле 'Имя проекта' введите <strong>WhiteboardApp</strong> и укажите местоположение проекта.</p>
</li>
<li>
<p>В поле 'ИД группы' введите <strong>org.sample</strong>. Нажмите 'Далее'.</p>
</li>
<li>
<p>В списке 'Сервер' выберите <strong>GlassFish Server 4.0</strong>.</p>
</li>
<li>
<p>В списке 'Версия Java EE' выберите <strong>Java EE 7 Web</strong>. Нажмите 'Готово'.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-newproject.png" alt="websocket newproject">
</div>
<div class="title">Figure 1. Версии сервера и Java EE в мастере создания проектов</div>
</div>
<div class="paragraph">
<p>При нажатии кнопки "Завершить" проект будет создан в среде IDE, который откроется в окне "Проекты".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Создание_терминала_websocket">Создание терминала WebSocket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Этот раздел содержит инструкции по созданию класса терминала WebSocket и файла JavaScript. Класс терминала WebSocket содержит несколько базовых методов, которые выполняются при открытии сеанса. Затем необходимо создать файл JavaScript, который запускает процесс квитирования с сервером при загрузке страницы. После этого останется только запустить приложение и проверить подключение.</p>
</div>
<div class="paragraph">
<p>Дополнительные сведения об использовании API-интерфейсов и аннотаций WebSocket см. в описании пакета <a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/package-summary.html">+ javax.websocket+</a>.</p>
</div>
<div class="sect2">
<h3 id="_Создание_терминала">Создание терминала</h3>
<div class="paragraph">
<p>В этом упражнении показано, как создать класс терминала WebSocket с помощью мастера IDE.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>В окне 'Проекты' щелкните правой кнопкой мыши узел 'Исходные пакеты' и выберите 'Создать &gt; Другие'.</p>
</li>
<li>
<p>В категории 'Веб' выберите 'Терминал WebSocket'. Нажмите 'Далее'.</p>
</li>
<li>
<p>В поле 'Имя класса' введите <strong>MyWhiteboard</strong>.</p>
</li>
<li>
<p>В списке 'Пакет' выберите  <code>org.sample.whiteboardapp</code> .</p>
</li>
<li>
<p>В поле 'WebSocket URI' введите <strong>/whiteboardendpoint</strong>. Нажмите 'Готово'.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-newendpoint.png" alt="websocket newendpoint">
</div>
<div class="title">Figure 2. Терминал WebSocket в мастере создания файлов</div>
</div>
<div class="paragraph">
<p>При нажатии кнопки 'Готово' среда IDE создает класс терминала WebSocket и открывает файл в редакторе исходного кода. При просмотре файла в редакторе вы увидите, что среда IDE сгенерировала несколько аннотаций, которые входят в состав API-интерфейса WebSocket. Класс имеет аннотацию  <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/server/ServerEndpoint.html">@ServerEndpoint</a></code> , указывающую на его принадлежность к классам терминала, а в качестве параметра аннотации указан WebSocket URI. Среда IDE также создает стандартный метод  <code>onMessage</code>  с аннотацией  <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnMessage.html">@OnMessage</a></code> . Метод с аннотацией  <code>@OnMessage</code>  вызывается каждый раз, когда клиент получает сообщение WebSocket.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ServerEndpoint("/whiteboardendpoint")
public class MyWhiteboard {

    @OnMessage
    public String onMessage(String message) {
        return null;
    }

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте в класс следующее поле (выделено <strong>полужирным шрифтом</strong>).</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ServerEndpoint("/whiteboardendpoint")
public class MyWhiteboard {
    *private static Set&lt;Session&gt; peers = Collections.synchronizedSet(new HashSet&lt;Session&gt;());*

    @OnMessage
    public String onMessage(String message) {
        return null;
    }
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте методы  <code>onOpen</code>  и  <code>onClose</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    @OnOpen
    public void onOpen (Session peer) {
        peers.add(peer);
    }

    @OnClose
    public void onClose (Session peer) {
        peers.remove(peer);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Методы  <code>onOpen</code>  и  <code>onClose</code>  имеют аннотации API-интерфейса WebSocket:  <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnOpen.html">@OnOpen</a></code>  и  <code><a href="https://javaee-spec.java.net/nonav/javadocs/javax/websocket/OnClose.html">@OnClose</a></code> . Метод с аннотацией  <code>@OnOpen</code>  вызывается при открытии сеанса WebSocket. В этом примере аннотированный метод  <code>onOpen</code>  добавляет браузерного клиента в группу одноранговых узлов текущего сеанса, а метод  <code>onClose</code>  удаляет клиента из этой группы.</p>
</div>
<div class="paragraph">
<p>Создайте методы, используя подсказки и автозавершение кода в редакторе исходного кода. Щелкните значок подсказки в левом поле рядом с объявлением класса (или поместите указатель мыши на объявление класса и нажмите Alt-Enter), затем выберите этот метод в раскрывающемся меню. Для создания кода метода можно использовать автозавершение кода.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-endpoint-hint.png" alt="websocket endpoint hint">
</div>
<div class="title">Figure 3. Подсказка к коду в редакторе исходного кода</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните правой кнопкой мыши в редакторе и выберите 'Исправить операторы импорта' (Alt-Shift-I; ⌘-Shift-I для Mac). Сохраните изменения.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>В результате в файл будут добавлены операторы импорта для классов в  <code>javax.websocket</code> .</p>
</div>
<div class="paragraph">
<p>Терминал создан. Теперь необходимо создать файл JavaScript для инициализации сеанса WebSocket.</p>
</div>
</div>
<div class="sect2">
<h3 id="_Инициализация_сеанса_websocket">Инициализация сеанса WebSocket</h3>
<div class="paragraph">
<p>Этот раздел содержит инструкции по созданию файла JavaScript для инициализации сеанса WebSocket. Браузерный клиент подключается к сеансу, используя HTTP-запрос для квитирования с сервером по протоколу TCP. В файле JavaScript необходимо указать  <code>wsURI</code>  терминала и объявить WebSocket. Схема  <code>wsURI</code>  является составным элементом протокола WebSocket и указывает путь к терминалу для приложения.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните правой кнопкой мыши узел проекта в окне "Проекты" и выберите "New &gt; Other"(Создать &gt; Другое).</p>
</li>
<li>
<p>Откройте мастер создания файлов и выберите 'Файл JavaScript' в категории 'Веб'. Нажмите 'Далее'.</p>
</li>
<li>
<p>В поле 'Имя файла JavaScript' введите <strong>websocket</strong>. Нажмите 'Готово'.</p>
</li>
<li>
<p>Добавьте в файл JavaScript следующие элементы.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var wsUri = "ws://" + document.location.host + document.location.pathname + "whiteboardendpoint";
var websocket = new WebSocket(wsUri);

websocket.onerror = function(evt) { onError(evt) };

function onError(evt) {
    writeToScreen('&lt;span style="color: red;"&gt;ERROR:&lt;/span&gt; ' + evt.data);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Этот сценарий инициализирует квитирование сеанса с сервером, когда браузер загружает файл  <code>websocket.js</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>index.html</code>  и добавьте следующий код (выделен <strong>полужирным шрифтом</strong>) в самый нижний сегмент файла, чтобы по завершении загрузки страницы загружался файл  <code>websocket.js</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">&lt;body&gt;
    *&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;*
&lt;/body&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь можно проверить функционирование терминала WebSocket, возможность открытия сеанса и подключения клиента к сеансу.</p>
</div>
</div>
<div class="sect2">
<h3 id="_Тестирование_терминала">Тестирование терминала</h3>
<div class="paragraph">
<p>В этом упражнении показано, как добавить ряд простых методов в файл JavaScript, чтобы при подключении браузера к терминалу в окне браузера выводились данные  <code>wsURI</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте тег  <code>&lt;div&gt;</code>  (выделен <strong>полужирным шрифтом</strong>) в файл  <code>index.html</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

*&lt;div id="output"&gt;&lt;/div&gt;*
&lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте следующее объявление и методы в файл  <code>websocket.js</code> . Сохраните изменения.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">// For testing purposes
var output = document.getElementById("output");
websocket.onopen = function(evt) { onOpen(evt) };

function writeToScreen(message) {
    output.innerHTML += message + "&lt;br&gt;";
}

function onOpen() {
    writeToScreen("Connected to " + wsUri);
}
// End test functions</code></pre>
</div>
</div>
<div class="paragraph">
<p>При загрузке страницы функции JavaScript будут выводить сообщение о том, что браузер подключен к терминалу. Эти функции можно удалить после успешной проверки функционирования терминала.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Правой кнопкой мыши щелкните окно 'Проект' и выберите 'Выполнить'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>При запуске приложения среда IDE запускает сервер GlassFish и выполняет построение и развертывание приложения. В браузере открывается страница индекса со следующим сообщением.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-browser1.png" alt="websocket browser1">
</div>
<div class="title">Figure 4. Сообщение 'Подключение к терминалу установлено' в окне браузера</div>
</div>
<div class="paragraph">
<p>В окне браузера отображается терминал, принимающий сообщения:  <code><a href="http://localhost:8080/WhiteboardApp/whiteboardendpoint" class="bare">http://localhost:8080/WhiteboardApp/whiteboardendpoint</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Создание_интерактивной_доски">Создание интерактивной доски</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Этот раздел содержит инструкции по созданию классов и файлов JavaScript для отправки и получения текстовых сообщений JSON. Также в этом разделе показано, как создать элемент <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html">HTML5 Canvas</a> для рисования и отображения содержимого и HTML-форму  <code>&lt;form&gt;</code>  с переключателями, с помощью которых можно выбрать форму и цвет кисти.</p>
</div>
<div class="sect2">
<h3 id="_Добавление_полотна_на_веб_страницу">Добавление полотна на веб-страницу</h3>
<div class="paragraph">
<p>В этом упражнении показано, как добавить элемент  <code>canvas</code>  и элемент  <code>form</code>  на страницу индекса по умолчанию. Флажки на форме определяют свойства кисти на полотне.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>index.html</code>  в редакторе исходного кода.</p>
</li>
<li>
<p>Удалите тег  <code>&lt;div&gt;</code> , добавленный перед тестированием терминала, и добавьте элементы  <code>&lt;table&gt;</code>  и  <code>&lt;form&gt;</code>  (выделены <strong>полужирным шрифтом</strong>) после открывающего тега body.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">&lt;h1&gt;Collaborative Whiteboard App&lt;/h1&gt;

    *&lt;table&gt;
        &lt;tr&gt;
            &lt;td&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;form name="inputForm"&gt;


                &lt;/form&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/table&gt;*
    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;
    &lt;/body&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте следующий код (выделен <strong>полужирным шрифтом</strong>) для элемента canvas.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">        &lt;table&gt;
            &lt;tr&gt;
                &lt;td&gt;
                    *&lt;canvas id="myCanvas" width="150" height="150" style="border:1px solid #000000;"&gt;&lt;/canvas&gt;*
                &lt;/td&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте элемент  <code>&lt;table&gt;</code>  для создания переключателей, позволяющих выбирать цвет и форму. Сохраните изменения.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">        &lt;table&gt;
            &lt;tr&gt;
                &lt;td&gt;
                    &lt;canvas id="myCanvas" width="150" height="150" style="border:1px solid #000000;"&gt;&lt;/canvas&gt;
                &lt;/td&gt;
                &lt;td&gt;
                    &lt;form name="inputForm"&gt;
                        *&lt;table&gt;

                            &lt;tr&gt;
                                &lt;th&gt;Color&lt;/th&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#FF0000" checked="true"&gt;Red&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#0000FF"&gt;Blue&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#FF9900"&gt;Orange&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="color" value="#33CC33"&gt;Green&lt;/td&gt;
                            &lt;/tr&gt;

                            &lt;tr&gt;
                                &lt;th&gt;Shape&lt;/th&gt;
                                &lt;td&gt;&lt;input type="radio" name="shape" value="square" checked="true"&gt;Square&lt;/td&gt;
                                &lt;td&gt;&lt;input type="radio" name="shape" value="circle"&gt;Circle&lt;/td&gt;
                                &lt;td&gt; &lt;/td&gt;
                                &lt;td&gt; &lt;/td&gt;
                            &lt;/tr&gt;

                        &lt;/table&gt;*
                    &lt;/form&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Форма, цвет и координаты любой фигуры, нарисованной на полотне, преобразуются в строковые данные в структуре JSON и отправляются в виде сообщения на терминал WebSocket.</p>
</div>
</div>
<div class="sect2">
<h3 id="_Создание_pojo">Создание POJO</h3>
<div class="paragraph">
<p>В этом упражнении показано, как создать простой компонент POJO.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните узел проекта правой кнопкой мыши и выберите Создать &gt; Класс Java.</p>
</li>
<li>
<p>В поле 'Имя класса' введите <strong>Figure</strong> и выберите  <code>org.sample.whiteboardapp</code>  в списке 'Пакет'. Нажмите 'Готово'.</p>
</li>
<li>
<p>В редакторе исходного кода добавьте следующие элементы (выделены <strong>полужирным шрифтом</strong>):</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class Figure {
    *private JsonObject json;*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>При добавлении кода отобразится запрос на добавление оператора импорта для  <code>javax.json.JsonObject</code> . Если запрос не отображается, нажмите Alt-Enter.</p>
</div>
<div class="paragraph">
<p>Дополнительные сведения о  <code>javax.json.JsonObject</code>  см. в описании интерфейса Java API for JSON Processing (<a href="http://jcp.org/en/jsr/detail?id=353">JSR 353</a>), который входит в спецификацию Java EE 7.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Создайте операторы получения и установки для  <code>json</code> .</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Методы получения и установки можно выбрать в раскрывающемся меню 'Вставить код' (Alt-Ins в Windows; Ctrl-I в Mac). В результате откроется диалоговое окно 'Создание методов получения и установки'. Также можно выбрать Исходный код &gt; Вставить код в главном меню.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-generategetter.png" alt="websocket generategetter">
</div>
<div class="title">Figure 5. Диалоговое окно 'Создание методов получения и установки'</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте конструктор для  <code>json</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    public Figure(JsonObject json) {
        this.json = json;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Конструктор можно выбрать в раскрывающемся меню 'Вставить код' (Ctrl-I).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-generateconstructor.png" alt="websocket generateconstructor">
</div>
<div class="title">Figure 6. Раскрывающееся меню 'Создать конструктор'</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте метод  <code>toString</code> :</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    @Override
    public String toString() {
        StringWriter writer = new StringWriter();
        Json.createWriter(writer).write(json);
        return writer.toString();
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните правой кнопкой мыши в редакторе и выберите 'Исправить операторы импорта' (Alt-Shift-I; ⌘-Shift-I для Mac). Сохраните изменения.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_Создание_класса_координат">Создание класса координат</h3>
<div class="paragraph">
<p>Теперь необходимо создать класс координат фигур, которые пользователи будут рисовать на полотне.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните узел проекта правой кнопкой мыши и выберите Создать &gt; Класс Java.</p>
</li>
<li>
<p>Откроется мастер создания классов Java. В поле 'Имя класса' введите <strong>Coordinates</strong> и выберите  <code>org.sample.whiteboardapp</code>  в списке 'Пакет'. Нажмите 'Готово'.</p>
</li>
<li>
<p>В редакторе исходного кода добавьте следующий код. Сохраните изменения.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    private float x;
    private float y;

    public Coordinates() {
    }

    public Coordinates(float x, float y) {
        this.x = x;
        this.y = y;
    }

    public float getX() {
        return x;
    }

    public void setX(float x) {
        this.x = x;
    }

    public float getY() {
        return y;
    }

    public void setY(float y) {
        this.y = y;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Этот класс содержит только поля для координат  <code>x</code>  и  <code>y</code> , а также несколько методов получения и установки.</p>
</div>
</div>
<div class="sect2">
<h3 id="_Создание_строки_json">Создание строки JSON</h3>
<div class="paragraph">
<p>В этом упражнении показано, как создать файл JavaScript, преобразующий все сведения о фигуре, которую пользователь рисует на полотне (элемент  <code>canvas</code> ), в структуру JSON для отправки на терминал WebSocket.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните узел проекта правой кнопкой мыши и выберите Создать &gt; Файл JavaScript. В результате откроется мастер создания файлов JavaScript.</p>
</li>
<li>
<p>В поле 'Имя файла' введите <strong>whiteboard</strong>. Нажмите 'Готово'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>При нажатии кнопки 'Готово' среда IDE создает пустой файл JavaScript и открывает его в редакторе. Новый файл отображается в структуре узла 'Веб-страницы' в окне 'Проекты'.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте следующий код для инициализации элемента canvas и создания прослушивателя событий.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">var canvas = document.getElementById("myCanvas");
var context = canvas.getContext("2d");
canvas.addEventListener("click", defineImage, false);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Когда пользователь нажимает на полотно (элемент  <code>canvas</code> ), вызывается метод  <code>defineImage</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте методы  <code>getCurrentPos</code> ,  <code>defineImage</code>  и  <code>drawImageText</code>  для создания структуры JSON и ее отправки на терминал ( <code>sendText(json)</code> ).</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function getCurrentPos(evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}

function defineImage(evt) {
    var currentPos = getCurrentPos(evt);

    for (i = 0; i &lt; document.inputForm.color.length; i++) {
        if (document.inputForm.color[i].checked) {
            var color = document.inputForm.color[i];
            break;
        }
    }

    for (i = 0; i &lt; document.inputForm.shape.length; i++) {
        if (document.inputForm.shape[i].checked) {
            var shape = document.inputForm.shape[i];
            break;
        }
    }

    var json = JSON.stringify({
        "shape": shape.value,
        "color": color.value,
        "coords": {
            "x": currentPos.x,
            "y": currentPos.y
        }
    });
    drawImageText(json);
        sendText(json);
}

function drawImageText(image) {
    console.log("drawImageText");
    var json = JSON.parse(image);
    context.fillStyle = json.color;
    switch (json.shape) {
    case "circle":
        context.beginPath();
        context.arc(json.coords.x, json.coords.y, 5, 0, 2 * Math.PI, false);
        context.fill();
        break;
    case "square":
    default:
        context.fillRect(json.coords.x, json.coords.y, 10, 10);
        break;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Готовая к отправке структура JSON будет выглядеть примерно так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">{
 "shape": "square",
 "color": "#FF0000",
 "coords": {
 "x": 31.59999942779541,
 "y": 49.91999053955078
 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь необходимо добавить метод  <code>sendText(json)</code>  для отправки строковых данных JSON с помощью  <code>websocket.send()</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>websocket.js</code>  в редакторе и добавьте следующие методы для отправки JSON на терминал и рисования изображения при получении сообщения от терминала.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">websocket.onmessage = function(evt) { onMessage(evt) };

function sendText(json) {
    console.log("sending text: " + json);
    websocket.send(json);
}

function onMessage(evt) {
    console.log("received: " + evt.data);
    drawImageText(evt.data);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Код, добавленный в файл  <code>websocket.js</code>  для тестирования терминала, можно удалить.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте следующую строку (выделена <strong>полужирным шрифтом</strong>) в нижний сегмент файла  <code>index.html</code>  для загрузки файла  <code>whiteboard.js</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">        &lt;/table&gt;
    &lt;script type="text/javascript" src="websocket.js"&gt;&lt;/script&gt;
    *&lt;script type="text/javascript" src="whiteboard.js"&gt;&lt;/script&gt;*
&lt;body&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_Реализация_интерфейсов_кодера_и_декодера">Реализация интерфейсов кодера и декодера</h3>
<div class="paragraph">
<p>В этом упражнении показано, как создать классы для реализации интерфейсов декодера и кодера, которые требуются для преобразования сообщений WebSocket (JSON) в класс POJO  <code>Figure</code>  и преобразования класса  <code>Figure</code>  в формат строковых данных JSON, отправляемых на терминал.</p>
</div>
<div class="paragraph">
<p>Дополнительные сведения можно найти в разделе технической статьи о типах сообщений, кодерах и декодерах <a href="http://www.oracle.com/technetwork/articles/java/jsr356-1937161.html">JSR 356, Java API for WebSocket</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните узел проекта правой кнопкой мыши и выберите Создать &gt; Класс Java.</p>
</li>
<li>
<p>В поле 'Имя класса' введите <strong>FigureEncoder</strong> и выберите  <code>org.sample.whiteboardapp</code>  в списке 'Пакет'. Нажмите 'Готово'.</p>
</li>
<li>
<p>В редакторе исходного кода реализуйте интерфейс кодера WebSocket. Для этого добавьте следующий код (выделен <strong>полужирным шрифтом</strong>):</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class FigureEncoder *implements Encoder.Text&lt;Figure&gt;* {

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте оператор импорта для  <code>javax.websocket.Encoder</code>  и реализуйте абстрактные методы.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Поместите указатель мыши на объявление класса, нажмите Alt-Enter и выберите <strong>Реализовать все абстрактные методы</strong> в раскрывающемся меню.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Внесите следующие изменения в созданные абстрактные методы (выделены <strong>полужирным шрифтом</strong>). Сохраните изменения.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    @Override
    public String encode(Figure *figure*) throws EncodeException {
        *return figure.getJson().toString();*
    }

    @Override
    public void init(EndpointConfig ec) {
        *System.out.println("init");*
    }

    @Override
    public void destroy() {
        *System.out.println("destroy");*
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните узел проекта правой кнопкой мыши и выберите Создать &gt; Класс Java.</p>
</li>
<li>
<p>В поле 'Имя класса' введите <strong>FigureDecoder</strong> и выберите  <code>org.sample.whiteboardapp</code>  в списке 'Пакет'. Нажмите 'Готово'.</p>
</li>
<li>
<p>В редакторе исходного кода реализуйте интерфейс декодера WebSocket. Для этого добавьте следующий код (выделен <strong>полужирным шрифтом</strong>):</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class FigureDecoder *implements Decoder.Text&lt;Figure&gt;* {

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте оператор импорта для  <code>javax.websocket.Decoder</code>  и реализуйте абстрактные методы.</p>
</li>
<li>
<p>Внесите следующие изменения (выделены <strong>полужирным шрифтом</strong>) в созданные абстрактные методы.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    @Override
    public Figure decode(String *string*) throws DecodeException {
        *JsonObject jsonObject = Json.createReader(new StringReader(string)).readObject();
        return  new Figure(jsonObject);*
    }

    @Override
    public boolean willDecode(String *string*) {
        *try {
            Json.createReader(new StringReader(string)).readObject();
            return true;
        } catch (JsonException ex) {
            ex.printStackTrace();
            return false;
        }*

    }

    @Override
    public void init(EndpointConfig ec) {
        *System.out.println("init");*
    }

    @Override
    public void destroy() {
        *System.out.println("destroy");*
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Исправьте операторы импорта и сохраните изменения.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Теперь необходимо внести изменения в файл  <code>MyWhiteboard.java</code>  и указать кодер и декодер.</p>
</div>
</div>
<div class="sect2">
<h3 id="_Запуск_приложения">Запуск приложения</h3>
<div class="paragraph">
<p>Скоро вы сможете запустить приложение. В этом упражнении показано, как изменить класс терминала WebSocket и указать кодер и декодер для строковых данных JSON, а также добавить метод для отправки строковых данных JSON на подключенные клиенты при получении сообщения.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>MyWhiteboard.java</code>  в редакторе.</p>
</li>
<li>
<p>Измените аннотацию  <code>@ServerEndpoint</code>  и укажите кодер и декодер для терминала. Обратите внимание, что необходимо явно указать параметр  <code>value</code>  для имени терминала.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@ServerEndpoint(*value=*"/whiteboardendpoint"*, encoders = {FigureEncoder.class}, decoders = {FigureDecoder.class}*)</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Удалите метод  <code>onMessage</code> , созданный по умолчанию.</p>
</li>
<li>
<p>Добавьте метод  <code>broadcastFigure</code>  и создайте для него аннотацию  <code>@OnMessage</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">    @OnMessage
    public void broadcastFigure(Figure figure, Session session) throws IOException, EncodeException {
        System.out.println("broadcastFigure: " + figure);
        for (Session peer : peers) {
            if (!peer.equals(session)) {
                peer.getBasicRemote().sendObject(figure);
            }
        }
    }</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Щелкните правой кнопкой мыши в редакторе и выберите 'Исправить операторы импорта' (Alt-Shift-I; ⌘-Shift-I для Mac). Сохраните изменения.</p>
</li>
<li>
<p>В окне 'Проекты' щелкните проект правой кнопкой мыши и выберите 'Выполнить'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>При нажатии кнопки 'Выполнить' среда IDE открывает окно браузера с адресом <a href="http://localhost:8080/WhiteboardApp/">http://localhost:8080/WhiteboardApp/</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Может потребоваться удалить предыдущее приложение с сервера приложений или выполнить принудительную перезагрузку страницы в браузере.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Просмотрите сообщения браузера. Вы увидите, что при каждом нажатии на полотно на терминал отправляются строковые данные JSON.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-onebrowser.png" alt="websocket onebrowser">
</div>
<div class="title">Figure 7. Полотно с нарисованными фигурами в окне браузера и JSON в веб-консоли</div>
</div>
<div class="paragraph">
<p>Если открыть страницу с адресом  <code><a href="http://localhost:8080/WhiteboardApp/" class="bare">http://localhost:8080/WhiteboardApp/</a></code>  в другом браузере, можно видеть, что при каждом нажатии на полотно в окне одного браузера в окне другого браузера появляется новый круг или квадрат.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-twobrowsers.png" alt="websocket twobrowsers">
</div>
<div class="title">Figure 8. Два браузера, отправляющие данные JSON через терминал</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_Отправка_двоичных_данных_на_терминал">Отправка двоичных данных на терминал</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Теперь приложение может обрабатывать и отправлять строковые данные через JSON на терминал, а затем эти строковые данные будут пересылаться на подключенные клиенты. Этот раздел содержит инструкции по изменению файлов JavaScript для отправки и получения двоичных данных.</p>
</div>
<div class="paragraph">
<p>Чтобы отправлять двоичные данные на терминал, необходимо задать для свойства  <code>binaryType</code>  компонента WebSocket значение  <code>arraybuffer</code> . Таким образом гарантируется, что любые двоичные данные, передаваемые посредством WebSocket, передаются посредством  <code>ArrayBuffer</code> . Преобразование двоичных данных осуществляется методом  <code>defineImageBinary</code>  в файле  <code>whiteboard.js</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>websocket.js</code>  и добавьте в него следующий код, чтобы задать для свойства  <code>binaryType</code>  компонента WebSocket значение  <code>arraybuffer</code> .</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">websocket.binaryType = "arraybuffer";</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Добавьте следующий метод для отправки двоичных данных на терминал.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function sendBinary(bytes) {
    console.log("sending binary: " + Object.prototype.toString.call(bytes));
    websocket.send(bytes);
}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Измените метод  <code>onMessage</code>  и добавьте в него следующий код (выделен <strong>полужирным шрифтом</strong>), чтобы выбрать метод обновления полотна в соответствии с типом данных, переданных во входящем сообщении.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function onMessage(evt) {
    console.log("received: " + evt.data);
    *if (typeof evt.data == "string") {*
        drawImageText(evt.data);
    *} else {
        drawImageBinary(evt.data);
    }*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Метод  <code>drawImageBinary</code>  вызывается при получении сообщения с двоичными данными.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>whiteboard.js</code>  и добавьте следующие методы. Метод  <code>drawImageBinary</code>  вызывается для обновления полотна после анализа входных двоичных данных. Метод  <code>defineImageBinary</code>  используется для подготовки снимка полотна в двоичном формате.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">function drawImageBinary(blob) {
    var bytes = new Uint8Array(blob);
//    console.log('drawImageBinary (bytes.length): ' + bytes.length);

    var imageData = context.createImageData(canvas.width, canvas.height);

    for (var i=8; i&lt;imageData.data.length; i++) {
        imageData.data[i] = bytes[i];
    }
    context.putImageData(imageData, 0, 0);

    var img = document.createElement('img');
    img.height = canvas.height;
    img.width = canvas.width;
    img.src = canvas.toDataURL();
}

function defineImageBinary() {
    var image = context.getImageData(0, 0, canvas.width, canvas.height);
    var buffer = new ArrayBuffer(image.data.length);
    var bytes = new Uint8Array(buffer);
    for (var i=0; i&lt;bytes.length; i++) {
        bytes[i] = image.data[i];
    }
    sendBinary(buffer);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь необходимо реализовать вызов метода  <code>defineImageBinary</code> , когда требуется сгенерировать двоичные данные с типом  <code>ArrayBuffer</code>  и отправить их на терминал.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>index.html</code>  и измените элемент  <code>&lt;table&gt;</code>  так, чтобы в таблице формы появилась следующая строка.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">&lt;tr&gt;
    &lt;th&gt; &lt;/th&gt;
    &lt;td&gt;&lt;input type="submit" value="Send Snapshot" onclick="defineImageBinary(); return false;"&gt;&lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Новая строка содержит кнопку 'Отправить снимок', которая позволяет отправить двоичный снимок полотна на подключенные одноранговые узлы. При нажатии этой кнопки вызывается метод  <code>defineImageBinary</code>  в файле  <code>whiteboard.js</code> .</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>MyWhiteboard.java</code>  и добавьте следующий метод. Этот метод используется для отправки двоичных данных на одноранговые узлы, когда на терминал поступает сообщение с двоичными данными.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@OnMessage
public void broadcastSnapshot(ByteBuffer data, Session session) throws IOException {
    System.out.println("broadcastBinary: " + data);
    for (Session peer : peers) {
        if (!peer.equals(session)) {
            peer.getBasicRemote().sendBinary(data);
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Потребуется добавить оператор импорта для  <code>java.nio.ByteBuffer</code> .
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Вы можете изменить приложение так, чтобы пользователь мог остановить отправку данных на терминал. По умолчанию все одноранговые узлы подключаются в момент открытия страницы и отправки данных из браузера на все подключенные клиенты. Вы можете добавить простой условный оператор, чтобы данные отправлялись на терминал только в том случае, если выбран этот параметр. Этот параметр не влияет на получение данных. Клиенты по-прежнему будут получать данные от терминала.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Измените метод  <code>defineImage</code>  в файле  <code>whiteboard.js</code> , добавив в него следующий код (выделен <strong>полужирным шрифтом</strong>).</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-javascript" data-lang="javascript">        drawImageText(json);
*    if (document.getElementById("instant").checked) {*
        sendText(json);
*    }*
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Этот код условия проверяет,  <code>установлен ли флажок</code>  для элемента с этим идентификатором</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Откройте файл  <code>index.html</code>  и измените элемент  <code>&lt;table&gt;</code> , добавив в форму флажок.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-html" data-lang="html">&lt;tr&gt;
    &lt;th&gt; &lt;/th&gt;
    &lt;td&gt;&lt;input type="submit" value="Send Snapshot" onclick="defineImageBinary(); return false;"&gt;&lt;/td&gt;
    &lt;td&gt;*&lt;input type="checkbox" id="instant" value="Online" checked="true"&gt;Online*&lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
    &lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Если флажок 'Подключено' не установлен, отправка данных не осуществляется, но клиенты по-прежнему могут получать данные от терминала.</p>
</div>
<div class="paragraph">
<p>Если добавить кнопку 'Отправить снимок' и флажок 'Подключено' и снова запустить приложение, на странице индекса отобразятся новые элементы. Если открыть другой браузер и снять флажок 'Подключено', можно видеть, что при нажатии на полотно сообщение JSON не отправляется на терминал.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/websocket-onebrowser-binary.png" alt="websocket onebrowser binary">
</div>
<div class="title">Figure 9. Веб-консоль в окне браузера с сообщением об отправке двоичных данных</div>
</div>
<div class="paragraph">
<p>Если нажать кнопку 'Отправить снимок', двоичные данные будут отправлены на терминал, который будет транслировать эти данные на все подключенные клиенты.</p>
</div>
<div class="paragraph">
<p><a href="/about/contact_form.html?to=3&amp;subject=Feedback:%20Using%20the%20WebSocket%20API%20in%20a%20Web%20Application">Отправить отзыв по этому учебному курсу</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_См_также">См. также</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Подробнее об использовании IDE NetBeans для разработки приложений Java EE см. в следующих ресурсах:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Демонстрация: <a href="maven-websocketapi-screencast.html">Использование WebSocket API в веб-приложении</a></p>
</li>
<li>
<p><a href="javaee-intro.html">+Введение в технологию Java EE +</a></p>
</li>
<li>
<p><a href="javaee-gettingstarted.html">Начало работы с приложениями Java EE</a></p>
</li>
<li>
<p><a href="../../trails/java-ee.html">Учебная карта по Java EE и Java Web</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Дополнительные сведения об использовании Java EE можно найти в <a href="http://download.oracle.com/javaee/6/tutorial/doc/">Учебном курсе по Java EE</a>.</p>
</div>
<div class="paragraph">
<p>To send comments and suggestions, get support, and keep informed on the latest developments on the IDE NetBeans Java EE development features, <a href="../../../community/lists/top.html">join the nbj2ee mailing list</a>.</p>
</div>
</div>
</div>
            
<section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="JIRA" href="https://issues.apache.org/jira/projects/NETBEANS/summary"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        
        <li><a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/maven-websocketapi_ru.asciidoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>

        </div>
        

<div class='grid-container incubator-area' style='margin-top: 64px'>
    <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/">
                <img style="width: 320px" title="Apache Software Foundation" src="/images/asf_logo_wide.svg" />
            </a>
        </div>
        <div class='large-auto cell text-center'>
            <a href="https://www.apache.org/events/current-event.html">
               <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
            </a>
        </div>
    </div>
</div>
<footer>
    <div class="grid-container">
        <div class="grid-x grid-padding-x">
            <div class="large-auto cell">
                
                <h1><a href="/about/index.html">About</a></h1>
                <ul>
                    <li><a href="https://netbeans.apache.org/community/who.html">Who's Who</a></li>
                    <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                    <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                    <li><a href="https://www.apache.org/security/">Security</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/community/index.html">Community</a></h1>
                <ul>
                    <li><a href="/community/mailing-lists.html">Mailing lists</a></li>
                    <li><a href="/community/committer.html">Becoming a committer</a></li>
                    <li><a href="/community/events.html">NetBeans Events</a></li>
                    <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/participate/index.html">Participate</a></h1>
                <ul>
                    <li><a href="/participate/submit-pr.html">Submitting Pull Requests</a></li>
                    <li><a href="/participate/report-issue.html">Reporting Issues</a></li>
                    <li><a href="/participate/index.html#documentation">Improving the documentation</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/help/index.html">Get Help</a></h1>
                <ul>
                    <li><a href="/help/index.html#documentation">Documentation</a></li>
                    <li><a href="/wiki/index.asciidoc">Wiki</a></li>
                    <li><a href="/help/index.html#support">Community Support</a></li>
                    <li><a href="/help/commercial-support.html">Commercial Support</a></li>
                </ul>
            </div>
            <div class="large-auto cell">
                <h1><a href="/download/nb110/nb110.html">Download</a></h1>
                <ul>
                    <li><a href="/download/index.html">Releases</a></li>                    
                    <li><a href="/plugins/index.html">Plugins</a></li>
                    <li><a href="/download/index.html#source">Building from source</a></li>
                    <li><a href="/download/index.html#previous">Previous releases</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>
<div class='footer-disclaimer'>
    <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2019 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
            <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
            <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
        </div>
        
    </div>
</div>



        <script src="/js/vendor/jquery-3.2.1.min.js"></script>
        <script src="/js/vendor/what-input.js"></script>
        <script src="/js/vendor/jquery.colorbox-min.js"></script>
        <script src="/js/vendor/foundation.min.js"></script>
        <script src="/js/netbeans.js"></script>
        <script>
            
            $(function(){ $(document).foundation(); });
        </script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        <script>
         $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); }); 
        </script>
        
    </body>
</html>
