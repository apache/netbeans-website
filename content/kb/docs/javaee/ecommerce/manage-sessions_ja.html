
<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>NetBeans Eコマースのチュートリアル - セッションの管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NetBeans Eコマースのチュートリアル - セッションの管理 - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, NetBeans Eコマースのチュートリアル - セッションの管理">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css"> 
    <link rel="stylesheet" href="/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="/css/font-open-sans.css" rel="stylesheet">
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
  </head>
  <body>
    

<div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="/"><img src='/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <a href="/community/index.html">Community</a> </li>
            <li> <a href="/participate/index.html">Participate</a> </li>
            <li> <a href="/blogs/index.html">Blog</a></li>
            <li> <a href="/help/index.html">Get Help</a> </li>
            <li> <a href="https://plugins.netbeans.apache.org/">Plugins</a> </li>
            <li> <a href="/download/index.html">Download</a> </li>
        </ul>
    </div>
</div>


    
<!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Latest release</div>
            <h1>Apache NetBeans 18</h1>
            <p><a class="button success" href="/download/nb18/">Download</a></p>
        </div>
    </div>
</section>

    <div class='grid-container main-content tutorial'>
      <h1 class="sect0">NetBeans Eコマースのチュートリアル - セッションの管理</h1>
            
            <div class="sectionbody">
              <div class="admonitionblock note">
                <table>
                  <tbody><tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">This tutorial needs a review. 
                     You can <a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/ecommerce/manage-sessions_ja.adoc" title="Edit this tutorial in github">edit it in GitHub </a>
                     following these <a href="/kb/docs/contributing.html">contribution guidelines.</a></td>
                  </tr></tbody>
                </table>
              </div>
            </div>
            
      <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#session-data">セッション・データの処理</a>
<ul class="sectlevel2">
<li><a href="#httpSession">HttpSessionオブジェクトの操作</a></li>
<li><a href="#scopedVariables">Webアプリケーションでのスコープ指定された変数の操作</a></li>
</ul>
</li>
<li><a href="#debug">Javaデバッガによるセッション・データの確認</a>
<ul class="sectlevel2">
<li><a href="#_カテゴリページ">カテゴリ・ページ</a></li>
<li><a href="#cartPage">カート・ページ</a></li>
<li><a href="#_チェックアウトページ">チェックアウト・ページ</a></li>
<li><a href="#_ideのjavadocサポートの利用">IDEのJavadocサポートの利用</a></li>
</ul>
</li>
<li><a href="#session-track">セッション・トラック・オプションの確認</a>
<ul class="sectlevel2">
<li><a href="#http-monitor">HTTPモニターによるクライアントとサーバー間の通信の確認</a></li>
<li><a href="#url-rewrite">URL書換えによるセッションの維持</a></li>
</ul>
</li>
<li><a href="#time-out">セッション・タイム・アウトの処理</a>
<ul class="sectlevel2">
<li><a href="#time-interval">セッションの時間間隔の設定</a></li>
<li><a href="#programmatically">プログラムによるセッション・タイム・アウトの処理</a></li>
</ul>
</li>
<li><a href="#seeAlso">関連項目</a>
<ul class="sectlevel2">
<li><a href="#_netbeansリソース">NetBeansリソース</a></li>
<li><a href="#_glassfishリソース">GlassFishリソース</a></li>
<li><a href="#_技術記事およびその他のリソース">技術記事およびその他のリソース</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="intro.html">概要</a></p>
</li>
<li>
<p><a href="design.html">アプリケーションの設計</a></p>
</li>
<li>
<p><a href="setup-dev-environ.html">開発環境の設定</a></p>
</li>
<li>
<p><a href="data-model.html">データ・モデルの設計</a></p>
</li>
<li>
<p><a href="page-views-controller.html">ページ・ビューおよびコントローラ・サーブレットの準備</a></p>
</li>
<li>
<p><a href="connect-db.html">データベースへのアプリケーションの接続</a></p>
</li>
<li>
<p><a href="entity-session.html">エンティティ・クラスおよびセッションBeanの追加</a></p>
</li>
<li>
<p><strong>セッションの管理</strong></p>
</li>
<li>
<p><a href="transaction.html">トランザクション・ビジネス・ロジックの統合</a></p>
</li>
<li>
<p><a href="language.html">言語サポートの追加</a></p>
</li>
<li>
<p><a href="security.html">アプリケーションの保護</a></p>
</li>
<li>
<p><a href="test-profile.html">テストとプロファイリング</a></p>
</li>
<li>
<p><a href="conclusion.html">まとめ</a></p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../../images_www/articles/68/netbeans-stamp-68-69.png" alt="netbeans stamp 68 69">
</div>
<div class="title">Figure 1. このページの内容は、NetBeans IDEバージョン6.8および6.9に適用されます</div>
</div>
<div class="paragraph">
<p>なんらかのショッピング・カート機能を提供するすべてのEコマース・アプリケーションでは、ユーザーがWebサイトの中でクリックしたときにユーザー固有のデータを覚える必要があります。開発者にとって残念ですが、インターネットの通信で使用されるHTTPプロトコルは_ステートレス_なプロトコルです。サーバーが受け取る各リクエストは、以前に受け取ったリクエストとは無関係の独立した情報です。このため、顧客がボタンをクリックして自分のショッピング・カートに項目を追加したら、アプリケーションはこのユーザーのカートの状態を更新するのみでなく、このアクションが、同時にサイトをブラウズしているユーザーのカートに影響しないようにする必要があります。</p>
</div>
<div class="paragraph">
<p>上記のシナリオを適切に処理するには、ユーザーがサイトにアクセスしている間、_セッション_を作成し、セッションを維持できるようにする機能を実装する必要があります。このために、すべてのJavaベースのWebアプリケーションの基盤であるサーブレット・テクノロジには<a href="http://java.sun.com/javaee/6/docs/api/javax/servlet/http/HttpSession.html">`HttpSession`</a>インタフェースが用意されています。また、セッションが維持されている間、アプリケーションが一時的にユーザー・データを格納できるようにする`ShoppingCart`および`ShoppingCartItem`というクラスを定義する必要があります。</p>
</div>
<div class="paragraph">
<p>このチュートリアル・ユニットでは、他のNetBeans Eコマースのチュートリアルとは異なる方法を取ります。プロジェクト・ファイルを作成してそのプロジェクトにコピーして貼付けできるコード・スニペットを提供するという手順に従うのではなく、このユニットの完成したプロジェクトのスナップショットを開き、IDEデバッガやその他のツールを使用してコードを調べます。このプロセスの中で、`HttpSession`オブジェクトをコードに適用して、Webサイトへのアクセスごとに専用のセッションを作成する方法を学習します。また、_スコープ指定された変数_について、およびそれをJavaクラスやJSPページで使用する方法についても学習します。このユニットでは、セッションを維持するための`HttpSession`のデフォルト機構(Cookie)についても説明し、ユーザーのブラウザでCookieが非アクティブ化されている場合に必要となる手順を示します。ユニットの最後ではセッション・タイム・アウトについても触れ、リクエストをインターセプトしてセッションが存在するかどうかを確認する単純なフィルタを作成して、セッション・タイム・アウトを処理する方法を示します。</p>
</div>
<div class="paragraph">
<p>このチュートリアルでビルドするアプリケーションのライブ・デモを、<a href="http://dot.netbeans.org:8080/AffableBean/">NetBeans Eコマースのチュートリアルのデモ・アプリケーション</a>で表示できます。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ソフトウェアまたはリソース</th>
<th class="tableblock halign-left valign-top">必須バージョン</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://netbeans.org/downloads/index.html">NetBeans IDE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Javaバンドル版、6.8または6.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Java Development Kit (JDK)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バージョン6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#glassFish">GlassFishサーバー</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v3またはOpen Source Edition 3.0.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://dev.mysql.com/downloads/mysql/">MySQLデータベース・サーバー</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">バージョン5.1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://netbeans.org/projects/samples/downloads/download/Samples%252FJavaEE%252Fecommerce%252FAffableBean_snapshot5.zip">AffableBeanプロジェクト</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">スナップショット5</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>*注意: *</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NetBeans IDEが正常に動作するには、JDK (Java Development Kit)が必要です。上記に一覧表示されているいずれのリソースもインストールされていない場合は、最初にJDKをダウンロードしてインストールするようにしてください。</p>
</li>
<li>
<p>NetBeans IDEのJavaバンドル版には、このチュートリアルでビルドするアプリケーションに必要なJava WebおよびEEテクノロジが含まれています。</p>
</li>
<li>
<p>NetBeans IDEのJavaバンドル版には、このチュートリアルに必要なGlassFishサーバーも含まれています。<a href="https://glassfish.dev.java.net/public/downloadsindex.html">GlassFishサーバーを別個にダウンロードする</a>こともできますが、NetBeansダウンロードに付属するバージョンを使用すると、IDEに自動的に登録されるので便利です。</p>
</li>
<li>
<p>このチュートリアル・ユニットは、以前のユニットを完了させていなくても進めることができます。そのために、データベースの準備や、IDE、GlassFishおよびMySQL間の接続の確立について説明した<a href="setup.html">設定手順</a>を参照してください。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="session-data">セッション・データの処理</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アプリケーションは、`HttpSession`オブジェクトを使用してユーザー・セッションを管理できます。ユーザー固有のデータを`HttpSession`オブジェクトにバインドして、後でこのデータにアクセスできます。バインドとアクセスの両方のアクションは、Javaクラスから行うことも、EL式のセッション・スコープ指定された変数から行うことも可能です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#httpSession">HttpSessionオブジェクトの操作</a></p>
</li>
<li>
<p><a href="#scopedVariables">Webアプリケーションでのスコープ指定された変数の操作</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="httpSession">HttpSessionオブジェクトの操作</h3>
<div class="paragraph">
<p>`AffableBean`アプリケーションは`HttpSession`オブジェクトを使用して、複数のリクエストにわたってユーザーを識別します。`HttpSession`オブジェクトを取得するには、特定のリクエストで次のように`getSession()`を使用します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">HttpSession session = request.getSession();</code></pre>
</div>
</div>
<div class="paragraph">
<p>そのリクエストのセッション・オブジェクトがまだ存在しない場合、このメソッドは新しいセッションを作成して返します。</p>
</div>
<div class="paragraph">
<p>セッション・オブジェクトは、リクエスト間でデータを渡すための輸送手段として使用できます。オブジェクトをセッションにバインドするには、`setAttribute`メソッドを使用します。同様に、オブジェクトをセッションから取得するには、`getAttribute`を使用します。たとえば`AffableBean`アプリケーションでは、次の方法でユーザーのショッピング・カートが作成され、ユーザー・セッションにバインドされます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">ShoppingCart cart = new ShoppingCart();
session.setAttribute("cart", cart);</code></pre>
</div>
</div>
<div class="paragraph">
<p>セッションからカートを取得するために、次のように`getAttribute`メソッドが適用されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">cart = (ShoppingCart) session.getAttribute("cart");</code></pre>
</div>
</div>
<div class="paragraph">
<p>JSPページでは、セッションにバインドされているオブジェクトにEL式を使用してアクセスできます。上記の例を続けて使用します。「<code>cart</code>」という名前の`ShoppingCart`オブジェクトがセッションにバインドされている場合、次のEL式を使用することでこのオブジェクトにアクセスできます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">${cart}</code></pre>
</div>
</div>
<div class="paragraph">
<p>しかし、`ShoppingCart`オブジェクト自体にアクセスしてもほとんど意味がありません。本当に必要なのは、オブジェクトに格納されている値にアクセスするための方法です。プロジェクトのスナップショットで新しい`ShoppingCart`クラスを調べると、次のプロパティが含まれていることがわかります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>double total</code></p>
</li>
<li>
<p><code>int numberOfItems</code></p>
</li>
<li>
<p><code>List&lt;String, ShoppingCartItem&gt; items</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>プロパティに対応する取得メソッドがあれば、EL式で単純なドット表記法を使用して個々のプロパティの値にアクセスできます。`cart.jsp`ページを調べると、次のように、ちょうどこの方法で`numberOfItems`の値にアクセスしているのが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="html">&lt;p&gt;Your shopping cart contains ${cart.numberOfItems} items.&lt;/p&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>上記の`items`リストのような複数の値を含むプロパティからデータを抽出するために、<code>cart.jsp`ページでは次のように</code>&lt;c:forEach&gt;`ループを使用しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;c:forEach var="cartItem" items="${cart.items}" varStatus="iter"&gt;

  &lt;c:set var="product" value="${cartItem.product}"/&gt;

    &lt;tr class="${((iter.index % 2) == 0) ? 'lightBlue' : 'white'}"&gt;
        &lt;td&gt;
            &lt;img src="${initParam.productImagePath}${product.name}.png"
                 alt="${product.name}"&gt;
        &lt;/td&gt;

        &lt;td&gt;${product.name}&lt;/td&gt;

        &lt;td&gt;
            &amp;amp;euro; ${cartItem.total}
            &lt;br&gt;
            &lt;span class="smallText"&gt;( &amp;amp;euro; ${product.price} / unit )&lt;/span&gt;
        &lt;/td&gt;
        ...
    &lt;/tr&gt;

&lt;/c:forEach&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ShoppingCartItem`の`product`プロパティは、カート項目の製品タイプを識別します。上記のループでは、最初に`product`変数を</code>${cartItem.product}`の式に設定することで、これを利用しています。その後、この変数を使用して、名前や価格などの製品に関する情報を取得しています。</p>
</div>
</div>
<div class="sect2">
<h3 id="scopedVariables">Webアプリケーションでのスコープ指定された変数の操作</h3>
<div class="paragraph">
<p>JSP/サーブレット・テクノロジを扱う場合、アプリケーションのレルム内で使用できる4つのスコープ・オブジェクトがあります。JSPテクノロジには、サーブレットAPIによって定義されるクラスにアクセスできる_暗黙オブジェクト_が実装されています。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">スコープ</th>
<th class="tableblock halign-left valign-top">定義</th>
<th class="tableblock halign-left valign-top">サーブレット・クラス</th>
<th class="tableblock halign-left valign-top">JSP暗黙オブジェクト</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>アプリケーション</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Webアプリケーションのグローバル・メモリー</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/javaee/6/docs/api/javax/servlet/ServletContext.html">+javax.servlet.ServletContext+</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>applicationScope</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>セッション</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ユーザー・セッションに固有のデータ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/javaee/6/docs/api/javax/servlet/http/HttpSession.html">+javax.servlet.http.HttpSession+</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sessionScope</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>リクエスト</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">個々のサーバー・リクエストに固有のデータ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><a href="http://java.sun.com/javaee/6/docs/api/javax/servlet/http/HttpServletRequest.html">+javax.servlet.HttpServletRequest+</a></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>requestScope</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ページ</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">単一のページ(JSPのみ)のコンテキストのみで有効なデータ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[n/a]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pageScope</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>エディタでプロジェクトの`category.jsp`ファイルを開くと、EL式に`${categories}`、<code>${selectedCategory}`および</code>${categoryProducts}`などの様々なスコープ指定された変数が含まれているのが確認できます。`${categories}`変数はアプリケーション・スコープ指定されており、次のように`ControllerServlet`の`init`メソッドで設定されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">// store category list in servlet context
getServletContext().setAttribute("categories", categoryFacade.findAll());</code></pre>
</div>
</div>
<div class="paragraph">
<p>他の`${selectedCategory}`と`${categoryProducts}`の2つは、`ControllerServlet`からアプリケーションのセッション・スコープに置かれています。例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">// place selected category in session scope
session.setAttribute("selectedCategory", selectedCategory);</code></pre>
</div>
</div>
<div class="paragraph">
<p>*注意: *前のチュートリアル・ユニットから続けている場合、<code>${selectedCategory}`と</code>${categoryProducts}`はもともとリクエスト・スコープ内に置かれていたことに気付くかもしれません。前のユニットではこれで問題ありませんでしたが、ここではユーザーがカテゴリ・ページで「add to cart」ボタンをクリックしたらどうなるかを考えてください。サーバーは、現在表示されているカテゴリ・ページを返すことによって、`addToCart`リクエストに応答します。したがって、選択されたカテゴリに関係する`selectedCategory`と`categoryProducts`を知る必要があります。この情報は、リクエストごとに確立するのではなく、複数のリクエストにまたがって保持し、必要なときにアクセスできるように、`category`リクエストからセッション・スコープに置きます。また、カート・ページによって提供される機能を調べます。(機能については<a href="#cartPage">後で</a>説明します。)「continue shopping」ボタンを押すと、ユーザーは前に表示されていたカテゴリに戻ります。再度`selectedCategory`変数と`categoryProducts`変数が必要です。</p>
</div>
<div class="paragraph">
<p>EL式でスコープ指定された変数を参照する場合、(異なるスコープに同じ名前の2つの変数がないと仮定して)変数のスコープを指定する必要はありません。JSPエンジンは4つすべてのスコープをチェックして、最初に一致した変数を返します。たとえば、`category.jsp`にある次の式を見てください。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">${categoryProducts}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、次の式の短縮形です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">${sessionScope.categoryProducts}</code></pre>
</div>
</div>
<div class="paragraph">
<p><span class="tips">詳細は、次のリソースを参照してください。</span></p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://java.sun.com/blueprints/guidelines/designing_enterprise_applications_2e/web-tier/web-tier5.html#1079198">J2EEプラットフォームでのエンタープライズ・アプリケーションの設計: 状態スコープ</a></p>
</li>
<li>
<p><a href="http://download.oracle.com/docs/cd/E17477_01/javaee/5/tutorial/doc/bnafo.html">情報の共有 &gt; スコープ指定されたオブジェクトの使用</a></p>
</li>
<li>
<p><a href="http://download.oracle.com/docs/cd/E17477_01/javaee/5/tutorial/doc/bnahq.html#bnaij">統一された式言語 &gt; 暗黙的なオブジェクト</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debug">Javaデバッガによるセッション・データの確認</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アプリケーションが実行時にどのように動作するかを調べます。IDEのデバッガを使用してコードをステップ実行し、`HttpSession`がどのように作成されるのか、また、後で取得できるように他のオブジェクトをセッション・スコープに置く方法を調べます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>このチュートリアル・ユニットの<a href="https://netbeans.org/projects/samples/downloads/download/Samples%252FJavaEE%252Fecommerce%252FAffableBean_snapshot5.zip">プロジェクト・スナップショット</a>をIDEで開きます。「プロジェクトを開く」(<span class="image"><img src="images/open-project-btn.png" alt="open project btn"></span>)ボタンをクリックし、ウィザードを使用して、このプロジェクトをダウンロードしたコンピュータ上の場所に移動します。<a href="entity-session.html">前のチュートリアル・ユニット</a>から続けている場合は、このプロジェクト・スナップショットに`ShoppingCart`クラスと`ShoppingCartItem`クラスを含む新しい`cart`パッケージが含まれています。また、次のファイルも変更されています。</p>
<div class="ulist">
<ul>
<li>
<p><code>WEB-INF/web.xml</code></p>
</li>
<li>
<p><code>css/affablebean.css</code></p>
</li>
<li>
<p><code>WEB-INF/jspf/header.jspf</code></p>
</li>
<li>
<p><code>WEB-INF/jspf/footer.jspf</code></p>
</li>
<li>
<p><code>WEB-INF/view/cart.jsp</code></p>
</li>
<li>
<p><code>WEB-INF/view/category.jsp</code></p>
</li>
<li>
<p><code>WEB-INF/view/checkout.jsp</code></p>
</li>
<li>
<p><code>controller/ControllerServlet</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>プロジェクトを実行(<span class="image"><img src="images/run-project-btn.png" alt="run project btn"></span>)して、使用しているデータベースとアプリケーション・サーバーで適切に構成されていることを確認します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>プロジェクトの実行時にエラーが発生した場合は、データベースの準備や、IDE、GlassFishおよびMySQL間の接続の確立について説明した<a href="setup.html">設定手順</a>をもう一度確認してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>ブラウザでアプリケーションの機能をテストします。<a href="entity-session.html">前のチュートリアル・ユニット</a>から直接継続している場合は、次のような機能拡張に気付くでしょう。</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_カテゴリページ">カテゴリ・ページ</h3>
<div class="ulist">
<ul>
<li>
<p>初めて「add to cart」をクリックするとショッピング・カートが有効になり、「proceed to checkout」ウィジェットがヘッダーに表示されます。</p>
</li>
<li>
<p>「add to cart」をクリックすると、ヘッダーにあるショッピング・カート・ウィジェットのカート項目の数が更新されます。</p>
</li>
<li>
<p>「view cart」をクリックすると、カート・ページが表示されます。</p>
</li>
<li>
<p>「proceed to checkout」をクリックすると、チェックアウト・ページが表示されます。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/category-page.png" alt="category page">
</div>
<div class="title">Figure 2. ショッピング・カート機能があるカテゴリ・ページ</div>
</div>
</div>
<div class="sect2">
<h3 id="cartPage">カート・ページ</h3>
<div class="ulist">
<ul>
<li>
<p>「clear cart」をクリックすると、ショッピング・カートの項目が空になります。</p>
</li>
<li>
<p>「continue shopping」をクリックすると、前に表示されていたカテゴリ・ページに戻ります。</p>
</li>
<li>
<p>「proceed to checkout」をクリックすると、チェックアウト・ページが表示されます。</p>
</li>
<li>
<p>項目の「quantity」フィールドに1から99までの数字を入力してから「update」をクリックすると、項目の合計と小計が再計算されます。</p>
</li>
<li>
<p>項目の「quantity」フィールドに0を入力してから「update」をクリックすると、表示された表からその項目が除去されます。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cart-page.png" alt="cart page">
</div>
<div class="title">Figure 3. ショッピング・カート機能があるカート・ページ</div>
</div>
</div>
<div class="sect2">
<h3 id="_チェックアウトページ">チェックアウト・ページ</h3>
<div class="ulist">
<ul>
<li>
<p>「view cart」をクリックすると、カート・ページが表示されます。</p>
</li>
<li>
<p>「submit purchase」をクリックすると、(ユーザー固有のデータなしで)確認ページが表示されます。</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/checkout-page.png" alt="checkout page">
</div>
<div class="title">Figure 4. ショッピング・カート機能があるチェックアウト・ページ</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>「ファイルに移動」ダイアログを使用して、エディタで`ControllerServlet`を開きます。[Alt]-[Shift]-[O] (Macの場合は[Ctrl]-[Shift]-[O])を押してから、ダイアログで「<code>Controller</code>」と入力して「OK」をクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/go-to-file-dialog.png" alt="go to file dialog">
</div>
<div class="title">Figure 5. 「ファイルに移動」ダイアログを使用した、エディタへのプロジェクト・リソースの速やかな表示</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>`HttpSession`オブジェクトを作成する行(150行目)の`doPost`メソッドにブレークポイントを設定します。ブレークポイントを設定するには、エディタの左マージンをクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/breakpoint.png" alt="breakpoint">
</div>
<div class="title">Figure 6. エディタの左マージンのクリックによるブレークポイントの設定</div>
</div>
<div class="paragraph">
<p>エディタの行番号表示を切り替えるには、左マージンを右クリックして「行番号を表示」を選択します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>デバッガを実行します。IDEのメイン・ツールバーにある「プロジェクトをデバッグ」(<span class="image"><img src="images/debug-project-btn.png" alt="debug project btn"></span>)ボタンをクリックします。GlassFishサーバーが起動(すでに実行中の場合は再起動)し、そのデバッグ・ポート番号でソケットを開きます。アプリケーションの開始ページがブラウザで開きます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>デバッグ・ポート番号は、「サーバー」ウィンドウ(「ツール」&gt;「サーバー」)から表示および変更できます。使用しているサーバーの「Java」タブを選択します。「デバッグ設定」の下の「使用するアドレス」フィールドにポート番号を指定します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>アプリケーションの開始ページがブラウザに表示されたら、いずれかのカテゴリ・イメージをクリックしてカテゴリ・ページに移動します。「add to cart」ボタンをクリックすると、次のようにサーバーに`addToCart`リクエストが送信されることを思い出してください。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">&lt;form action="addToCart" method="post"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="page-views-controller.html#controller">ページ・ビューおよびコントローラ・サーブレットの準備</a>で説明したように、<code>ControllerServlet`の`doPost`メソッドは、</code>/addToCart`のURLパターンのリクエストを処理します。このため、ユーザーが「add to cart」ボタンをクリックすると`doPost`メソッドがコールされることを想定できます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>カテゴリ・ページで、いずれかのカテゴリの「add to cart」をクリックします。IDEに戻ると、デバッガがブレークポイントで一時停止されていることがわかります。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/breakpoint-suspended.png" alt="breakpoint suspended">
</div>
<div class="title">Figure 7. エディタのブレークポイントで一時停止されたデバッガ</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>`getSession()`へのコールにカーソルを置き、[Ctrl]-[Space]を押してJavadocドキュメントを呼び出します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javadoc-getsession.png" alt="javadoc getsession">
</div>
<div class="title">Figure 8. [Ctrl]-[Space]の押下によるJavadocドキュメントの呼出し</div>
</div>
<div class="paragraph">
<p>ドキュメントによると、`getSession()`は現時点でリクエストに関連付けられている`HttpSession`を返し、セッションが存在しない場合、このメソッドは新しいセッション・オブジェクトを作成します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_ideのjavadocサポートの利用">IDEのJavadocサポートの利用</h3>
<div class="paragraph">
<p>IDEには、Java EE開発向けのJavadocが組み込まれています。IDEにはJava EE 6 API仕様がバンドルされており、「ヘルプ」&gt;「Javadoc参照」&gt;「Java EE 6」を選択して外部ブラウザで開けます。</p>
</div>
<div class="paragraph">
<p>IDEにはこの他にも、APIドキュメントに簡単にアクセスできる、次のような様々な機能が含まれています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Javadocウィンドウ:</strong> 「ウィンドウ」&gt;「その他」&gt;「Javadoc」を選択します。JavadocウィンドウはIDEの下部領域で開き、エディタのカーソル位置に関連するAPIドキュメントを表示します。</p>
</li>
<li>
<p><strong>Javadoc索引検索:</strong> 「ヘルプ」&gt;「Javadoc索引検索」([Shift]-[F1]、Macの場合は[fn]-[Shift]-[F1])を選択します。探しているクラス名を入力してから、一覧表示された結果からクラスを選択します。ウィンドウの下部のペインに、API仕様からクラスの完全な説明が表示されます。</p>
</li>
<li>
<p><strong>エディタのドキュメント・ポップアップ:</strong> エディタの特定の要素で[Ctrl]-[Space]を押すと、Javadocドキュメントがポップアップ・ウィンドウに表示されます。「外部ブラウザ」(<span class="image"><img src="images/external-browser-btn.png" alt="external browser btn"></span>)ボタンをクリックすると、ブラウザでドキュメントが開きます。[Ctrl]-[Space]をコード補完のためにのみ使用する場合は、「ツール」&gt;「オプション」(Macの場合は「NetBeans」&gt;「プリファレンス」)で「オプション」ウィンドウを開いてから「エディタ」&gt;「コード補完」を選択して、ドキュメント・ポップアップを非アクティブ化できます。「ドキュメント・ウィンドウを自動ポップアップ」オプションを選択解除します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>独自の作業をドキュメント化する場合、作成したクラスおよびメソッドにJavadocコメントを追加することを検討してください。<code>ShoppingCart`クラスを開き、クラス・メソッドに追加されているJavadocコメントを確認します。Javadocコメントは、</code>/** &#8230;&#8203; */`区切り文字でマークされています。たとえば、`addItem`メソッドには、メソッドの署名の前に次のようなコメントが入っています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">/**
 * Adds a &lt;code&gt;ShoppingCartItem&lt;/code&gt; to the &lt;code&gt;ShoppingCart&lt;/code&gt;'s
 * &lt;code&gt;items&lt;/code&gt; list. If item of the specified &lt;code&gt;product&lt;/code&gt;
 * already exists in shopping cart list, the quantity of that item is
 * incremented.
 *
 * @param product the &lt;code&gt;Product&lt;/code&gt; that defines the type of shopping cart item
 * @see ShoppingCartItem
 */
public synchronized void addItem(Product product) {</code></pre>
</div>
</div>
<div class="paragraph">
<p>これによって開発者(およびプロジェクトにかかわる他の人)が、メソッドについてのJavadocドキュメントを表示できるようになります。これを示すために、[Ctrl]-[7] (Macの場合は[⌘]-[7])で「ナビゲータ」を開き、カーソルを`addItem`メソッドの上に移動します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javadoc-additem.png" alt="javadoc additem">
</div>
<div class="title">Figure 9. ナビゲータでのメソッド上へのカーソルの移動によるJavadocドキュメントの表示</div>
</div>
<div class="paragraph">
<p>IDEを使用して、一連のJavadoc HTMLページを生成することもできます。「プロジェクト」ウィンドウでプロジェクト・ノードを右クリックし、「Javadocを生成」を選択します。IDEによって、プロジェクトのディレクトリの`dist/javadoc`フォルダにJavadocが生成され、ブラウザにインデックス・ページが表示されます。</p>
</div>
<div class="paragraph">
<p>Javadocの詳細は、次のリソースを参照してください。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://java.sun.com/j2se/javadoc/">Javadocツールの公式ホーム・ページ</a></p>
</li>
<li>
<p><a href="http://java.sun.com/j2se/javadoc/writingdoccomments/index.html">Javadocツールのドキュメント・コメントを書く方法</a></p>
</li>
</ul>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>`session`変数の上にカーソルを移動します。デバッガは、_それが実行しようとしている_行で一時停止されています。`getSession()`によって返される値は、この時点では`session`変数に保存されておらず、ポップアップには「"`session`"は、現在のコンテキスト内で既知の変数ではありません。」と表示されます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-variable.png" alt="session variable">
</div>
<div class="title">Figure 10. 変数および式へのカーソルの移動による現在の値の判定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>エディタの上にあるデバッガ・ツールバーの「ステップ・オーバー」(<span class="image"><img src="images/step-over-btn.png" alt="step over btn"></span>)ボタンをクリックします。この行が実行され、デバッガはファイルの次の行に進みます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>再度`session`変数の上にカーソルを移動します。今度は、`session`変数に現在設定されている値を確認します。</p>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/session-variable-set.png"><img src="images/session-variable-set.png" alt="session variable set"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>NetBeans 6.9では、ポップアップでグレーのポインタ(<span class="image"><img src="images/grey-pointer.png" alt="grey pointer"></span>)をクリックすると、強調表示された要素に含まれている変数の値の一覧を展開できます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p>「ステップ・オーバー」(<span class="image"><img src="images/step-over-btn.png" alt="step over btn"></span>)ボタン([F8]、Macの場合は[fn]-[F8])をクリックして`if`文(154行目)に入ります。ブラウザで「add to cart」ボタンをクリックしたばかりなので、`userPath.equals("/addToCart")`の式は`true`として評価されるはずです。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>[Ctrl]を押しながらマウスでクリックして`userPath.equals("/addToCart")`の式を強調表示します。今度は、強調表示した式の値を示すポップアップが表示されます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/expression.png" alt="expression">
</div>
<div class="title">Figure 11. 式の強調表示による現在の値の判定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>[F8] (Macの場合は[fn]-[F8])を押して次の行(158行目)に進みます。このアプリケーションは、ユーザーが初めてカートに項目を追加するときにのみユーザー・セッションの`ShoppingCart`オブジェクトを作成するように設計されています。このデバッグ・セッションで`addToCart`リクエストが受け取られたのはこれが最初であるため、`cart`オブジェクトは`null`と等しいと想定できます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cart-null.png" alt="cart null">
</div>
<div class="title">Figure 12. Cartオブジェクトはユーザーがショッピング・カートに項目を追加するまで存在しない</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p>[F8] (Macの場合は[fn]-[F8])を押して次の行(160行目)に進みます。次に、`ShoppingCart`オブジェクトが作成される160行目で、「ステップ・イン」(<span class="image"><img src="images/step-into-btn.png" alt="step into btn"></span>)ボタンをクリックします。コールされるメソッドにデバッガがステップ・インします。この場合、直接`ShoppingCart`のコンストラクタに移動します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cart-constructor.png" alt="cart constructor">
</div>
<div class="title">Figure 13. メソッドにステップ・インして実行時に他のクラスでの実行を追跡する</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p>[Ctrl]-[Tab]を押して`ControllerServlet`に戻ります。「コール・スタック」(<span class="image"><img src="images/call-stack-badge.png" alt="call stack badge"></span>)バッジが160行目に表示されます(現在、デバッガがコール・スタックの上位にあるいずれかのメソッドで一時停止されていることが表示されています)。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>[Alt]-[Shift]-[3] (Macの場合は[Ctrl]-[Shift]-[3])を押すとIDEの「コール・スタック」ウィンドウが開きます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p>[F8] (Macの場合は[fn]-[F8])を押して、コードの実行を進めます。デバッガが`ShoppingCart`コンストラクタを完了すると、`ControllerServlet`に戻ります。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>`ControllerServlet`の161行目では、新しく作成された`cart`オブジェクトをセッションにバインドします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">session.setAttribute("cart", cart);</code></pre>
</div>
</div>
<div class="paragraph">
<p>これを確認するには、デバッガの「変数」ウィンドウを開きます。「ウィンドウ」&gt;「デバッグ」&gt;「変数」を選択するか、[Alt]-[Shift]-[1] (Macの場合は[Ctrl]-[Shift]-[1])を押します。</p>
</div>
<div class="openblock feature">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/variables-win-session.png"><img src="images/variables-win-session.png" alt="variables win session"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>「session」&gt;「session」&gt;「attributes」ノードを展開すると、セッションにバインドされているオブジェクトを表示できます。上記のイメージでは、現時点でセッションにバインドされている(強調表示された) 2つの項目があります。これらは、それぞれ`ControllerServlet`の83行目と89行目でインスタンス化された`selectedCategory`と`categoryProducts`です。これらの項目は両方とも、以前カテゴリ・イメージをクリックして`ControllerServlet`がカテゴリ・ページのリクエストを処理したときにバインドされました。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="19">
<li>
<p>[F8] (Macの場合は[fn]-[F8])を押して161行目を実行します。`cart`オブジェクトはセッションにバインドされており、「変数」ウィンドウは変更を反映して更新されます。「変数」ウィンドウでは、現在、セッションに3つの属性が含まれていることを確認できます。3つ目の変数は、新しく初期化された`ShoppingCart`オブジェクト(次で強調表示)です。</p>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/variables-win-session-cart.png"><img src="images/variables-win-session-cart.png" alt="variables win session cart"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>これまでは、「変数」ウィンドウに一覧表示されたセッションが`HttpSession`セッションを示していることを「証明」しませんでした。前述のように、<code>HttpSession`は実際にはインタフェースであるため、`HttpSession`オブジェクト(セッション・オブジェクト)について説明する場合、実際には`HttpSession`インタフェースを実装するオブジェクトを指しています。「変数」ウィンドウで「`session</code>」の上にカーソルを移動すると、この変数が`HttpSession`オブジェクトを表していることを示すポップアップが表示されます。表示されているように、<code>StandardSessionFacade`型は、GlassFishが`HttpSession`インタフェースを実装するために使用する内部クラスです。Tomcatに詳しいユーザーが「値」列に表示された「`org.apache.catalina</code>」のパスに戸惑うのは、GlassFish Web/サーブレット・コンテナが実はApache Tomcatコンテナの派生クラスであるためです。</p>
</div>
<div class="paragraph">
<p>新しい`ShoppingCart`がセッションに追加され、リクエストの処理が続行されます。「add to cart」機能の実装を完成させるために、次のアクションが取られます。
* 選択された製品のIDがリクエストから取得される(165行目)
* IDを使用して`Product`オブジェクトが作成される(169行目)
* `product`を使用して新しい`ShoppingCartItem`が作成される(170行目)
* `ShoppingCartItem`が`ShoppingCart`の`items`リストに追加される(170行目)</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p>上記で一覧表示された4つのアクションを意識しながら、[F8] (Macの場合は[fn]-[F8])を押して、コードの実行を進めます。デバッガが170行目で一時停止したら一時休止します。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="21">
<li>
<p>セッションにウォッチを作成します。これによって、次の手順で`addItem`メソッドにステップ・インするときに、セッションに含まれている値を表示できるようになります。「変数」ウィンドウでセッションを右クリックして、「固定ウォッチを作成」を選択します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/create-watch.png" alt="create watch">
</div>
<div class="title">Figure 14. デバッグ・セッションでのコードのステップ実行による変数のウォッチの作成</div>
</div>
<div class="paragraph">
<p>または、エディタ内の`session`変数にカーソルを置いてから、右クリックして「新規ウォッチ」を選択します。「新規ウォッチ」ダイアログでは、アプリケーションのデバッグ時に継続的に監視する変数または式を指定できます。(式の場合は、最初に式を強調表示してから、右クリックして「新規ウォッチ」を選択します。)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/new-watch-dialog.png" alt="new watch dialog">
</div>
<div class="title">Figure 15. エディタ内で変数や式を右クリックして「新規ウォッチ」を選択する</div>
</div>
<div class="paragraph">
<p>`session`変数とそれに含まれるすべての変数の新しいウォッチが作成されます。ウォッチは、「ウォッチ」ウィンドウ(「ウィンドウ」&gt;「デバッグ」&gt;「ウォッチ」)から表示するか、「変数」ウィンドウの左マージンにある「ウォッチ」(<span class="image"><img src="images/watch-btn.png" alt="watch btn"></span>)ボタンを切り替えて「変数」ウィンドウの最初の行に表示可能です。</p>
</div>
<div class="paragraph">
<p>コードをステップ実行しながら、デバッガで変数を監視できるようになります。これは、たとえば特定の変数の値をたどる場合(そして各手順で「変数」ウィンドウに示される全リストから選択しなくても済むようにする場合)や、調べる必要のある変数が含まれていないクラスに一時的にステップ・インする場合に役立ちます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="22">
<li>
<p>「ステップ・イン」(<span class="image"><img src="images/step-into-btn.png" alt="step into btn"></span>)ボタンをクリックして、`ShoppingCart`の`addItem`メソッドにステップ・インします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="23">
<li>
<p>53行目まで`addItem`メソッドをステップ実行します。Javadocに記述されているとおり、`addItem`は_「`ShoppingCart`の`items`リストに`ShoppingCartItem`を追加します。指定された`product`の項目がすでにショッピング・カート・リストに存在する場合、その項目の数量が増加します。」_</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="24">
<li>
<p>(上記の<a href="#step21">ステップ21</a>で)ウォッチを作成した`session`変数を調べます。51行目の`items.add(scItem)`文によって、`ShoppingCart`の`items`リストに新しい`ShoppingCartItem`が追加されました。これは、セッションに含まれている3つ目の属性(`cart`変数)を調べるとわかります。</p>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/variables-window-add-item.png"><img src="images/variables-window-add-item.png" alt="variables window add item"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>この段階で、リクエストのために`HttpSession`が作成される方法、`ShoppingCart`オブジェクトが作成されてセッションにアタッチされる方法、および`ShoppingCartItem`がユーザーの製品選択に基づいて作成され、`ShoppingCart`の`items`のリストに追加される方法を確認できます。残っているアクションは、`category.jsp`ビューへのリクエストの転送のみです。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="25">
<li>
<p>エディタでJSPフラグメント(<code>header.jspf</code>)を開き、86行目にブレークポイントを設定します。この行には、カート項目の数を表示する、ショッピング・カート・ウィジェット内のEL文が含まれています。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/breakpoint-jsp.png" alt="breakpoint jsp">
</div>
<div class="title">Figure 16. JSPページでデバッガを一時停止できる</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="26">
<li>
<p>デバッガ・ツールバーの「続行」(<span class="image"><img src="images/continue-btn.png" alt="continue btn"></span>)ボタンをクリックします。デバッガは実行が完了するか、別のブレークポイントに達するまで続行されます。この場合、デバッガはヘッダーのJSPフラグメントの86行目で一時停止されます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>注意:</strong> JSPページでデバッガを一時停止させるには、ブレークポイントを設定する必要があります。たとえば、`ControllerServlet`がリクエストを適切なビューに転送したとき、デバッガはJSPページ内で自動的に一時停止されません。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="27">
<li>
<p>まだ開いていない場合は「変数」ウィンドウを開きます([Alt]-[Shift]-[1]、Macの場合は[Ctrl]-[Shift]-[1])。Javaクラスとは異なり、JSPページではデバッガで変数や式の上にカーソルを移動してもツールチップは表示_されません_。ただし、コードをステップ実行しながら、「変数」ウィンドウで変数の値を判定できます。では、`${cart.numberOfItems}`の値はどこにあるでしょうか。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="28">
<li>
<p>「変数」ウィンドウで、「暗黙的なオブジェクト」&gt;「pageContext」&gt;「session」&gt;「session」&gt;「attributes」ノードを展開します。これによって、前に`ControllerServlet`をデバッグしていたときのように、セッション・オブジェクトにアクセスできるようになります。上記のステップ21でウォッチを作成したセッションは、実は同じオブジェクトを指しています。ここで、<code>${cart.numberOfItems}`の値が「`1</code>」と等しいことを確認できます。</p>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/variables-window-number-of-items.png"><img src="images/variables-window-number-of-items.png" alt="variables window number of items"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>「変数」ウィンドウなどのIDEのウィンドウは、いずれもウィンドウのヘッダーを右クリックしてから「ウィンドウを最大化」([Shift]-[Esc])を選択することで最大化できます。</p>
</div>
<div class="paragraph">
<p>デバッガで、<code>pageContext`の暗黙オブジェクトにアクセスできるようになります。`pageContext`はJSPページのコンテキストを示しており、`HttpServletRequest</code>、<code>HttpSession</code>、`ServletContext`オブジェクトなどの様々なオブジェクトへの直接的なアクセスを提供します。詳細は、<a href="http://java.sun.com/javaee/5/docs/tutorial/doc/bnahq.html#bnaij">Java EE 5チュートリアル: 暗黙オブジェクト</a>を参照してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="29">
<li>
<p>セッションの終了(<span class="image"><img src="images/finish-session-btn.png" alt="finish session btn"></span>)ボタンをクリックします。ランタイムが実行を完了し、デバッグ・セッションが終了します。ブラウザにカテゴリ・ページが完全にレンダリングされ、ページ・ヘッダーにあるショッピング・カート・ウィジェットに1つの項目が含まれているのが確認できます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>IDEデバッガは、プロジェクトが想定どおりに動作しない場合の検査用としてのみでなく、コードに詳しくなるためのツールとしても便利であることがわかるでしょう。他にも、デバッガ・ツールバーには次のような便利なボタンがあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(<span class="image"><img src="images/step-out.png" alt="step out"></span>)<strong>ステップ・アウト:</strong> 現在のメソッド・コールをステップ・アウトします。呼出しスタックの最上位のメソッド・コールを実行して除去します。</p>
</li>
<li>
<p>(<span class="image"><img src="images/run-to-cursor.png" alt="run to cursor"></span>)<strong>カーソルまで実行:</strong> カーソルが置かれている行まで実行します。</p>
</li>
<li>
<p>(<span class="image"><img src="images/apply-code-changes.png" alt="apply code changes"></span>)<strong>コードの変更を適用:</strong> ファイルを編集してからこのボタンを押すと、ファイルが再コンパイルされ、変更がデバッグ・セッションに反映されます。</p>
</li>
<li>
<p>(<span class="image"><img src="images/step-over-expression.png" alt="step over expression"></span>)<strong>式をステップ・オーバー:</strong> 式のメソッド・コールごとの入力パラメータおよび結果の出力値を表示できるようにします。「ローカル変数」ウィンドウで、前のメソッドの出力値と次のメソッドの入力パラメータを検査できます。次のメソッド・コールがない場合、「式をステップ・オーバー」は「ステップ・オーバー」(<span class="image"><img src="images/step-over-btn.png" alt="step over btn"></span>)コマンドと同様に機能します。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="session-track">セッション・トラック・オプションの確認</h2>
<div class="sectionbody">
<div class="paragraph">
<p>クライアントとサーバー間のセッションをトラックするための慣習的な方法が3つあります。圧倒的に多く使用されているのはCookieです。URL書換えは、Cookieがサポートされていないか無効になっている場合に適用できます。隠しフォーム・フィールドも、複数のリクエストにわたって「状態を維持する」ための手段として使用できますが、これらはフォーム内での使用に制限されます。</p>
</div>
<div class="paragraph">
<p><code>AffableBean`プロジェクトでは、カテゴリとカートの両方のページに隠しフィールド・メソッドの例が含まれています。製品項目用に表示する「add to cart」および「update」ボタンには、ボタンがクリックされると製品IDをサーバーに渡す隠しフィールドが含まれています。エディタで`cart.jsp`ページを開くと、</code>&lt;form&gt;`タグに隠しフィールドが含まれているのが確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;form action="updateCart" method="post"&gt;
    *&lt;input type="hidden"
           name="productId"
           value="${product.id}"&gt;*
    ...
&lt;/form&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように、製品IDはリクエスト・パラメータとして送信されます。この製品IDは、ユーザーのカート内の項目の数量を変更する必要があるときに、項目を識別するためにサーバーによって使用されます。</p>
</div>
<div class="paragraph">
<p>サーブレットAPIは、セッションを管理するための高水準な機構を提供します。基本的にこの機構では、リクエストとレスポンスのサイクルごとにクライアントとサーバー間でCookieを作成して渡します。クライアントのブラウザでCookieが使用できない場合、サーブレット・エンジンは自動的にURL書換えに戻ります。次の2つの課題でこの機能を示します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#http-monitor">HTTPモニターによるクライアントとサーバー間の通信の確認</a></p>
</li>
<li>
<p><a href="#url-rewrite">URL書換えによるセッションの維持</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="http-monitor">HTTPモニターによるクライアントとサーバー間の通信の確認</h3>
<div class="paragraph">
<p>デフォルトでは、サーブレット・エンジンは、Cookieを使用してリクエスト間のセッションを維持および識別します。セッション・オブジェクトごとにランダムな英数字が生成され、一意の識別子として使用されます。この識別子は、「<code>JSESSIONID</code>」Cookieとしてクライアントに渡されます。クライアントがリクエストを作成すると、サーブレット・エンジンは`JSESSIONID` Cookieの値を読み取り、そのリクエストが属しているセッションを判定します。</p>
</div>
<div class="paragraph">
<p>これを示すために、IDEのHTTPモニターと連携してデバッガを使用します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>まず、使用しているサーバーのHTTPモニターをアクティブ化します。「ツール」&gt;「サーバー」を選択します。「サーバー」ウィンドウの左の列で、使用しているサーバー(GlassFish)を選択します。次にメインの列で、「HTTPモニターを有効化」オプションを選択します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/servers-win-http-monitor.png" alt="servers win http monitor">
</div>
<div class="title">Figure 17. 「HTTPモニターを有効化」オプションの選択によるHTTPモニターのアクティブ化</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>サーバーがすでに実行されている場合は再起動する必要があります。しかし、ここではデバッガを使用する予定であり、デバッガを実行すると異なるポートで通信するためにサーバーが再起動されるため、単にIDEのメイン・ツールバーにある「プロジェクトをデバッグ」(<span class="image"><img src="images/debug-project-btn.png" alt="debug project btn"></span>)ボタンをクリックします。サーバーが再起動し、デバッグ・セッションが開始して、アプリケーションの開始ページがブラウザで開きます。HTTPモニターがIDEの最下部の領域に表示されます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/http-monitor.png" alt="http monitor">
</div>
<div class="title">Figure 18. HTTPモニターがデフォルトでIDEの最下部の領域に表示される</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>上記のイメージで示したように、左の列のAffableBeanレコードをクリックします。左の列でレコードを選択すると、右の(メインの)列がリフレッシュされ、対応するデータが表示されます。上記のイメージの「リクエスト」タブには、リクエストされたURI (<code>/AffableBean/</code>)およびHTTPメソッド(<code>GET</code>)が表示され、さらにリクエストと一緒に送信された問合せ文字列はなかったことが示されています。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>「セッション」タブを選択します。「このリクエストの結果、セッションが作成されました」という文が表示されています。これは、サーバーがレスポンスとして`JSESSIONID` Cookieの`Set-Cookie`ヘッダーを送信したためです。また、新しいセッションIDが「セッション・プロパティ」の下に表示されています。後で示すように、セッションIDは`JSESSIONID` Cookieの値です。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-tab.png" alt="session tab">
</div>
<div class="title">Figure 19. セッションの詳細がHTTPモニターの「セッション」タブの下に表示される</div>
</div>
<div class="paragraph">
<p>サイトの開始ページのリクエストからセッション・オブジェクトが作成された方法について疑問に思うかもしれません。結局、<code>ControllerServlet`は</code>/AffableBean/`の最初のリクエストを処理しておらず、このリクエストが`getSession()`の影響を受ける機会はどこにもありません。それとも、これが行われたのでしょうか。JSPページは、デプロイメント時にサーブレットにコンパイルされることを思い出してください。サーバーにプロジェクトをデプロイすれば、実際にIDEを使用して、サーバー上のJSPのコンパイルされたサーブレットを表示できます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>「プロジェクト」ウィンドウで`index.jsp`ファイルを右クリックし、「サーブレットを表示」を選択します。エディタで`index_jsp.java`ファイルが開きます。これは、`index.jsp`ページから自動的にコンパイルされたサーブレットです。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>このファイルで`getSession`を検索します。[Ctrl]-[F] (Macの場合は[⌘]-[F])を押し、検索バーで「<code>getSession</code>」と入力してから[Enter]を押します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>[Ctrl]-[F] (Macの場合は[⌘]-[F])は、「編集」&gt;「検索」のキーボード・ショートカットです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/get-session.png" alt="get session">
</div>
<div class="title">Figure 20. JSPページのコンパイルされたサーブレットに存在するgetSessionメソッド</div>
</div>
<div class="paragraph">
<p>実は、`getSession`メソッドはコールされます。これが起こる理由は、JSPページにはデフォルトで`pageContext.session`の暗黙オブジェクトが含まれるためです。この動作を非アクティブ化するには、JSPファイルの最初に次のディレクティブを追加します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">&lt;%@page session="false" %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>このようにすると、コンパイルされたサーブレットの`getSession`メソッドが除去されます。</p>
</div>
<div class="paragraph">
<p>サーバー上のコンパイルされたサーブレットの場所を見つけるには、エディタの上にあるサーブレット名のタブ上にカーソルを移動します。ポップアップに、コンピュータ上のファイルへのパスが表示されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>ブラウザで、カテゴリを選択してからカートに項目を追加します。IDEに戻ります。以前に設定した`ControllerServlet`のブレークポイント(150行目)でデバッガは一時停止されます。すべてのブレークポイントは、セッション間で記憶されます。ブレークポイントを除去するには、エディタの左マージンにある「ブレークポイント」(<span class="image"><img src="images/breakpoint-badge.png" alt="breakpoint badge"></span>)バッジをクリックします。しかし、このプロジェクトにはすでに複数のブレークポイントが設定されているため、「ウィンドウ」&gt;「デバッグ」&gt;「ブレークポイント」でデバッガの「ブレークポイント」ウィンドウを開きます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/breakpoints-window.png" alt="breakpoints window">
</div>
<div class="title">Figure 21. 「ブレークポイント」ウィンドウでのプロジェクトのすべてのブレークポイントの表示</div>
</div>
<div class="paragraph">
<p>「ブレークポイント」ウィンドウから、IDEで開いているプロジェクトで設定されたすべてのブレークポイントを表示してアクションをコールできます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>`header.jspf`に設定されたブレークポイントを右クリックして、「削除」を選択します。その後、`ControllerServlet`に設定されたブレークポイントを右クリックして、「無効」を選択します。(この課題の後半で再度有効にします。)</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>「続行」(<span class="image"><img src="images/continue-btn.png" alt="continue btn"></span>)ボタンをクリックします。リクエストの実行が終了し、カートに項目が1つ追加されたカテゴリ・ページがブラウザに表示されます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>HTTPモニターの左の列で`addToCart`リクエストを検索して選択すると、メインの列に詳細が表示されます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>昇順ソート(<span class="image"><img src="images/ascending-sort-btn.png" alt="ascending sort btn"></span>)ボタンをクリックすると、最新のレコードが最上部に表示されます。</p>
</div>
<div class="paragraph">
<p>「リクエスト」タブの下で、リクエストされたURI (<code>/AffableBean/addToCart</code>)、HTTPメソッド(<code>POST</code>)、およびリクエストされたパラメータ(<code>productId`および`submit</code>)を確認してください。</p>
</div>
<div class="openblock feature">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/http-monitor-add-to-cart.png"><img src="images/http-monitor-add-to-cart.png" alt="http monitor add to cart"></a></span></p>
</div>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>「Cookie」タブを選択します。ここでは、`JSESSIONID`という名前のCookieが存在し、クライアントからサーバーに送信されたことを確認できます。Cookieの値は、「セッション」タブの下に表示されたセッションIDと同じです。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cookies-tab.png" alt="cookies tab">
</div>
<div class="title">Figure 22. HTTPモニターの「Cookie」タブに表示されたCookie</div>
</div>
<div class="paragraph">
<p>同様に、「ヘッダー」タブをクリックするとCookieが表示されます。これは、「<code>Cookie</code>」がクライアントによって送信されたリクエスト・ヘッダーであるためです。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/headers-tab.png" alt="headers tab">
</div>
<div class="title">Figure 23. HTTPモニターの「Cookie」タブに表示されたCookie</div>
</div>
<div class="paragraph">
<p>リクエストおよびレスポンス・ヘッダーの詳細は、ウィキペディアの<a href="http://en.wikipedia.org/wiki/List_of_HTTP_headers">HTTPヘッダーの一覧</a>を参照してください。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>「セッション」タブを選択します。「このリクエストの前にセッションが存在しました」という文が表示されています。また、`cart`属性が「リクエスト後のセッション属性」の下に表示されています。`addToCart`リクエストが初めて処理されるときに`cart`オブジェクトがセッションにバインドされるため、これは理にかなっています。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-tab-add-to-cart.png" alt="session tab add to cart">
</div>
<div class="title">Figure 24. HTTPモニターの「セッション」タブの下に表示されたセッション属性</div>
</div>
<div class="paragraph">
<p>以降のいくつかの手順では、「変数」ウィンドウでセッションIDおよび`JSESSIONID` Cookieを確認します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p>以前に`ControllerServlet`に設定したブレークポイントを再度有効にします。[Alt]-[Shift]-[5] (Macの場合は[Ctrl]-[Shift]-[5])を押して「ブレークポイント」ウィンドウを開き、ブレークポイント・エントリの横にあるチェックボックスをクリックして、再度有効にします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>ブラウザで、一覧表示された製品のうちの1つで「add to cart」ボタンをクリックします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>IDEに切り替えると、デバッガが`ControllerServlet`に設定されたブレークポイントで一時停止されています。「ステップ・オーバー」(<span class="image"><img src="images/step-over-btn.png" alt="step over btn"></span>)ボタンをクリックして、`session`変数をセッション・オブジェクトに割り当てます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p>「変数」ウィンドウを開き([Alt]-[Shift]-[1]、Macの場合は[Ctrl]-[Shift]-[1])、「session」&gt;「session」を展開します。セッションIDが「<code>id</code>」変数の値として表示されます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p><code>JSESSIONID</code> Cookieを見つけるために、通常は`HttpServletRequest`で<a href="http://java.sun.com/webservices/docs/1.6/api/javax/servlet/http/HttpServletRequest.html#getCookies%28%29">`getCookies`</a>メソッドをコールすることで、サーブレットからCookieにアクセスできることを思い出してください。したがってrequestオブジェクトを、「request」&gt;「継承」&gt;「request」&gt;「request」&gt;「継承」&gt;「cookies」と展開します。これで`cookies` ArrayListが表示されます。リストを展開すると`JSESSIONID` Cookieがあり、この値がセッションIDになります。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p>セッションの終了(<span class="image"><img src="images/finish-session-btn.png" alt="finish session btn"></span>)ボタンをクリックして、デバッグ・セッションを終了します。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="url-rewrite">URL書換えによるセッションの維持</h3>
<div class="paragraph">
<p>前述のように、サーブレット・エンジンはクライアント・ブラウザでCookieがサポートされているかどうかを検出し、サポートされていない場合は、セッションを維持する手段をURL書換えに切り替えます。これはすべて、クライアントにとって透過的に行われます。開発者にとっては、このプロセスは完全に透過的なわけではありません。</p>
</div>
<div class="paragraph">
<p>Cookieが無効になっている場合に必ずURL書換えができるようにアプリケーションを実装する必要があります。このために、アプリケーション内でサーブレットが返すURLのすべてに対して、レスポンスの`encodeURL`メソッドをコールします。このようにすると、Cookieが使用できない場合にはセッションIDがURLに付加されるようになります。これを行わないと、URLを変更せずに返すことになります。</p>
</div>
<div class="paragraph">
<p>たとえば、ブラウザが次のような`AffableBean`の3つ目のカテゴリ(bakery)のリクエストを送信します: <code>category?3</code>。サーバーは次のように、セッションIDをURLに含めて応答します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">/AffableBean/category*;jsessionid=364b636d75d90a6e4d0085119990*?3</code></pre>
</div>
</div>
<div class="paragraph">
<p>前述のように、<em>アプリケーションのサーブレットによって返されるすべてのURLをエンコードする必要があります</em>。JSPページはサーブレットにコンパイルされることを思い出してください。JSPページでどのようにURLをエンコードするのでしょうか。JSTLの<a href="http://java.sun.com/products/jsp/jstl/1.1/docs/tlddocs/c/url.html">`&lt;c:url&gt;`</a>タグがこの機能を果たします。以下の課題で、問題と解決法を示します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ブラウザのCookieを一時的に無効にします。Firefoxを使用している場合、「ツール」&gt;「オプション」(Macの場合は「Firefox」&gt;「プリファレンス」)を選択します。表示されたウィンドウで「プライバシー」タブを選択してから、表示されたドロップダウンで「記憶させる履歴を詳細設定する」を選択します。「サイトから送られてきたCookieを保存する」オプションを選択解除します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/firefox.png" alt="firefox">
</div>
<div class="title">Figure 25. ブラウザでの一時的なCookieの無効化</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>`AffableBean`プロジェクトを実行します。開始ページが表示されたら、カテゴリをクリックしてからカートに項目を追加してみてください。現状ではアプリケーションがまったく機能しません。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/compromised.png" alt="compromised">
</div>
<div class="title">Figure 26. クライアントがCookieを受け入れない場合、アプリケーションは機能しない</div>
</div>
<div class="paragraph">
<p>以前と同様に、サーバーはセッションを生成して、そのセッションにオブジェクトをバインドします。このようにして、選択されたカテゴリおよび製品をカテゴリ・ページに表示できます。しかし、サーバーは`JSESSIONID` Cookieの設定に失敗しました。したがって、クライアントが2つ目のリクエストを作成したとき(ユーザーが「add to cart」をクリックしたとき)、サーバーにはリクエストが属しているセッションを識別する方法がありません。このため、以前にセッションで設定された`selectedCategory`や`categoryProducts`などの属性をいずれも見つけることができません。このような理由により、レスポンスのレンダリングにはこれらの属性によって指定される情報が欠如しています。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>エディタでプロジェクトの`category.jsp`ページを開きます。「add to cart」ボタンを実装する行(58行目)を見つけます。`&lt;form&gt;`要素の`action`属性によって、サーバーに送信されるリクエストが決まります。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">&lt;form action="addToCart" method="post"&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>リクエストを変更して、`&lt;c:url&gt;`タグを通して渡されるようにします。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">&lt;form action="*&lt;c:url value='addToCart'/&gt;*" method="post"&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>[Ctrl]-[S] (Macの場合は[⌘]-[S])を押して、ファイルへの変更を保存します。IDEは、デフォルトで有効な「保存時にデプロイ」機能が備わっていることを思い出してください。これによって、保存された変更はすべて自動的にサーバーにデプロイされます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>ブラウザで異なるカテゴリを選択して、新しく変更されたカテゴリ・ページをアプリケーションにレンダリングさせます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>このページのソース・コードを調べます。Firefoxでは[Ctrl]-[U] (Macの場合は[⌘]-[U])を押します。各製品の「add to cart」ボタンに、URLに付加されたセッションIDが一緒に表示されています。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">&lt;form action="addToCart*;jsessionid=4188657e21d72f364e0782136dde*" method="post"&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>いずれかの項目で「add to cart」ボタンをクリックします。サーバーが、リクエストが属しているセッションを判定して、適切にレスポンスをレンダリングできるようになっていることを確認できます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>次に進む前に、ブラウザでCookieを再度有効にしてください。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>前述のように、アプリケーション内でユーザーがクリックできるすべてのリンクは、そのレスポンスがなんらかの形式のセッション関連のデータを必要とする場合、適切にエンコードされる必要があります。上記の例ほど実装が単純ではない場合もあります。たとえば、`cart.jsp`で使用されている「clear cart」ウィジェットは、現時点ではリンクがクリックされると`clear`パラメータを`true`に設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;%-- clear cart widget --%&gt;
&lt;c:if test="${!empty cart &amp;amp;&amp;amp; cart.numberOfItems != 0}"&gt;
    &lt;a href="viewCart*?clear=true*" class="bubble hMargin"&gt;clear cart&lt;/a&gt;
&lt;/c:if&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>`&lt;c:url&gt;`タグは、次の方法でURLに適用できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;%-- clear cart widget --%&gt;
&lt;c:if test="${!empty cart &amp;amp;&amp;amp; cart.numberOfItems != 0}"&gt;

    *&lt;c:url var="url" value="viewCart"&gt;
        &lt;c:param name="clear" value="true"/&gt;
    &lt;/c:url&gt;*

    &lt;a href="*${url}*" class="bubble hMargin"&gt;clear cart&lt;/a&gt;
&lt;/c:if&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>clear=true`パラメータは、</code>&lt;c:url&gt;`タグ間に`&lt;c:param&gt;`タグを追加することで設定されます。「<code>url</code>」という名前の変数が&lt;c:url&gt; の`var`属性を使用して設定された後、<code>var`が</code>${url}`式を使用してHTMLアンカー・タグでアクセスされます。</p>
</div>
<div class="paragraph">
<p><a href="https://netbeans.org/projects/samples/downloads/download/Samples%252FJavaEE%252Fecommerce%252FAffableBean_snapshot6.zip">スナップショット6</a>をダウンロードして調べれば、プロジェクトのすべてのリンクがどのようにエンコードされているかを確認できます。</p>
</div>
<div class="paragraph">
<p>URL書換えは、トラック・メソッドとしてCookieが使用できない場合にのみ使用する必要があります。セッションIDがブラウザのアドレス・バーのみでなく、ログ、ブックマーク、リファラ・ヘッダーおよびキャッシュされたHTMLに表示されるため、通常はURL書換えは次善手段と見なされています。また、受信リクエストごとにURLからセッションIDを抽出して、既存のセッションと組み合せるためのサーバーの追加手順が必要なため、サーバー側リソースも多く必要になります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="time-out">セッション・タイム・アウトの処理</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#time-interval">セッションの時間間隔の設定</a></p>
</li>
<li>
<p><a href="#programmatically">プログラムによるセッション・タイム・アウトの処理</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="time-interval">セッションの時間間隔の設定</h3>
<div class="paragraph">
<p>サーバーがセッションを維持する時間間隔の最大値について考慮する必要があります。Webサイトのトラフィックが多くなると、多数のセッションによってサーバーのメモリー・キャパシティが使い果たされる可能性があります。このため、使用されていないセッションを除去できるように、時間間隔を短くできます。一方で、セッションが短すぎると使い勝手が悪くなり、Webサイトの背後にあるビジネスに悪影響を与える可能性があります。これは避ける必要があります。`AffableBean`アプリケーションの例で考えると、ユーザーがショッピング・カートに多くの項目を入れてからチェックアウトに進むとします。その後、クレジット・カードの詳細を入力する必要があることがわかり、財布を探しにいきます。クレジット・カードを持ってコンピュータに戻ってから、チェックアウト・フォームに入力して「submit」をクリックします。しかしこの間に、このユーザーのセッションはサーバーで有効期限切れになっていました。ショッピング・カートは空になり、ユーザーはホーム・ページにリダイレクトされます。このユーザーは、再度時間をかけて同じプロセスを実行するでしょうか。</p>
</div>
<div class="paragraph">
<p>次の手順では、`AffableBean`プロジェクトのセッション・タイム・アウトの間隔を10分に設定する方法を示します。言うまでもなく実際の間隔は最終的に、サーバー・リソース、業務におけるアプリケーションの目標、およびWebサイトの需要によって決まります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>エディタでアプリケーションのデプロイメント・ディスクリプタを開きます。[Alt]-[Shift]-[O] (Macの場合は[Ctrl]-[Shift]-[O])を押して、IDEの「ファイルに移動」ダイアログを使用します。「<code>web</code>」と入力してから「OK」をクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/go-to-file.png" alt="go to file">
</div>
<div class="title">Figure 27. 「ファイルに移動」ダイアログを使用した、プロジェクト・ファイルへの速やかな移動</div>
</div>
<div class="paragraph">
<p>エディタの「XML」ビューに`web.xml`ファイルが表示されます。NetBeansが`web.xml`ファイルに提供しているテンプレートでは、デフォルトとして30分が設定されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;session-config&gt;
    &lt;session-timeout&gt;
        30
    &lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>「一般」タブをクリックして、「セッション・タイム・アウト」フィールドに「<code>10</code>」と入力します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-timeout.png" alt="session timeout">
</div>
<div class="title">Figure 28. web.xmlの「一般」タブでの、アプリケーションのセッション・タイムアウトの指定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>ファイルを保存します([Ctrl]-[S]、Macの場合は[⌘]-[S])。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>「XML」ビューに戻ると、`&lt;session-timeout&gt;`要素が更新されていることを確認できます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;session-config&gt;
    &lt;session-timeout&gt;10&lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>*注意: *かわりに、<code>&lt;session-timeout&gt;`要素をすべて除去し、GlassFish固有のデプロイメント・ディスクリプタ(`sun-web.xml</code>)で`session-properties`要素を編集することもできます。これを行うと、サーバーのWebモジュールにあるすべてのアプリケーションのグローバル・タイム・アウトが設定されます。詳細は、<a href="http://docs.sun.com/app/docs/doc/821-1752/beaha">Oracle GlassFish Server 3.0.1アプリケーション開発ガイド: セッションの作成および管理</a>を参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="programmatically">プログラムによるセッション・タイム・アウトの処理</h3>
<div class="paragraph">
<p>アプリケーションがセッションに依存している場合、タイム・アウトしたセッションや識別できないセッションに対するリクエストを受け取ったときにも正常に処理できるようにする必要があります。`AffableBean`アプリケーションでこれを実現するには、`ControllerServlet`に送信されたリクエストをインターセプトする単純なフィルタを作成します。このフィルタはセッションが存在するかどうかをチェックして、存在しなければリクエストをサイトの開始ページに転送します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>まず、ユーザーがサイトにアクセスしている途中でセッションがタイム・アウトする場合に起こる問題を調べます。一時的に、セッション・タイム・アウトの間隔を1分にリセットします。Webデプロイメント・ディスクリプタ(<code>web.xml</code>)を開き、<code>&lt;session-timeout&gt;`タグの間に「`1</code>」を入力します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;session-config&gt;
    &lt;session-timeout&gt;*1*&lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>`AffableBean`プロジェクトを実行します。ブラウザでカテゴリ・ページをクリックして、項目をいくつかカートに追加してから「view cart」をクリックします。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/cart-page-session-intact.png" alt="cart page session intact">
</div>
<div class="title">Figure 29. カート・ページにはセッション・オブジェクトに応じてショッピング・カートの項目が表示される</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>少なくとも1分間待ちます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>カート・ページに表示された項目のうち、1つの項目の数量を更新します。(1から99までのいずれかの数字を入力できます。)「update」をクリックします。サーバーからHTTPステータス500のメッセージが返されます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/glassfish-error-report.png" alt="glassfish error report">
</div>
<div class="title">Figure 30. 有効期限切れセッションに対するリクエストを受信するとNullPointerExceptionが発生する</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>IDEでGlassFishサーバー・ログを調べます。「出力」ウィンドウ([Ctrl]-[4]、Macの場合は[⌘]-[4])を開き、「GlassFish Server」タブを選択します。ログの最下部までスクロールして、エラーのスタック・トレースを調べます。</p>
</li>
</ol>
</div>
<div class="openblock">
<div class="content">
<div class="paragraph">
<p><span class="image left"><a class="image" href="images/gf-server-output.png"><img src="images/gf-server-output.png" alt="gf server output"></a></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>サーバー・ログに、`ControllerServlet`の184行目で`NullPointerException`が発生したことが示されています。「出力」ウィンドウには、例外が発生した行へのリンクが表示されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>リンクをクリックします。`ControllerServlet`の184行目に直接移動します。エディタの左マージンにあるエラー・バッジの上にカーソルを置くと、例外を説明するツールチップが表示されます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/nullpointer-exception.png" alt="nullpointer exception">
</div>
<div class="title">Figure 31. エラー・バッジとツールチップによる問題の場所および原因の提示</div>
</div>
<div class="paragraph">
<p>リクエストを受け取る前にセッションがすでに有効期限切れになっていたため、サーブレット・エンジンは、対応するセッションにリクエストを関連付けることができませんでした。このため、`cart`オブジェクトを見つけられませんでした(151行目)。最終的に184行目で、`null`と等しい変数のメソッドをエンジンがコールしようとしたときに例外が発生しました。</p>
</div>
<div class="paragraph">
<p>これで問題を特定できたので、フィルタを実装して修正しましょう。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>IDEのメイン・ツールバーにある「新規ファイル」(<span class="image"><img src="images/new-file-btn.png" alt="new file btn"></span>)ボタンをクリックします。または、[Ctrl]-[N] (Macの場合は[⌘]-[N])を押します。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="8">
<li>
<p>「<strong>Web</strong>」カテゴリから「<strong>フィルタ</strong>」を選択し、「次」をクリックします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="9">
<li>
<p>フィルタに「<code>SessionTimeoutFilter</code>」という名前を付けます。「パッケージ」フィールドに「<code>filter</code>」と入力して、フィルタ・クラスが作成時に新しいパッケージに配置されるようにします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="10">
<li>
<p>「次」をクリックします。デフォルトの設定を受け入れ、「終了」をクリックします。`SessionTimeoutFilter`のテンプレートが生成され、エディタで開きます。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>注意:</strong> NetBeans 6.9の時点では、ウィザードを使用してWebデプロイメント・ディスクリプタに登録されていないサーブレットへのマッピングを設定できません。(<code>ControllerServlet`は</code>@WebServlet`注釈を使用して登録されています。)このため、生成されたコードを次の手順で変更します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="11">
<li>
<p>`@WebFilter`注釈署名を次のように変更します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@WebFilter(*servletNames = {"Controller"}*)
public class SessionTimeoutFilter implements Filter {</code></pre>
</div>
</div>
<div class="paragraph">
<p>これによって、`ControllerServlet`が処理するすべてのリクエストをインターセプトするようにフィルタが設定されます。(または、`urlPatterns`属性を保持して、`ControllerServlet`が処理するすべてのパターンをリストすることもできます。)</p>
</div>
<div class="paragraph">
<p>サーブレットの`@WebServlet`注釈署名に指定されているように、「<code>Controller</code>」は`ControllerServlet`の名前です。また、フィルタ・クラスの名前がデフォルトで使用されているため、`filterName`属性は除去しています。</p>
</div>
<div class="paragraph">
<p>IDEのフィルタ・テンプレート自体に、調べる価値のある有用なコードが多く含まれています。ただし、そのほとんどはここでの目的には不要なものです。どのフィルタ・クラスも、次の3つのメソッドを定義する`Filter`インタフェースを実装する必要があります。
* <strong><code>init</code>:</strong> フィルタが初期化されてから使用が開始されるまでの間に、任意のアクションを実行します。
* <strong><code>destroy</code>:</strong> 使用を停止してフィルタを除去します。このメソッドは、任意のクリーン・アップ操作を実行するためにも使用できます。
* <strong><code>doFilter</code>:</strong> フィルタがインターセプトするリクエストごとの操作の実行に使用されます。</p>
</div>
<div class="paragraph">
<p><code>Filter`インタフェースに関するドキュメントを参照するには、「Javadoc索引検索」を使用します。[Shift]-[F1] (Macの場合は[fn]-[Shift]-[F1])を押してから、検索フィールドに「`Filter</code>」と入力して[Enter]を押します。「Interface in javax.servlet」エントリを選択します。索引検索ツールの下部のペインに、Javadocドキュメントが表示されます。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="12">
<li>
<p>`SessionTimeoutFilter`の本文を、次の内容に置き換えます。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">@WebFilter(servletNames = {"Controller"})
public class SessionTimeoutFilter implements Filter {

    *public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest req = (HttpServletRequest) request;

        HttpSession session = req.getSession(false);

        // if session doesn't exist, forward user to welcome page
        if (session == null) {
            try {
                req.getRequestDispatcher("/index.jsp").forward(request, response);
            } catch (Exception ex) {
                ex.printStackTrace();
            }
            return;
        }

        chain.doFilter(request, response);
    }

    public void init(FilterConfig filterConfig) throws ServletException {}

    public void destroy() {}*

}</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="13">
<li>
<p>[Ctrl]-[Shift]-[I] (Macの場合は[⌘]-[Shift]-[I])を押してインポート文を修正します。(<code>HttpServletRequest`および`HttpSession`のためのインポートの追加が必要。)また、エディタのヒントを使用して`init</code>、<code>destroy`および`doFilter`メソッドに</code>@Override`注釈を追加します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以降の手順では、プロジェクトでデバッガを実行して`doFilter`メソッドをステップ実行し、リクエストが既存のセッションにバインドされているかどうかをこのメソッドが判定する方法を確認します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="14">
<li>
<p>「ブレークポイント」ウィンドウを開き([Alt]-[Shift]-[5]、Macの場合は[Ctrl]-[Shift]-[5])、既存のブレークポイントが設定されていないことを確認します。ブレークポイントを削除するには、ブレークポイントを右クリックして「削除」を選択します。(前述の課題である<a href="#http-monitor">HTTPモニターによるクライアントとサーバー間の通信の確認</a>を完了した場合は、`ControllerServlet`に未処理のブレークポイントが設定されている可能性があります。)</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="15">
<li>
<p>デバッガを実行します。IDEのメイン・ツールバーにある「プロジェクトをデバッグ」(<span class="image"><img src="images/debug-project-btn.png" alt="debug project btn"></span>)ボタンをクリックします。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="16">
<li>
<p>ブラウザに開始ページが表示されたら、カテゴリを選択してからショッピング・カートにいくつか項目を追加します。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="17">
<li>
<p>`SessionTimeoutFilter`の`doFilter`メソッドで、セッションへのアクセスを試行する行(32行目)にブレークポイントを設定します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/filter-breakpoint.png" alt="filter breakpoint">
</div>
<div class="title">Figure 32. getSessionメソッドへのブレークポイントの設定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="18">
<li>
<p>ブラウザで「view cart」ボタンをクリックします。IDEに切り替えると、デバッガがブレークポイントで一時停止されていることがわかります。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>その時点でセッション・オブジェクトが存在しない場合、`getSession()`は新しいセッション・オブジェクトを作成することを思い出してください。ここでは、オブジェクトが見つからなくても新規作成を行わない`getSession(false)`を使用します。つまり、セッションが存在しない場合、メソッドは`null`を返します。</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="19">
<li>
<p>「ステップ・オーバー」(<span class="image"><img src="images/step-over-btn.png" alt="step over btn"></span>)ボタンをクリックしてから、`session`変数の上にカーソルを移動します。前回のリクエストが送信されてから1分が経過していなければ、変数が`StandardSessionFacade`に割り当てられていることを確認できます。これは、リクエストのセッション・オブジェクトを表します。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-exists.png" alt="session exists">
</div>
<div class="title">Figure 33. 変数へのカーソルの移動によるその現在値の判定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="20">
<li>
<p>リクエストが処理されるまで、メソッドをステップ実行し続けます。`session`は`null`と等しくないため、`if`文をスキップすると、`chain.doFilter`はリクエストを`ControllerServlet`に転送します(44行目)。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="21">
<li>
<p>ブラウザで、1分間が過ぎたことを確認してから、カートの製品項目のうちの1つの数量を更新します。この手順は、この課題の最初の方で実行してステータス500のメッセージが返されたときと同じ手順です。ここでは、`ControllerServlet`に送信されたリクエストをフィルタがインターセプトするようになったので、セッション・タイム・アウトが起きるとどうなるかを確認しましょう。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="22">
<li>
<p>「update」をクリックしてからIDEに切り替えると、フィルタに設定されたブレークポイントでデバッガが再度一時停止されています。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="23">
<li>
<p>`req.getSession(false)`の式を強調表示してから、この上にカーソルを移動します。ここでは、セッションがすでに有効期限切れになっているため、式が`null`と等しいことが確認できます。</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="images/session-null.png" alt="session null">
</div>
<div class="title">Figure 34. 強調表示した式へのカーソルの移動によるその現在値の判定</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="24">
<li>
<p>続けてコードをステップ実行します。ここでは、<code>session`変数が`null`と等しくなっているため、35行目の`if`文が処理され、リクエストが</code>/index.jsp`に転送されます。デバッガが実行を終了すると、ブラウザにサイトの開始ページが表示されます。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="25">
<li>
<p>セッションの終了(<span class="image"><img src="images/finish-session-btn.png" alt="finish session btn"></span>)ボタンをクリックして、デバッグ・セッションを終了します。</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic" start="26">
<li>
<p>プロジェクトの`web.xml`ファイルを開き、セッション・タイム・アウトの間隔を10分に戻します。</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="xml">&lt;session-config&gt;
    &lt;session-timeout&gt;*10*&lt;/session-timeout&gt;
&lt;/session-config&gt;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="27">
<li>
<p>ファイルを保存([Ctrl]-[S]、Macの場合は[⌘]-[S])します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="https://netbeans.org/projects/samples/downloads/download/Samples%252FJavaEE%252Fecommerce%252FAffableBean_snapshot6.zip">スナップショット6</a>は、このチュートリアル・ユニットのプロジェクトの完成版を示しています。最後に、セッション管理に関する1つのトピックについて説明します。セッション・オブジェクトで`invalidate`メソッドをコールすることで、セッションを明示的に終了させることができます。セッションが不要になったら、サーバーが使用するメモリーを節約するために、そのセッションは除去するようにしてください。次のユニットである<a href="transaction.html">ビジネス・ロジックの取引の統合</a>を完了すると、顧客の注文を正常に処理したときに`ControllerServlet`が`invalidate`メソッドを使用してどのようにユーザーの`cart`オブジェクトを破棄し、セッションを終了するかがわかります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code data-lang="java">// if order processed successfully send user to confirmation page
if (orderId != 0) {

    // dissociate shopping cart from session
    cart = null;

    // end session
    session.invalidate();

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>これは、<a href="https://netbeans.org/projects/samples/downloads/download/Samples%252FJavaEE%252Fecommerce%252FAffableBean_snapshot8.zip">プロジェクト・スナップショット8</a> (およびそれ以降のスナップショット)に示されています。</p>
</div>
<div class="paragraph">
<p>link:/about/contact_form.html?to=3&amp;subject=Feedback: NetBeans E-commerce Tutorial - Managing Sessions[ご意見をお寄せください]</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="seeAlso">関連項目</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_netbeansリソース">NetBeansリソース</h3>
<div class="ulist">
<ul>
<li>
<p><a href="../../../../features/java/debugger.html">NetBeans IDEの機能: デバッガ</a></p>
</li>
<li>
<p><a href="../../java/debug-multithreaded.html">マルチスレッド・アプリケーションのデバッグ</a></p>
</li>
<li>
<p><a href="../../java/debug-multithreaded-screencast.html">NetBeans IDEを使用したマルチスレッド・デバッグのビデオ</a></p>
</li>
<li>
<p><a href="../../java/debug-evaluator-screencast.html">NetBeansデバッガのコード・スニペット評価の使用のビデオ</a></p>
</li>
<li>
<p><a href="../../screencasts.html">NetBeans IDE 6.xのビデオ・チュートリアルとデモ</a></p>
</li>
<li>
<p><a href="https://netbeans.org/projects/www/downloads/download/shortcuts.pdf">キーボード・ショートカットおよびコード・テンプレートのカード</a></p>
</li>
<li>
<p><a href="../javaee-gettingstarted.html">Java EE 6アプリケーションの開始</a></p>
</li>
<li>
<p><a href="../javaee-intro.html">Java EEテクノロジ入門</a></p>
</li>
<li>
<p><a href="../../../trails/java-ee.html">Java EEおよびJava Webの学習</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_glassfishリソース">GlassFishリソース</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://wiki.glassfish.java.net/Wiki.jsp?page=Screencasts">GlassFishスクリーンキャスト</a></p>
</li>
<li>
<p><a href="https://glassfish.dev.java.net/docs/index.html">GlassFish v3ドキュメント</a></p>
</li>
<li>
<p><a href="http://www.sun.com/offers/details/GlassFish_Tomcat.html">Tomcatユーザー向けGlassFishの学習</a></p>
</li>
<li>
<p><a href="http://docs.sun.com/app/docs/doc/821-1751">Oracle GlassFish Server 3.0.1管理ガイド</a></p>
</li>
<li>
<p><a href="http://docs.sun.com/app/docs/doc/821-1750">Oracle GlassFish Server 3.0.1アプリケーション・デプロイメント・ガイド</a></p>
</li>
<li>
<p><a href="http://docs.sun.com/app/docs/doc/821-1752">Oracle GlassFish Server 3.0.1アプリケーション開発ガイド</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_技術記事およびその他のリソース">技術記事およびその他のリソース</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://java.sun.com/javaee/reference/code/">Java EEコード・サンプルおよびアプリケーション</a></p>
</li>
<li>
<p><a href="http://java.sun.com/j2se/javadoc/">Javadocツール</a> (製品ホーム・ページ)</p>
</li>
<li>
<p><a href="http://java.sun.com/j2se/javadoc/writingdoccomments/index.html">Javadocツールのドキュメント・コメントを書く方法</a></p>
</li>
<li>
<p><a href="http://java.sun.com/products/servlet/Filters.html">フィルタの基本</a></p>
</li>
<li>
<p><a href="http://java.sun.com/blueprints/corej2eepatterns/Patterns/InterceptingFilter.html">コアJ2EEパターン - フィルタのインターセプト</a></p>
</li>
<li>
<p><a href="http://courses.coreservlets.com/Course-Materials/csajsp2.html">サーブレット、JSPおよびJDBCの初級・中級レベル・チュートリアル</a></p>
</li>
<li>
<p><a href="http://courses.coreservlets.com/Course-Materials/msajsp.html">サーブレットおよびJSPの上級チュートリアル</a></p>
</li>
<li>
<p><a href="http://courses.coreservlets.com/Course-Materials/java5.html">Java 5およびJava 6チュートリアル</a></p>
</li>
<li>
<p><a href="http://www.ibm.com/developerworks/java/library/j-jstl0211.html">JSTL入門、パート1: 式言語</a></p>
</li>
<li>
<p><a href="http://www.ibm.com/developerworks/java/library/j-jstl0318/index.html">JSTL入門、パート2: coreライブラリについて</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
      
<section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="Issues" href="https://github.com/apache/netbeans/issues"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        
        <li><a href="https://github.com/apache/netbeans-website/blob/master/netbeans.apache.org/src/content/kb/docs/javaee/ecommerce/manage-sessions_ja.adoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>

    </div>
    

    <div class='grid-container incubator-area' style='margin-top: 64px'>
      <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/">
            <img style="width: 320px" title="Apache Software Foundation" src="/images/asf_logo_wide.svg" />
          </a>
        </div>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/events/current-event.html">
            <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
          </a>
        </div>
      </div>
    </div>
    <footer>
      <div class="grid-container">
        <div class="grid-x grid-padding-x">
          <div class="large-auto cell">
                    
            <h1><a href="/about/index.html">About</a></h1>
            <ul>
              <li><a href="https://netbeans.apache.org/community/who.html">Who's Who</a></li>
              <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
              <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
              <li><a href="https://www.apache.org/security/">Security</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/community/index.html">Community</a></h1>
            <ul>
              <li><a href="/community/mailing-lists.html">Mailing lists</a></li>
              <li><a href="/community/committer.html">Becoming a committer</a></li>
              <li><a href="/community/events.html">NetBeans Events</a></li>
              <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/participate/index.html">Participate</a></h1>
            <ul>
              <li><a href="/participate/submit-pr.html">Submitting Pull Requests</a></li>
              <li><a href="/participate/report-issue.html">Reporting Issues</a></li>
              <li><a href="/participate/index.html#documentation">Improving the documentation</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/help/index.html">Get Help</a></h1>
            <ul>
              <li><a href="/help/index.html#documentation">Documentation</a></li>
              <li><a href="/wiki/index.html">Wiki</a></li>
              <li><a href="/help/index.html#support">Community Support</a></li>
              <li><a href="/help/commercial-support.html">Commercial Support</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="/download/index.html">Download</a></h1>
            <ul>
              <li><a href="/download/index.html">Releases</a></li>                    
              <li><a href="https://plugins.netbeans.apache.org/">Plugins</a></li>
              <li><a href="/download/index.html#source">Building from source</a></li>
              <li><a href="/download/index.html#previous">Previous releases</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    <div class='footer-disclaimer'>
      <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2023 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
          <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
          <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
          <p>The Apache NetBeans website conforms to the <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Apache Software Foundation Privacy Policy</a></p>
        </div>
            
      </div>
    </div>


    

    <script src="/js/vendor/jquery-3.2.1.min.js"></script>
    <script src="/js/vendor/what-input.js"></script>
    <script src="/js/vendor/foundation.min.js"></script>
    <script src="/js/vendor/jquery.colorbox-min.js"></script>
    <script src="/js/netbeans.js"></script>
    <script>

       $(function(){ $(document).foundation(); });
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
    <script>
       $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); }); 
    </script>

  </body>
</html>
