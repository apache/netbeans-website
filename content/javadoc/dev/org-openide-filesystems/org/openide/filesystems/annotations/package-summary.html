<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc -->
<title>org.openide.filesystems.annotations (File System API)</title>
<link rel="stylesheet" type="text/css" href="../../../../javadoc.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="org.openide.filesystems.annotations (File System API)";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
<div class="aboutLanguage">org.openide.filesystems 9.13 </div>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../org/openide/filesystems/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../org/openide/filesystems/spi/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?org/openide/filesystems/annotations/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;org.openide.filesystems.annotations</h1>
<div class="docSummary">
<div class="block">Support for writing annotation processors which generate XML layer fragments.</div>
</div>
<p>See:&nbsp;<a href="#package.description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../org/openide/filesystems/annotations/LayerBuilder.html" title="class in org.openide.filesystems.annotations">LayerBuilder</a></td>
<td class="colLast">
<div class="block">Convenience class for generating fragments of an XML layer.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../org/openide/filesystems/annotations/LayerGeneratingProcessor.html" title="class in org.openide.filesystems.annotations">LayerGeneratingProcessor</a></td>
<td class="colLast">
<div class="block">Convenience base class for an annotation processor which creates XML layer entries.</div>
</td>
</tr>
</tbody>
</table>
</li>
<li class="blockList">
<table class="typeSummary" border="0" cellpadding="3" cellspacing="0" summary="Exception Summary table, listing exceptions, and an explanation">
<caption><span>Exception Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Exception</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../org/openide/filesystems/annotations/LayerGenerationException.html" title="class in org.openide.filesystems.annotations">LayerGenerationException</a></td>
<td class="colLast">
<div class="block">Exception thrown when a layer entry cannot be generated due to erroneous sources.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package.description">
<!--   -->
</a>
<h2 title="Package org.openide.filesystems.annotations Description">Package org.openide.filesystems.annotations Description</h2>
<div class="block">Support for writing annotation processors which generate XML layer fragments.
 <p>Whenever an SPI author defines a new way for objects to be registered in
 the system filesystem, it is encouraged to also define a matching annotation
 which can create such a registration. If the SPI is associated with a particular
 Java interface (or abstract class), conventionally this annotation should be named
 <code>Registration</code> and be located as a nested type inside the interface.</p>
 <p>For example, consider an interface <code>FrobnitzFactory</code> which should be
 registered for a particular data type such as <code>text/html</code>. The SPI may
 declare that a frobnitz factory should be located in the system filesystem
 in the folder <code>FrobnitzFactories/mime/type/</code> where <code>mime/type</code> is
 the associated data type, and should be declared as an instance file whose instance
 is assignable to <code>FrobnitzFactory</code> (basename of file irrelevant).<p>
 <p>(The SPI could also have just declared a global service interface where each
 instance specifies its desired MIME type in the return value of a method. This
 would work but would be undesirable from a performance perspective: the first
 time the SPI ran, it would need to load <em>every</em> frobnitz factory in the
 system, which could mean a lot of class loading, even though only one was
 actually going to be used. Choosing a smart registration style can help avoid this
 kind of performance mistake, and friendly registration annotations mean that
 module developers can do the right thing without much effort.)</p>
 <p>The SPI may also stipulate that for a given data type, it may matter which
 factory is found "first". SPI code to handle the factories might look like:</p>
 <pre>
static Frobnitz findFrobnitz(FileObject f) {
    for (FrobnitzFactory ff : Lookups.forPath("FrobnitzFactories/" + f.getMIMEType()).
            lookup(FrobnitzFactory.class).allInstances()) {
        Frobnitz fz = ff.newFrobnitz(f);
        if (fz != null) {
            return fz;
        }
    }
    return null;
}
 </pre>
 <p>There should then be an interface with a corresponding annotation:</p>
 <pre>
public interface FrobnitzFactory {
    Frobnitz newFrobnitz(FileObject file); // may return null
    &#64;interface Registration {
        String mimeType();
        int position() default Integer.MAX_VALUE;
    }
}
 </pre>
 <p>Using the annotation is simple. The module author need create just one file
 containing both the factory and its registration:</p>
 <pre>
&#64;FrobnitzFactory.Registration(mimeType="text/html", position=300)
public class HtmlFactory implements FrobnitzFactory {
    public Frobnitz newFrobnitz(FileObject file) {...}
}
 </pre>
 <p>Now writing the annotation processor to create such a layer registration is easy.
 Put the processor in some nonpublic package in the SPI module and register it
 using <a href="http://netbeans.apache.org/javadoc/dev/org-openide-util-lookup/org/openide/util/lookup/ServiceProvider.html?is-external=true" title="class or interface in org.openide.util.lookup"><code>ServiceProvider</code></a>.
 You should extend <a href="../../../../org/openide/filesystems/annotations/LayerGeneratingProcessor.html" title="class in org.openide.filesystems.annotations"><code>LayerGeneratingProcessor</code></a>, which manages the physical
 writing of the generated layer fragment(s) in cooperation with any other active processors.
 The <a href="../../../../org/openide/filesystems/annotations/LayerBuilder.html" title="class in org.openide.filesystems.annotations"><code>LayerBuilder</code></a> helper class is used to create file entries and attributes.
 <a href="../../../../org/openide/filesystems/annotations/LayerGenerationException.html" title="class in org.openide.filesystems.annotations"><code>LayerGenerationException</code></a> can also be thrown if the source code is erroneous.</p>
 <pre>
&#64;ServiceProvider(service=Processor.class)
&#64;SupportedSourceVersion(SourceVersion.RELEASE_6)
public class FrobnitzFactoryProcessor extends LayerGeneratingProcessor {
    public &#64;Override Set&lt;String> getSupportedAnnotationTypes() {
        return Collections.singleton(Registration.class.getCanonicalName());
    }
    protected boolean handleProcess(Set&lt;? extends TypeElement> annotations,
                                    RoundEnvironment roundEnv)
                      throws LayerGenerationException {
        if (roundEnv.processingOver()) {
            return false;
        }
        for (Element e : roundEnv.getElementsAnnotatedWith(Registration.class)) {
            Registration r = e.getAnnotation(Registration.class);
            if (!r.mimeType().matches("(text|application|image)/([^/]+)")) {
                throw new LayerGenerationException("Bad MIME type: " + r.mimeType(), e);
            }
            layer(e).instanceFile("FrobnitzFactories/" + r.mimeType(), null,
                FrobnitzFactory.class).position(r.position()).write();
        }
        return true;
    }
}
 </pre>
 <p>Now when the module is compiled, <code>build/classes/META-INF/generated-layer.xml</code>
 should look something like this:</p>
 <pre>
&lt;filesystem>
    &lt;folder name="FrobnitzFactories">
        &lt;folder name="text">
            &lt;folder name="html">
                &lt;file name="my-module-HtmlFactory.instance">
                    &lt;attr name="position" intvalue="300"/>
                &lt;/file>
            &lt;/folder>
        &lt;/folder>
    &lt;/folder>
&lt;/filesystem>
 </pre>
 <p>and this layer should be loaded automatically by the module system
 (in addition to any explicit layer specified in source code).</p>
 <p>There are two basic ways to test a layer-generating processor:</p>
 <ol>
 <li>Create some registrations of the annotation inside the unit test class
     (so that they are processed as the tests are compiled).
     Make the test check that the corresponding SPI loads the registrations.</li>
 <li>Run the processor programmatically on some sample registrations,
     confirming that it succeeds or aborts under the right conditions.
     For this, <code>AnnotationProcessorTestUtils</code> is useful.</li>
 </ol>
 <p><a href="http://hg.netbeans.org/main/raw-file/tip/openide.util/test/unit/src/org/netbeans/modules/openide/util/ServiceProviderProcessorTest.java"><code>ServiceProviderProcessorTest</code></a>
 demonstrates both styles.<p></div>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-files/index-1.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
<div class="aboutLanguage">org.openide.filesystems 9.13 </div>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../org/openide/filesystems/package-summary.html">Prev&nbsp;Package</a></li>
<li><a href="../../../../org/openide/filesystems/spi/package-summary.html">Next&nbsp;Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?org/openide/filesystems/annotations/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small><span class="footnote"></span><!-- See javadoc.css for timestamp information --></small></p>
</body>
</html>
