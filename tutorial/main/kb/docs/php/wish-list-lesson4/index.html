<!doctype html>
<html class="no-js" lang="en" dir="ltr">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Lesson 4: Optimizing the Code with Classes and Objects</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Lesson 4: Optimizing the Code with Classes and Objects - Apache NetBeans">
    <meta name="author" content="Apache NetBeans">
    <meta name="keywords" content="Apache NetBeans, Tutorials, Lesson 4: Optimizing the Code with Classes and Objects">
    <meta name="generator" content="Apache NetBeans">
    <link rel="stylesheet" href="../../../../../../_/css/font-awesome.min.css">
    <link rel="alternate" type="application/atom+xml" title="Apache NetBeans Blog" href="https://netbeans.apache.org/blogs/atom" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
    <link rel="stylesheet" href="../../../../../../_/css/netbeans.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../../../_/images/fav/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../../../_/images/fav/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../../../_/images/fav/favicon-16x16.png">
    <link rel="manifest" href="../../../../../../_/images/fav/site.webmanifest">
    <link rel="mask-icon" href="../../../../../../_/images/fav/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <link href="../../../../../../_/css/font-open-sans.css" rel="stylesheet">
    <!--
        Licensed to the Apache Software Foundation (ASF) under one
        or more contributor license agreements.  See the NOTICE file
        distributed with this work for additional information
        regarding copyright ownership.  The ASF licenses this file
        to you under the Apache License, Version 2.0 (the
        "License"); you may not use this file except in compliance
        with the License.  You may obtain a copy of the License at
        http://www.apache.org/licenses/LICENSE-2.0
        Unless required by applicable law or agreed to in writing,
        software distributed under the License is distributed on an
        "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        KIND, either express or implied.  See the License for the
        specific language governing permissions and limitations
        under the License.
    -->
  </head>
  <body>
    <div class="title-bar" data-responsive-toggle="responsive-menu" data-hide-for="medium">
    <button type="button" data-toggle="responsive-menu"><i style='font-size: 32px; color: #fff; padding: 8px' class='fa fa-bars'></i></button>
    <div class="title-bar-title">Apache NetBeans</div>
</div>
<div class="top-bar" id="responsive-menu">
    <div class='top-bar-left'>
        <a class='title' href="../../../../../../index.html"><img src='../../../../../../_/images/apache-netbeans.svg' style='padding: 8px; height: 48px;'></img> Apache NetBeans</a>
    </div>
    <div class="top-bar-right">
        <ul class="vertical medium-horizontal menu" data-responsive-menu="drilldown medium-dropdown">
            <li> <input id="search-input" type="text" placeholder="Search the docs"> </li>
            <li> <a href="../../../../../../front/main/community">Community</a> </li>
            <li> <a href="../../../../../../front/main/participate">Participate</a> </li>
            <li> <a href="../../../../../../front/main/blogs">Blog</a></li>
            <li> <a href="../../../../../../front/main/help">Get Help</a> </li>
            <li> <a href="https://plugins.netbeans.apache.org/">Plugins</a> </li>
            <li> <a href="../../../../../../front/main/download">Download</a> </li>
        </ul>
    </div>
</div>

    <!-- src/templates/news -->
<section class="hero news alternate">
    <div class='grid-container'>
        <div class='cell'>
            <div class="annotation">Latest release</div>
            <h1>Apache NetBeans 19</h1>
            <p><a class="button success" href="../../../../../../front/main/download/nb19">Download</a></p>
        </div>
    </div>
</section>
    <div class='grid-container main-content tutorial'>
      <article class="doc">
      <h1 class="sect0">Lesson 4: Optimizing the Code with Classes and Objects</h1>
            <div class="sectionbody">
              <div class="admonitionblock note">
                <table>
                  <tbody><tr>
                  <td class="icon"><i class="fa icon-note" title="Note"></i></td>
                  <td class="content">This tutorial needs a review. 
                     You can <a href="https://github.com/apache/netbeans-antora-tutorials/edit/main/modules/ROOT/pages/kb/docs/php/wish-list-lesson4.adoc" title="Edit this tutorial in github">edit it in GitHub </a>
                     following these <a href="../../../../../../tutorial/main/kb/docs/contributing">contribution guidelines.</a></td>
                  </tr></tbody>
                </table>
              </div>
            </div>
      <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#previousLessonSourceCode">Application Source Code from the Previous Lesson</a></li>
<li><a href="#createDbPhpFile">Creating the db.php File</a></li>
<li><a href="#wishDBClass">Creating the WishDB Class</a></li>
<li><a href="#instantiate-wishdb">Instantiating the WishDB class</a></li>
<li><a href="#wishdb-constructor">Adding a Constructor to the WishDB Class</a></li>
<li><a href="#includedFunctions">Functions in the WishDB Class</a>
<ul class="sectlevel2">
<li><a href="#getIDByName">Function get_wisher_id_by_name</a></li>
<li><a href="#getWishesByID">Function get_wishes_by_wisher_id</a></li>
<li><a href="#createWisher">Function create_wisher</a></li>
</ul>
</li>
<li><a href="#refactoring">Refactoring Your Application Code</a>
<ul class="sectlevel2">
<li><a href="#refactoringWishlistFile">Refactoring the wishlist.php File</a></li>
<li><a href="#refactoringCreateNewWisher">Refactoring the createNewWisher.php File</a></li>
</ul>
</li>
<li><a href="#lessonResultSourceCode">Application Source Code after the Current Lesson Is Completed</a></li>
<li><a href="#_next_steps">Next Steps</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this lesson you optimize the code to facilitate maintaining it in the future. This affects the files  <code>createNewWisher.php</code>  and  <code>wishlist.php</code> . Additionally, a new file called  <code>db.php</code>  is created.</p>
</div>
<div class="paragraph">
<p>Your application&#8217;s code contains several similar blocks with queries to the database. To make the code easier to read and maintain in the future, you can extract these blocks, implement them as functions of a separate class called  <code>WishDB</code> , and place  <code>WishDB</code>  in  <code>db.php</code> . Afterwards you can include the  <code>db.php</code>  file in any PHP file and use any <a href="#includedFunctions">function from WishDB</a> without code duplication. Such an approach ensures that any changes to queries or functions will be made in one place and you will not have to parse the entire application code.</p>
</div>
<div class="paragraph">
<p>When you use a function from WishDB, you do not change the value of any of WishDB&#8217;s variables. Instead, you use the WishDB class as a blueprint for creating an object of WishDB, and you change the values of variables in that object. When you finish working with that object, it is destroyed. Because the values of the WishDB class itself are never changed, you can reuse the class an unlimited number of times. In some cases you may want to have multiple instances of a class in existence at the same time, and in other cases you may prefer a "singleton" class, where you only have one instance in existence at any one time. WishDB in this tutorial is a singleton class.</p>
</div>
<div class="paragraph">
<p>Note that the term for creating an object of a class is "instantiating" that class, and that another word for an object is an "instance" of a class. The general term for programming with classes and objects is "object-oriented programming," or OOP. PHP 5 uses a sophisticated OOP model. See <a href="http://us3.php.net/zend-engine-2.php">php.net</a> for more information.</p>
</div>
<div class="paragraph">
<p>In this tutorial, you move the database call functionality from individual PHP files to the WishDB class. Users of MySQL also replace the procedural-style  <code>mysqli</code>  calls with object-oriented calls. This is in keeping with new, object-oriented design of the application</p>
</div>
<div class="paragraph">
<p>The current document is a part of the Creating a CRUD Application in the NetBeans IDE for PHP tutorial.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="previousLessonSourceCode"><a class="anchor" href="#previousLessonSourceCode"></a>Application Source Code from the Previous Lesson</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MySQL users: Click <a href="https://netbeans.org/files/documents/4/1929/lesson3.zip">here</a> to download the source code that reflects the project state after the previous lesson is completed.</p>
</div>
<div class="paragraph">
<p>Oracle Database users: Click <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson3.zip">here</a> to download the source code that reflects the project state after the previous lesson is completed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="createDbPhpFile"><a class="anchor" href="#createDbPhpFile"></a>Creating the db.php File</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create a new subfolder in the Source Files folder. Name the folder Includes. Create a new file named db.php and place it in Includes. Later you can add more files to this folder that will be included in other PHP files.</p>
</div>
<div class="paragraph">
<p><strong>To create db.php in a new folder:</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the right mouse button on the Source files node and choose New &gt; Folder from the context menu. The New Folder dialog opens.</p>
</li>
<li>
<p>In the Folder Name field, type Includes. Then click Finish.</p>
</li>
<li>
<p>Click the right mouse button on the Includes node and choose New &gt; PHP File from the context menu. The New PHP File dialog opens.</p>
</li>
<li>
<p>In the File Name field, type db. Then click Finish.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wishDBClass"><a class="anchor" href="#wishDBClass"></a>Creating the WishDB Class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To create the WishDB class, you need to initialize the variables of the class and implement a constructor of the class. MySQL users please note that the WishDB class <em>extends</em>  <code>mysqli</code> . This means that WishDB <em>inherits</em> the functions and other characteristics of the PHP mysqli class. You will see the importance of this when you add  `mysqli ` functions to the class.</p>
</div>
<div class="paragraph">
<p>Open the file db.php and create the WishDB class. In the class, declare database configuration variables for storing the name and password of the database owner (user), the name of the database, and the database host. All these variable declarations are "private," meaning that the initial values in the declarations cannot be accessed from outside the WishDB class (See <a href="http://us3.php.net/manual/en/language.oop5.visibility.php">php.net</a>). You also declare the private _ static_  <code>$instance</code>  variable, which stores the instance of WishDB. The "static" keyword means that functions in the class can access the variable even when there is no instance of the class.</p>
</div>
<div class="paragraph">
<p><strong>For MySQL Database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">class WishDB extends mysqli {

    // single instance of self shared among all instances
    private static $instance = null;

    // db connection config vars
    private $user = "phpuser";
    private $pass = "phpuserpw";
    private $dbName = "wishlist";
    private $dbHost = "localhost";

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For Oracle Database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">class WishDB {

    // single instance of self shared among all instances
    private static $instance = null;

    // db connection config vars
    private $user = "phpuser";
    private $pass = "phpuserpw";
    private $dbName = "wishlist";
    private $dbHost = "localhost/XE";
    private $con = null;

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="instantiate-wishdb"><a class="anchor" href="#instantiate-wishdb"></a>Instantiating the WishDB class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For other PHP files to use functions in the WishDB class, these PHP files need to call a function that creates an object of ("instantiates") the WishDB class. WishDB is designed as a <a href="http://www.phpclasses.org/browse/package/1151.html">singleton class</a>, meaning that only one instance of the class is in existence at any one time. It is therefore useful to prevent any external instantiation of WishDB, which could create duplicate instances.</p>
</div>
<div class="paragraph">
<p>Inside the WishDB class, type or paste the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// This method must be static, and must return an instance of the object if the object
// does not already exist.

public static function getInstance() {

  if (!self::$instance instanceof self) {
    self::$instance = new self;
  }

  return self::$instance;
}

// The clone and wakeup methods prevents external instantiation of copies of the Singleton class,
// thus eliminating the possibility of duplicate objects.

public function __clone() {
  trigger_error('Clone is not allowed.', E_USER_ERROR);
}

public function __wakeup() {
  trigger_error('Deserializing is not allowed.', E_USER_ERROR);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The  <code>getInstance</code>  function is "public" and "static." "Public" means that it can be freely accessed from outside the class. "Static" means that the function is available even when the class has not been instantiated. As the  <code>getInstance</code>  function is called to instantiate the class, it must be static. Note that this function accesses the static  <code>$instance</code>  variable and sets its value as the instance of the class.</p>
</div>
<div class="paragraph">
<p>The double-colon (::), called the Scope Resolution Operator, and the  <code>self</code>  keyword are used to access static functions.  <code>Self</code>  is used from within the class definition to refer to the class itself. When the double-colon is used from outside the class definition, the name of the class is used instead of  <code>self</code> . See <a href="http://us3.php.net/manual/en/language.oop5.paamayim-nekudotayim.php">php.net on the Scope Resolution Operator</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wishdb-constructor"><a class="anchor" href="#wishdb-constructor"></a>Adding a Constructor to the WishDB Class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A class can contain a special method known as a 'constructor' which is automatically processed whenever an instance of that class is created. In this tutorial, you add a constructor to WishDB that connects to the database whenever WishDB is instantiated.</p>
</div>
<div class="paragraph">
<p>Add the following code to WishDB:</p>
</div>
<div class="paragraph">
<p><strong>For the MySQL database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// private constructor
private function __construct() {

  parent::__construct($this-&gt;dbHost, $this-&gt;user, $this-&gt;pass, $this-&gt;dbName);

  if (mysqli_connect_error()) {
    exit('Connect Error (' . mysqli_connect_errno() . ') '. mysqli_connect_error());
  }

  parent::set_charset('utf-8');
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For the Oracle database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// private constructor
private function __construct() {

    $this-&gt;con = oci_connect($this-&gt;user, $this-&gt;pass, $this-&gt;dbHost);

    if (!$this-&gt;con) {
        $m = oci_error();
        echo $m['message'], "\n";
        exit;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the pseudovariable  <code>$this</code>  instead of the variables  <code>$con</code> ,  <code>$dbHost</code> ,  <code>$user</code> , or  <code>$pass</code> . The pseudovariable  <code>$this</code>  is used when a method is called from within an object context. It refers to the value of a variable within that object.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="includedFunctions"><a class="anchor" href="#includedFunctions"></a>Functions in the WishDB Class</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lesson you will implement the following functions of the WishDB class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#getIDByName">get_wisher_id_by_name</a> for retrieving the id of a wisher based on the wisher&#8217;s name</p>
</li>
<li>
<p><a href="#getWishesByID">get_wishes_by_wisher_id</a> for retrieving a list of wishes of the wisher with a specific id</p>
</li>
<li>
<p><a href="#createWisher">create_wisher</a> for adding a new wisher record to the table wishers</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="getIDByName"><a class="anchor" href="#getIDByName"></a>Function get_wisher_id_by_name</h3>
<div class="paragraph">
<p>The function requires the name of a wisher as the input parameter and returns the wisher&#8217;s id.</p>
</div>
<div class="paragraph">
<p>Type or paste the following function into the WishDB class, after the WishDB function:</p>
</div>
<div class="paragraph">
<p><strong>For the MySQL database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function get_wisher_id_by_name($name) {

  $name = $this-&gt;real_escape_string($name);
  $wisher = $this-&gt;query("SELECT id FROM wishers WHERE name = '" . $name . "'");

  if ($wisher-&gt;num_rows &gt; 0){
    $row = $wisher-&gt;fetch_row();
    return $row[0];
  } else {
    return null;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For the Oracle database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function get_wisher_id_by_name($name) {

    $query = "SELECT id FROM wishers WHERE name = :user_bv";
    $stid = oci_parse($this-&gt;con, $query);

    oci_bind_by_name($stid, ':user_bv', $name);
    oci_execute($stid);

    //Because user is a unique value I only expect one row
    $row = oci_fetch_array($stid, OCI_ASSOC);

    if ($row) {
      return $row["ID"];
    } else {
      return null;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code block executes the query  <code>SELECT ID FROM wishers WHERE name = [variable for name of the wisher]</code> . The query result is an array of IDs from the records that meet the query. If the array is not empty this automatically means that it contains one element because the field name is specified as UNIQUE during the table creation. In this case the function returns the first element of the  <code>$result</code>  array (the element with the zero numbered). If the array is empty the function returns null.</p>
</div>
<div class="paragraph">
<p><strong>Security Note:</strong> For the MySQL database, the  `$name ` string is escaped in order to prevent SQL injection attacks. See <a href="https://en.wikipedia.org/wiki/SQL_injection">Wikipedia on SQL injections</a> and the <a href="http://us3.php.net/mysql_real_escape_string">mysql_real_escape_string documentation</a>. Although in the context of this tutorial you are not at risk of harmful SQL injections, it is best practice to escape strings in MySQL queries that would be at risk of such an attack. The Oracle database avoids this issue by using bind variables.</p>
</div>
</div>
<div class="sect2">
<h3 id="getWishesByID"><a class="anchor" href="#getWishesByID"></a>Function get_wishes_by_wisher_id</h3>
<div class="paragraph">
<p>The function requires the id of a wisher as the input parameter and returns the wishes registered for the wisher.</p>
</div>
<div class="paragraph">
<p>Enter the following code block:</p>
</div>
<div class="paragraph">
<p><strong>For the MySQL database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function get_wishes_by_wisher_id($wisherID) {
  return $this-&gt;query("SELECT id, description, due_date FROM wishes WHERE wisher_id=" . $wisherID);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For the Oracle database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function get_wishes_by_wisher_id($wisherID) {

  $query = "SELECT id, description, due_date FROM wishes WHERE wisher_id = :id_bv";
  $stid = oci_parse($this-&gt;con, $query);

  oci_bind_by_name($stid, ":id_bv", $wisherID);
  oci_execute($stid);

  return $stid;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code block executes the query  <code>"SELECT id, description, due_date FROM wishes WHERE wisherID=" . $wisherID</code>  and returns a resultset which is an array of records that meet the query. (The Oracle database uses a bind variable for database performance and security reasons.) The selection is performed by the wisherID, which is the foreign key for the  `wishes ` table.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You do not need the  <code>id</code>  value until Lesson 7.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="createWisher"><a class="anchor" href="#createWisher"></a>Function create_wisher</h3>
<div class="paragraph">
<p>The function creates a new record in the wishers table. The function requires the name and password of a new wisher as the input parameters and does not return any data.</p>
</div>
<div class="paragraph">
<p>Enter the following code block:</p>
</div>
<div class="paragraph">
<p><strong>For the MySQL database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function create_wisher ($name, $password) {

  $name = $this-&gt;real_escape_string($name);
  $password = $this-&gt;real_escape_string($password);

  return $this-&gt;query("INSERT INTO wishers (name, password) VALUES ('" . $name . "', '" . $password . "')");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>For the Oracle database:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">public function create_wisher($name, $password) {

  $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
  $stid = oci_parse($this-&gt;con, $query);

  oci_bind_by_name($stid, ':user_bv', $name);
  oci_bind_by_name($stid, ':pwd_bv', $password);
  oci_execute($stid);

  return $stid;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code block executes the query  <code>"INSERT wishers (Name, Password) VALUES ([variables representing name and password of new wisher])</code> . The query adds a new record to the "wishers" table with the fields "name" and "password" filled in with the values of  <code>$name</code>  and  <code>$password</code>  respectively.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="refactoring"><a class="anchor" href="#refactoring"></a>Refactoring Your Application Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that you have a separate class for working with the database, you can replace duplicated blocks with calls to the relevant functions from this class. This will help avoid misspelling and inconsistency in the future. Code optimization that does not affect the functionality is called refactoring.</p>
</div>
<div class="sect2">
<h3 id="refactoringWishlistFile"><a class="anchor" href="#refactoringWishlistFile"></a>Refactoring the wishlist.php File</h3>
<div class="paragraph">
<p>Start with the wishlist.php file because it is short and the improvements will be more illustrative.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At the top of the &lt;?php ?&gt; block, enter the following line to enable the use of the  <code>db.php</code>  file:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the code that connects to the database and gets the ID of the wisher with a call to the  <code>get_wisher_id_by_name</code>  function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For the <strong>MySQL database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

 $con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
  exit('Connect Error (' . mysqli_connect_errno() . ') '
          . mysqli_connect_error());
}
//set the default client character set
mysqli_set_charset($con, 'utf-8');

mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_GET['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='" . $user . "'");
if (mysqli_num_rows($wisher) &lt; 1) {
  exit("The person " . $_GET['user'] . " is not found. Please check the spelling and try again");
}
$row = mysqli_fetch_row($wisher);
$wisherID = $row[0];
mysqli_free_result($wisher);

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_GET["user"]);

if (!$wisherID) {
  exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Oracle database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

$con = oci_connect("phpuser", "phpuserpw", "localhost/XE");
if (!$con) {
  $m = oci_error();
  echo $m['message'], "\n";
  exit;
}
$query = "SELECT ID FROM wishers WHERE name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_GET['user'];

oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);

//Because user is a unique value I only expect one row
$row = oci_fetch_array($stid, OCI_ASSOC);
if (!$row) {
  echo("The person " . $user . " is not found. Please check the spelling and try again" );
  exit;
}
$wisherID = $row['ID'];

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_GET["user"]);

if (!$wisherID) {
  exit("The person " .$_GET["user"]. " is not found. Please check the spelling and try again" );
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new code first calls the  <code>getInstance</code>  function in WishDB. The  <code>getInstance</code>  function returns an instance of WishDB, and the code calls the  <code>get_wisher_id_by_name</code>  function within that instance. If the requested wisher is not found in the database, the code kills the process and displays an error message.</p>
</div>
<div class="paragraph">
<p>No code is necessary here for opening a connection to the database. The connection is opened by the constructor of the WishDB class. If the name and/or password changes, you need to update only the relevant variables of the WishDB class.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the code that gets wishes for a wisher identified by ID with code that calls the  <code>get_wishes_by_wisher_id</code>  function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For the <strong>MySQL database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

$result = mysqli_query($con, "SELECT description, due_date FROM wishes WHERE wisher_id=" . $wisherID);

// to replace

$result = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Oracle database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

$query = "SELECT description, due_date FROM wishes WHERE wisher_id = :id_bv";
$stid = oci_parse($con, $query);
oci_bind_by_name($stid, ":id_bv", $wisherID);
oci_execute($stid);

// to replace

$stid = WishDB::getInstance()-&gt;get_wishes_by_wisher_id($wisherID);</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remove the line that closes the database connection.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// For MYSQL database
mysqli_close($con);

// For Oracle database
oci_close($con);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is not necessary because the connection to the database is automatically closed when the WishDB object is destroyed. However, keep the code that frees the resource. You need to free all resources that use a connection to ensure that a connection is properly closed, even if you call a  <code>close</code>  function or destroy the instance with the database connection.</p>
</div>
</div>
<div class="sect2">
<h3 id="refactoringCreateNewWisher"><a class="anchor" href="#refactoringCreateNewWisher"></a>Refactoring the createNewWisher.php File</h3>
<div class="paragraph">
<p>Refactoring will not affect the HTML input form or the code for displaying the related error messages.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>At the top of the &lt;?php?&gt; block, enter the following code to enable the use of the  <code>db.php</code>  file:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">require_once("Includes/db.php");</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete the database connection credentials ( <code>$dbHost,</code>  etc). These are now in  <code>db.php</code> .</p>
</li>
<li>
<p>Replace the code that connects to the database and gets the ID of the wisher with a call to the  <code>get_wisher_id_by_name</code>  function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For the <strong>MySQL database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

$con = mysqli_connect("localhost", "phpuser", "phpuserpw");
if (!$con) {
  exit('Connect Error (' . mysqli_connect_errno() . ') '
          . mysqli_connect_error());
}
//set the default client character set
mysqli_set_charset($con, 'utf-8');

/** Check whether a user whose name matches the "user" field already exists */
mysqli_select_db($con, "wishlist");
$user = mysqli_real_escape_string($con, $_POST['user']);
$wisher = mysqli_query($con, "SELECT id FROM wishers WHERE name='".$user."'");
$wisherIDnum=mysqli_num_rows($wisher);
if ($wisherIDnum) {
  $userNameIsUnique = false;
}

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);

if ($wisherID) {
  $userNameIsUnique = false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Oracle database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

$con = oci_connect("phpuser", "phpuserpw", "localhost/XE", "AL32UTF8");
if (!$con) {
  $m = oci_error();
  exit('Connect Error ' . $m['message']);
}
$query = "SELECT id FROM wishers WHERE name = :user_bv";
$stid = oci_parse($con, $query);
$user = $_POST['user'];

oci_bind_by_name($stid, ':user_bv', $user);
oci_execute($stid);

//Each user name should be unique. Check if the submitted user already exists.
$row = oci_fetch_array($stid, OCI_ASSOC);
if ($row) {
  $userNameIsUnique = false;
}

// to replace

$wisherID = WishDB::getInstance()-&gt;get_wisher_id_by_name($_POST["user"]);
if ($wisherID) {
  $userNameIsUnique = false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The  <code>WishDB</code>  object exists as long as the current page is being processed. It is destroyed after the processing is completed or interrupted. The code for opening a connection to the database is not necessary because this is done by the WishDB function. The code for closing the connection is not necessary because the connection is closed as soon as the  <code>WishDB</code>  object is destroyed.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Replace the code that inserts new wishers into the database with code that calls the  <code>create_wisher</code>  function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For the <strong>MySQL database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {
  $password = mysqli_real_escape_string($con, $_POST['password']);
  mysqli_select_db($con, "wishlist");
  mysqli_query($con, "INSERT wishers (name, password) VALUES ('" . $user . "', '" . $password . "')");
  mysqli_free_result($wisher);
  mysqli_close($con);
  header('Location: editWishList.php');
  exit;
}

// to replace

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);

  header('Location: editWishList.php' );
  exit;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Oracle database</strong>, the code you replace is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php hljs" data-lang="php">// to remove

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  $query = "INSERT INTO wishers (name, password) VALUES (:user_bv, :pwd_bv)";
  $stid = oci_parse($con, $query);
  $pwd = $_POST['password'];
  oci_bind_by_name($stid, ':user_bv', $user);
  oci_bind_by_name($stid, ':pwd_bv', $pwd);
  oci_execute($stid);
  oci_free_statement($stid);
  oci_close($con);
  header('Location: editWishList.php');
  exit;
}

// to replace

if (!$userIsEmpty &amp;&amp; $userNameIsUnique &amp;&amp; !$passwordIsEmpty &amp;&amp; !$password2IsEmpty &amp;&amp; $passwordIsValid) {

  WishDB::getInstance()-&gt;create_wisher($_POST["user"], $_POST["password"]);

  header('Location: editWishList.php' );
  exit;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lessonResultSourceCode"><a class="anchor" href="#lessonResultSourceCode"></a>Application Source Code after the Current Lesson Is Completed</h2>
<div class="sectionbody">
<div class="paragraph">
<p>MySQL users: Click <a href="https://netbeans.org/projects/www/downloads/download/php%252Flesson4.zip">here</a> to download the source code that reflects the project state after the lesson is completed.</p>
</div>
<div class="paragraph">
<p>Oracle Database users: Click <a href="https://netbeans.org/projects/www/downloads/download/php%252Foracle-lesson4.zip">here</a> to download the source code that reflects the project state after the lesson is completed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="../wish-list-lesson3/" class="xref page">&lt;&lt; Previous lesson</a></p>
</div>
<div class="paragraph">
<p><a href="../wish-list-lesson5/" class="xref page">Next lesson &gt;&gt;</a></p>
</div>
<div class="paragraph">
<p><a href="../wish-list-tutorial-main-page/" class="xref page">Back to the Tutorial main page</a></p>
</div>
</div>
</div>
      <section class='tools'>
    <ul class="menu align-center">
        <li><a title="Facebook" href="https://www.facebook.com/NetBeans"><i class="fa fa-md fa-facebook"></i></a></li>
        <li><a title="Twitter" href="https://twitter.com/netbeans"><i class="fa fa-md fa-twitter"></i></a></li>
        <li><a title="Github" href="https://github.com/apache/netbeans"><i class="fa fa-md fa-github"></i></a></li>
        <li><a title="YouTube" href="https://www.youtube.com/user/netbeansvideos"><i class="fa fa-md fa-youtube"></i></a></li>
        <li><a title="Atom Feed" href="https://netbeans.apache.org/blogs/atom"><i class="fa fa-mf fa-rss"></i></a></li>
        <li><a title="Slack" href="https://tinyurl.com/netbeans-slack-signup/"><i class="fa fa-md fa-slack"></i></a></li>
        <li><a title="Issues" href="https://github.com/apache/netbeans/issues"><i class="fa fa-mf fa-bug"></i></a></li>
    </ul>
    <ul class="menu align-center">
        <li><a href="https://github.com/apache/netbeans-antora-tutorials/edit/main/modules/ROOT/pages/kb/docs/php/wish-list-lesson4.adoc" title="See this page in github"><i class="fa fa-md fa-edit"></i> See this page in GitHub.</a></li>
    </ul>
</section>
      </article>
    </div>
        <div class='grid-container incubator-area' style='margin-top: 64px'>
      <div class='grid-x grid-padding-x'>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/">
            <img style="width: 320px" title="Apache Software Foundation" src="../../../../../../_/images/asf_logo_wide.svg" />
          </a>
        </div>
        <div class='large-auto cell text-center'>
          <a href="https://www.apache.org/events/current-event.html">
            <img style="width:234px; height: 60px;" title="Apache Software Foundation current event" src="https://www.apache.org/events/current-event-234x60.png"/>
          </a>
        </div>
      </div>
    </div>
    <footer>
      <div class="grid-container">
        <div class="grid-x grid-padding-x">
          <div class="large-auto cell">
            <h1><a href="../../../../../../front/main/about">About</a></h1>
            <ul>
              <li><a href="../../../../../../front/main/community/who">Who's Who</a></li>
              <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
              <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
              <li><a href="https://www.apache.org/security/">Security</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../../../front/main/community">Community</a></h1>
            <ul>
              <li><a href="../../../../../../front/main/community/mailing-lists">Mailing lists</a></li>
              <li><a href="../../../../../../front/main/community/committer">Becoming a committer</a></li>
              <li><a href="../../../../../../front/main/community/events">NetBeans Events</a></li>
              <li><a href="https://www.apache.org/events/current-event.html">Apache Events</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../../../front/main/participate">Participate</a></h1>
            <ul>
              <li><a href="../../../../../../front/main/participate/submit-pr">Submitting Pull Requests</a></li>
              <li><a href="../../../../../../front/main/participate/report-issue">Reporting Issues</a></li>
              <li><a href="../../../../../../front/main/participate/#documentation">Improving the documentation</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../../../front/main/help">Get Help</a></h1>
            <ul>
              <li><a href="../../../../../../front/main/help/#documentation">Documentation</a></li>
              <li><a href="../../../../../../wiki/main/wiki">Wiki</a></li>
              <li><a href="../../../../../../front/main/help/#support">Community Support</a></li>
              <li><a href="../../../../../../front/main/help/commercial-support">Commercial Support</a></li>
            </ul>
          </div>
          <div class="large-auto cell">
            <h1><a href="../../../../../../front/main/download">Download</a></h1>
            <ul>
              <li><a href="../../../../../../front/main/download">Releases</a></li>                    
              <li><a href="https://plugins.netbeans.apache.org/">Plugins</a></li>
              <li><a href="../../../../../../front/main/download/#_daily_builds_and_building_from_source">Building from source</a></li>
              <li><a href="../../../../../../front/main/download/#_older_releases">Previous releases</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
    <div class='footer-disclaimer'>
      <div class="footer-disclaimer-content">
        <p>Copyright &copy; 2017-2023 <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
        <p>Licensed under the Apache <a href="https://www.apache.org/licenses/">license</a>, version 2.0</p>
        <div style='max-width: 40em; margin: 0 auto'>
          <p>Apache, Apache NetBeans, NetBeans, the Apache feather logo and the Apache NetBeans logo are trademarks of <a href="https://www.apache.org">The Apache Software Foundation</a>.</p>
          <p>Oracle and Java are registered trademarks of Oracle and/or its affiliates.</p>
          <p>The Apache NetBeans website conforms to the <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Apache Software Foundation Privacy Policy</a></p>
        </div>
      </div>
    </div>

    
<script src="../../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../../.." data-snippet-length="100" data-stylesheet="../../../../../../_/css/search.css"></script>
<script async src="../../../../../../search-index.js"></script>
    <script src="../../../../../../_/js/vendor/jquery-3.7.1.min.js"></script>
    <script src="../../../../../../_/js/vendor/what-input.js"></script>
    <script src="../../../../../../_/js/vendor/foundation.min.js"></script>
    <script src="../../../../../../_/js/vendor/jquery.colorbox-min.js"></script>
    <script src="../../../../../../_/js/netbeans.js"></script>
    <script>
       $(function(){ $(document).foundation(); });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
    <script>
      $(document).ready(function() { $("pre code").each(function(i, block) { hljs.highlightBlock(block); }); });
    </script>
  </body>
</html>
